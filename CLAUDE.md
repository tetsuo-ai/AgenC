# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## CRITICAL: No Attribution

**NEVER add any attribution, signatures, or co-author tags to ANY git operations.** This includes:

- NO `Co-Authored-By` lines in commit messages
- NO Claude references in PR descriptions
- NO Claude signatures on issues or comments
- NO attribution footers of any kind
- NO "Generated by" or "Created by" tags

Commit messages should contain ONLY the commit message itself - nothing else.

## Project Overview

AgenC is a privacy-preserving AI agent coordination protocol built on Solana. It enables decentralized task coordination with zero-knowledge proofs for private task completions, on-chain skill registry, agent feed/forum, and a reputation economy.

**Packages:**
- **Anchor Program** (`programs/agenc-coordination/`) - Solana smart contract: 42 instructions, 176 error codes, 57 event types, 23 account structures. Covers task coordination, disputes, rewards, SPL token escrow, governance, skill registry, agent feed, and reputation economy.
- **TypeScript SDK** (`sdk/`) - Privacy-preserving task coordination client (`@agenc/sdk` v1.3.0)
- **Agent Runtime** (`runtime/`) - Agent lifecycle management, autonomous agents, gateway, LLM adapters, tools, memory, proofs, workflows, marketplace, teams, governance, policy, telemetry, voice, social, bridges, reputation (`@agenc/runtime` v0.1.0)
- **MCP Server** (`mcp/`) - Model Context Protocol server exposing protocol operations as MCP tools (`@agenc/mcp` v0.1.0)
- **Docs MCP Server** (`docs-mcp/`) - MCP server providing AI-assisted architecture doc lookups per roadmap issue
- **Demo App** (`demo-app/`) - React web interface for privacy workflow demonstration
- **Web App** (`web/`) - Web UI application (Vite + React + Tailwind)
- **Mobile App** (`mobile/`) - Expo React Native mobile application
- **ZK VM** (`zkvm/`) - RISC Zero guest (journal schema) + host (prover, seal encoding) crates for private task completion proofs (Groth16 via Verifier Router CPI)
- **Desktop Sandbox** (`containers/`) - Docker-based headless desktop (Ubuntu/XFCE/VNC) with REST API for autonomous desktop automation
- **Test Infrastructure** (`tests/`) - LiteSVM-based integration tests, CU benchmarks, and Rust fuzz testing

## Quick Start

```bash
# 1. Install dependencies
npm install

# 2. Build all packages (sdk + runtime + mcp + docs-mcp)
npm run build

# 3. Run fast integration tests (~5 seconds via LiteSVM)
npm run test:fast

# 4. Run unit tests (SDK + Runtime vitest suites)
npm run test

# 5. Build the Anchor program
anchor build
```

**Prerequisites:** Rust, Solana CLI (`v3.0.13`), Anchor CLI (`v0.32.1`), Node.js (`>=18`)

## Build Commands

### Root Package (Orchestrator)

```bash
npm run build              # Build sdk + runtime + mcp + docs-mcp
npm run test               # Build + run SDK + runtime vitest suites
npm run typecheck           # Typecheck sdk + runtime + mcp
npm run test:fast           # LiteSVM integration tests (~5s, includes agent-feed)
npm run test:anchor         # Full ts-mocha integration tests (all files)
npm run test:fixtures       # Eval/replay integration tests
npm run demo               # Run private task demo
```

### Solana Anchor Program (Rust)

```bash
anchor build               # Build the Solana program
anchor test                # Run tests with local validator
cargo test --manifest-path programs/agenc-coordination/Cargo.toml  # Rust unit tests
```

### TypeScript SDK

```bash
cd sdk
npm run build              # Build SDK (outputs to dist/)
npm run typecheck           # Type checking only
npm run test               # Run vitest unit tests
```

### Agent Runtime

```bash
cd runtime
npm run build              # Build (outputs to dist/)
npm run typecheck           # Type checking only
npm run test               # Run vitest (~4860+ tests)
npm run benchmark           # Run deterministic benchmark corpus
npm run benchmark:ci        # Benchmark with artifact output
npm run mutation            # Run mutation test suite
npm run mutation:ci         # Mutation with artifact + trend output
npm run mutation:gates      # Check mutation regression gates
```

### MCP Server

```bash
cd mcp
npm run build              # Build (outputs to dist/)
npm run typecheck           # Type checking only
npm run test               # Run tests (node --test)
```

### Demo App

```bash
cd demo-app
npm run dev                # Development server
npm run build              # Production build (outputs to dist/)
```

### Web App

```bash
cd web
npm run dev                # Vite dev server (http://localhost:5173)
npm run build              # Production build
```

Connects to the Gateway daemon WebSocket (default `ws://127.0.0.1:3100`). Features: chat, dashboard, tasks, skills, memory, activity feed, voice, settings, approvals.

### Desktop Sandbox

```bash
docker build -t agenc/desktop:latest containers/desktop/
docker run -d -p 6080:6080 -p 9990:9990 agenc/desktop:latest
```

Add `"desktop": { "enabled": true, "image": "agenc/desktop:latest" }` to `~/.agenc/config.json`. The daemon auto-creates per-session containers. noVNC at port 6080, REST API at port 9990.

### ZK VM (RISC Zero)

```bash
# Run zkVM host tests (includes guest verification)
cargo test --manifest-path zkvm/host/Cargo.toml
```

### Fuzz Tests

```bash
cd programs/agenc-coordination
cargo fuzz run claim_task           # Fuzz claim_task instruction
cargo fuzz run complete_task        # Fuzz complete_task instruction
cargo fuzz run vote_dispute         # Fuzz vote_dispute instruction
cargo fuzz run resolve_dispute      # Fuzz resolve_dispute instruction
cargo fuzz run dependency_graph     # Fuzz dependency graph
cargo fuzz run dispute_lifecycle    # Fuzz dispute lifecycle
cargo fuzz run dispute_timing       # Fuzz dispute timing
cargo fuzz run task_lifecycle       # Fuzz task lifecycle
```

## Architecture

```
AgenC/
├── .github/workflows/ci.yml        # CI pipeline (runtime_checks, reliability_regression, nightly)
├── programs/agenc-coordination/     # Solana Anchor program (Rust)
│   ├── src/
│   │   ├── lib.rs                   # Program entrypoint (42 instructions)
│   │   ├── state.rs                 # Account structures (23 structs) + enums
│   │   ├── errors.rs                # Error definitions (176 codes; 6000-6175)
│   │   ├── events.rs                # Event emissions (57 event types)
│   │   ├── instructions/            # Instruction handlers
│   │   │   ├── mod.rs               # Module exports (41 instruction modules + 9 helper modules)
│   │   │   ├── register_agent.rs
│   │   │   ├── update_agent.rs
│   │   │   ├── suspend_agent.rs     # Protocol authority agent suspension
│   │   │   ├── unsuspend_agent.rs   # Protocol authority agent unsuspension
│   │   │   ├── deregister_agent.rs
│   │   │   ├── create_task.rs
│   │   │   ├── create_dependent_task.rs
│   │   │   ├── claim_task.rs
│   │   │   ├── expire_claim.rs
│   │   │   ├── complete_task.rs
│   │   │   ├── complete_task_private.rs  # ZK verification + trusted RISC Zero constants
│   │   │   ├── cancel_task.rs
│   │   │   ├── update_state.rs
│   │   │   ├── initiate_dispute.rs
│   │   │   ├── vote_dispute.rs
│   │   │   ├── resolve_dispute.rs
│   │   │   ├── apply_dispute_slash.rs
│   │   │   ├── apply_initiator_slash.rs  # Symmetric initiator slashing
│   │   │   ├── cancel_dispute.rs
│   │   │   ├── expire_dispute.rs
│   │   │   ├── initialize_protocol.rs
│   │   │   ├── update_protocol_fee.rs
│   │   │   ├── update_treasury.rs        # Rotate treasury destination (multisig)
│   │   │   ├── update_multisig.rs        # Rotate multisig owners/threshold (multisig)
│   │   │   ├── update_rate_limits.rs
│   │   │   ├── migrate.rs                # migrate_protocol + update_min_version
│   │   │   ├── initialize_governance.rs
│   │   │   ├── create_proposal.rs
│   │   │   ├── vote_proposal.rs
│   │   │   ├── execute_proposal.rs
│   │   │   ├── cancel_proposal.rs
│   │   │   ├── register_skill.rs         # Register skill on-chain
│   │   │   ├── update_skill.rs           # Update skill content/price/tags
│   │   │   ├── rate_skill.rs             # Rate skill (1-5, reputation-weighted)
│   │   │   ├── purchase_skill.rs         # Purchase skill (SOL or SPL token)
│   │   │   ├── post_to_feed.rs           # Post to agent feed
│   │   │   ├── upvote_post.rs            # Upvote a feed post
│   │   │   ├── stake_reputation.rs       # Stake SOL on agent reputation
│   │   │   ├── withdraw_reputation_stake.rs  # Withdraw staked SOL after cooldown
│   │   │   ├── delegate_reputation.rs    # Delegate reputation points to peer
│   │   │   ├── revoke_delegation.rs      # Revoke reputation delegation
│   │   │   ├── completion_helpers.rs     # Shared completion + tiered fee logic
│   │   │   ├── task_init_helpers.rs      # Shared task creation helpers
│   │   │   ├── dispute_helpers.rs        # Dispute resolution helpers
│   │   │   ├── slash_helpers.rs          # Slashing logic
│   │   │   ├── rate_limit_helpers.rs     # Rate limit enforcement
│   │   │   ├── lamport_transfer.rs       # Checked lamport transfers
│   │   │   ├── token_helpers.rs          # SPL token CPI helpers
│   │   │   ├── constants.rs             # Instruction constants
│   │   │   └── validation.rs            # Account validation helpers
│   │   └── utils/                   # Multisig, version, compute budget, validation
│   └── fuzz/                        # 8 fuzz testing targets
├── sdk/                             # TypeScript SDK (@agenc/sdk v1.3.0)
│   ├── src/
│   │   ├── index.ts                 # Main exports
│   │   ├── client.ts                # PrivacyClient class
│   │   ├── proofs.ts                # ZK proof generation/verification
│   │   ├── tasks.ts                 # Task operations (create, claim, complete, cancel)
│   │   ├── agents.ts                # Agent operations (register, update, suspend, deregister)
│   │   ├── disputes.ts              # Dispute operations (initiate, vote, resolve, slash)
│   │   ├── state.ts                 # Coordination state operations
│   │   ├── protocol.ts              # Protocol operations (initialize, update fees/rates)
│   │   ├── governance.ts            # Governance operations (proposals, voting)
│   │   ├── skills.ts                # Skill PDA helpers and types
│   │   ├── tokens.ts                # SPL token helpers
│   │   ├── bids.ts                  # Marketplace bidding types
│   │   ├── queries.ts               # Task dependency + dispute queries
│   │   ├── constants.ts             # Program IDs, RPC endpoints, CU budgets, RISC Zero constants
│   │   ├── errors.ts                # Error decoding (COORDINATION_ERROR_MAP)
│   │   ├── validation.ts            # Prover endpoint + RISC Zero payload validation
│   │   ├── proof-validation.ts      # Proof submission preflight checks
│   │   ├── nullifier-cache.ts       # Session-scoped nullifier LRU cache
│   │   ├── version.ts               # SDK/protocol version compatibility
│   │   ├── anchor-utils.ts          # Anchor utility functions
│   │   ├── logger.ts                # SDK logger
│   │   ├── utils/numeric.ts         # Numeric conversion utilities
│   │   └── types/privacycash.d.ts   # Type stubs for privacycash
│   └── dist/                        # Build output (ESM + CJS)
├── runtime/                         # Agent Runtime (@agenc/runtime v0.1.0, ~90k lines)
│   ├── src/
│   │   ├── index.ts                 # Barrel exports (~1800 lines)
│   │   ├── idl.ts                   # IDL + Program factory functions
│   │   ├── runtime.ts               # AgentRuntime class (lifecycle wrapper)
│   │   ├── builder.ts               # AgentBuilder (fluent composition API)
│   │   ├── bin/                     # CLI entry points (agenc-runtime, daemon)
│   │   ├── cli/                     # CLI commands (health, onboard, replay, jobs, logs, sessions, security, skills, wizard, daemon, registry-cli)
│   │   ├── agent/                   # Agent management (manager, events, PDA, capabilities)
│   │   ├── autonomous/             # Autonomous agents (scanner, verifier, risk scoring, arbitration, escalation, speculation)
│   │   ├── task/                    # Task pipeline (operations, discovery, speculative execution, proofs, DLQ, rollback, priority queue, checkpoints)
│   │   ├── gateway/                 # Persistent agent gateway (lifecycle, channels, config watcher, WebSocket control, sessions, workspace, scheduler, heartbeat, hooks, identity, personality, media, approvals, slash commands, JWT, routing, sandbox, sub-agents, remote, voice-bridge)
│   │   ├── channels/               # Channel plugins: telegram/, discord/, webchat/, slack/, whatsapp/, signal/, matrix/, imessage/ (8 plugins)
│   │   ├── governance/             # On-chain governance operations (5 instructions, PDA helpers)
│   │   ├── tools/                   # Tool registry + built-in AgenC tools + system tools (HTTP, filesystem, browser, bash, macOS)
│   │   ├── llm/                     # LLM adapters (Grok, Anthropic, Ollama) + ChatExecutor + FallbackProvider
│   │   ├── memory/                  # Memory backends (InMemory, SQLite, Redis) + structured memory, embeddings, graph, encryption, vector store, ingestion, retriever (semantic pipeline wired into daemon)
│   │   ├── proof/                   # ZK Proof Engine (caching, stats)
│   │   ├── dispute/                 # Dispute operations (6 instructions)
│   │   ├── workflow/                # DAG orchestrator, goal compiler, optimizer, canary rollout, feature extractor
│   │   ├── connection/             # Resilient RPC (retry, failover, coalescing)
│   │   ├── replay/                  # On-chain event timeline store (file, in-memory, SQLite), backfill, alerting, bridge, trace
│   │   ├── eval/                    # Evaluation (benchmarks, mutation testing, trajectory replay, chaos matrix, evidence packs, calibration)
│   │   ├── marketplace/            # Task bid marketplace (matching, scoring, strategies) + ServiceMarketplace
│   │   ├── team/                    # Team contracts (engine, payouts, audit, validation)
│   │   ├── policy/                  # Policy engine (budgets, circuit breakers, RBAC, audit trail, incident roles, production profiles, tool policies)
│   │   ├── skills/                  # Skills registry + Jupiter DEX + markdown loader + bundled skills + on-chain registry client + catalog + monetization (analytics, revenue sharing)
│   │   ├── telemetry/              # Unified metrics collection + sinks + metric names
│   │   ├── events/                  # Event subscriptions + parsing (57 event types) + IDL drift checks
│   │   ├── voice/                   # Voice: STT (Whisper), TTS (ElevenLabs, OpenAI, Edge), Realtime (xAI)
│   │   ├── social/                  # Agent discovery, messaging, feed, reputation scoring, collaboration protocol
│   │   ├── bridges/                 # External integrations: LangChain, X402 payments, Farcaster
│   │   ├── reputation/             # On-chain reputation economy (staking, delegation, portability)
│   │   ├── desktop/                # Desktop sandbox manager (pool, health, REST bridge, session router)
│   │   ├── mcp-client/             # MCP client (external server connections, tool bridging via stdio)
│   │   ├── types/                   # Protocol types, errors (101 runtime codes, 198 anchor codes), wallet, config migration
│   │   └── utils/                   # Encoding, logger, PDA, query, treasury, lazy-import, token, async, validation, process, type-guards
│   ├── scripts/                     # Benchmark + mutation CLI scripts
│   ├── benchmarks/                  # Benchmark manifests + CI artifacts
│   └── dist/                        # Build output (ESM + CJS)
├── mcp/                             # MCP Server (@agenc/mcp v0.1.0)
│   ├── src/
│   │   ├── index.ts                 # Entry point (stdio transport)
│   │   ├── server.ts                # MCP server, resources, prompts
│   │   ├── tools/                   # connection, agents, tasks, protocol, disputes, testing, inspector, replay, human-facing, errors
│   │   ├── prompts/                 # MCP prompts (debug-task, inspect-agent, escrow-audit, dispute-drift, payout-mismatch, replay-anomaly)
│   │   └── utils/                   # connection, formatting, json, schema-hash, truncation
│   └── dist/                        # Build output
├── docs-mcp/                        # Docs MCP Server (architecture doc lookups)
├── containers/                      # Desktop sandbox (Docker)
│   ├── docker-compose.yml           # Orchestrator (ports 6080, 9990)
│   └── desktop/                     # Headless Ubuntu/XFCE + VNC + REST API
│       ├── Dockerfile               # Ubuntu 22.04, XFCE4, VNC, noVNC, Node.js 20
│       ├── supervisord.conf         # 5 managed processes (Xvfb, XFCE, VNC, websockify, REST)
│       ├── seccomp.json             # Syscall security profile (x86_64 + aarch64)
│       ├── xfce-config/             # Disable screensaver, power mgmt, login prompts
│       └── server/src/              # REST API + 13 desktop automation tools
├── demo-app/                        # React + Vite web interface
├── zkvm/                           # RISC Zero guest (journal schema) + host (prover)
│   ├── guest/src/lib.rs             # Journal schema: JournalFields struct, serialize/deserialize
│   └── host/src/                    # Proof generation, config, CLI
├── examples/                        # autonomous-agent, dispute-arbiter, event-dashboard, helius-webhook, llm-agent, memory-agent, risc0-proof-demo, simple-usage, skill-jupiter, tetsuo-integration
├── tests/                           # LiteSVM-based integration tests
│   ├── test_1.ts                    # Main integration suite (140 tests)
│   ├── dispute-slash-logic.ts       # Dispute slashing tests
│   ├── spl-token-tasks.ts           # SPL token escrow tests
│   ├── governance.ts                # Governance integration tests
│   ├── lifecycle-guards.ts          # Lifecycle guard tests
│   ├── agent-feed.ts                # Agent feed tests (included in test:fast)
│   ├── reputation-economy.ts        # Reputation economy tests (included in anchor test)
│   ├── complete_task_private.ts     # Private task completion tests
│   ├── zk-proof-lifecycle.ts        # ZK proof lifecycle tests
│   ├── coordination-security.ts     # Security tests
│   ├── audit-high-severity.ts       # High severity audit tests
│   ├── security-audit-fixes.ts      # Security audit fix tests
│   ├── rate-limiting.ts             # Rate limiting tests
│   ├── sybil-attack.ts              # Sybil attack resistance tests
│   ├── upgrades.ts                  # Protocol upgrade tests
│   ├── test_cu_benchmarks.ts        # Compute unit benchmarks
│   ├── integration.ts               # Additional integration tests
│   ├── e2e-real-proof.ts            # End-to-end real RISC Zero proof tests
│   ├── smoke.ts                     # Smoke tests
│   ├── minimal.ts                   # Minimal test file
│   ├── minimal-debug.ts             # Minimal debug test file
│   ├── litesvm-helpers.ts           # LiteSVM test adapter
│   ├── litesvm-poc.ts               # 13 PoC tests validating LiteSVM API
│   ├── test-setup.ts                # Shared lifecycle hooks (DRY)
│   └── test-utils.ts                # Canonical test constants + PDA helpers
├── demo/                            # Demo scripts (e2e_devnet_test, private_task_demo)
├── web/                             # Web UI application (Vite + React + Tailwind)
├── mobile/                          # Mobile app (Expo/React Native)
├── security/                        # Security audit documentation
├── scripts/                         # Build/deployment/sync scripts
├── docs/                            # Documentation
├── audit/                           # Bug bounty & reviews
├── migrations/                      # Protocol migration tools
└── Anchor.toml                      # Anchor config (v0.32.1, Solana v3.0.13)
```

## Anchor Program Instructions (42 total)

### Core Agent Instructions

| Instruction | Purpose |
|-------------|---------|
| `register_agent` | Register agent with capabilities + stake |
| `update_agent` | Update agent capabilities, endpoint, status |
| `suspend_agent` | Protocol authority suspends an agent |
| `unsuspend_agent` | Protocol authority unsuspends an agent |
| `deregister_agent` | Unregister agent from protocol |

### Task Instructions

| Instruction | Purpose |
|-------------|---------|
| `create_task` | Post task with SOL or SPL token escrow reward |
| `create_dependent_task` | Create task with dependency on parent task |
| `claim_task` | Worker claims a task |
| `expire_claim` | Handle claim timeout |
| `complete_task` | Submit proof, receive payment |
| `complete_task_private` | Submit ZK proof for private completion |
| `cancel_task` | Creator cancels, gets refund |

### State & Dispute Instructions

| Instruction | Purpose |
|-------------|---------|
| `update_state` | Sync shared state with version |
| `initiate_dispute` | Start dispute resolution |
| `vote_dispute` | Arbiters vote on dispute |
| `resolve_dispute` | Execute dispute resolution |
| `apply_dispute_slash` | Slash worker stake for losing dispute |
| `apply_initiator_slash` | Slash initiator stake for frivolous dispute |
| `cancel_dispute` | Initiator cancels before votes |
| `expire_dispute` | Handle dispute timeout |

### Protocol Admin Instructions (multisig-gated)

| Instruction | Purpose |
|-------------|---------|
| `initialize_protocol` | Set up protocol config, treasury, fees |
| `update_protocol_fee` | Adjust protocol fees |
| `update_treasury` | Rotate treasury destination |
| `update_multisig` | Rotate multisig owners/threshold |
| `update_rate_limits` | Configure rate limits |
| `migrate_protocol` | Version migration handler |
| `update_min_version` | Update minimum supported protocol version |

### Governance Instructions

| Instruction | Purpose |
|-------------|---------|
| `initialize_governance` | Set up on-chain governance config |
| `create_proposal` | Create a governance proposal |
| `vote_proposal` | Vote on a governance proposal |
| `execute_proposal` | Execute a passed proposal |
| `cancel_proposal` | Cancel a governance proposal |

### Skill Registry Instructions

| Instruction | Purpose |
|-------------|---------|
| `register_skill` | Register new skill on-chain |
| `update_skill` | Update skill content/price/tags/status |
| `rate_skill` | Rate a skill (1-5, reputation-weighted) |
| `purchase_skill` | Purchase a skill (SOL or SPL token) |

### Agent Feed Instructions

| Instruction | Purpose |
|-------------|---------|
| `post_to_feed` | Post to agent feed |
| `upvote_post` | Upvote a feed post |

### Reputation Economy Instructions

| Instruction | Purpose |
|-------------|---------|
| `stake_reputation` | Stake SOL on agent reputation |
| `withdraw_reputation_stake` | Withdraw staked SOL after cooldown |
| `delegate_reputation` | Delegate reputation points to peer |
| `revoke_delegation` | Revoke reputation delegation |

### Helper Modules (not instructions)

| Module | Purpose |
|--------|---------  |
| `completion_helpers` | Shared completion logic + tiered fee calculation |
| `task_init_helpers` | Shared `init_task_fields()` for create_task + create_dependent_task |
| `dispute_helpers` | Dispute resolution helpers |
| `slash_helpers` | Slashing logic for disputes |
| `rate_limit_helpers` | Rate limit enforcement helpers |
| `lamport_transfer` | Checked arithmetic lamport transfers |
| `token_helpers` | SPL token CPI helpers (transfer, close) |
| `constants` | Instruction-specific constants |
| `validation` | Account validation helpers |

## Program Events (57 total)

### Agent Events (5)

| Event | Fields | Purpose |
|-------|--------|---------|
| `AgentRegistered` | agent_id, authority, capabilities, endpoint, stake_amount, timestamp | New agent joins |
| `AgentUpdated` | agent_id, capabilities, status, timestamp | Agent config changed |
| `AgentSuspended` | agent_id, authority, timestamp | Agent suspended by authority |
| `AgentUnsuspended` | agent_id, authority, timestamp | Agent unsuspended by authority |
| `AgentDeregistered` | agent_id, authority, timestamp | Agent leaves protocol |

### Task Events (5)

| Event | Fields | Purpose |
|-------|--------|---------|
| `TaskCreated` | task_id, creator, required_capabilities, reward_amount, task_type, deadline, min_reputation, reward_mint, timestamp | New task posted |
| `DependentTaskCreated` | task_id, creator, depends_on, dependency_type, reward_mint, timestamp | Dependent task created |
| `TaskClaimed` | task_id, worker, current_workers, max_workers, timestamp | Worker claims task |
| `TaskCompleted` | task_id, worker, proof_hash, result_data, reward_paid, timestamp | Task finished |
| `TaskCancelled` | task_id, creator, refund_amount, timestamp | Task cancelled |

### State Event (1)

| Event | Fields | Purpose |
|-------|--------|---------|
| `StateUpdated` | state_key, state_value, updater, version, timestamp | Shared state changed |

### Dispute Events (6)

| Event | Fields | Purpose |
|-------|--------|---------|
| `DisputeInitiated` | dispute_id, task_id, initiator, defendant, resolution_type, voting_deadline, timestamp | Dispute started |
| `DisputeVoteCast` | dispute_id, voter, approved, votes_for, votes_against, timestamp | Arbiter voted |
| `DisputeCancelled` | dispute_id, task, initiator, cancelled_at | Dispute cancelled |
| `DisputeResolved` | dispute_id, resolution_type, outcome, votes_for, votes_against, timestamp | Dispute concluded |
| `DisputeExpired` | dispute_id, task_id, refund_amount, creator_amount, worker_amount, timestamp | Dispute timed out |
| `ArbiterVotesCleanedUp` | dispute_id, arbiter_count | Vote cleanup |

### Protocol Events (8)

| Event | Fields | Purpose |
|-------|--------|---------|
| `ProtocolInitialized` | authority, treasury, dispute_threshold, protocol_fee_bps, timestamp | Protocol setup |
| `TreasuryUpdated` | old_treasury, new_treasury, updated_by, timestamp | Treasury rotated |
| `MultisigUpdated` | old_threshold, new_threshold, old_owner_count, new_owner_count, updated_by, timestamp | Multisig rotated |
| `RewardDistributed` | task_id, recipient, amount, protocol_fee, timestamp | Payment sent |
| `RateLimitHit` | agent_id, action_type, limit_type, current_count, max_count, cooldown_remaining, timestamp | Rate limit triggered |
| `MigrationCompleted` | from_version, to_version, authority, timestamp | Version migration done |
| `ProtocolVersionUpdated` | old_version, new_version, min_supported_version, timestamp | Protocol upgraded |
| `ProtocolFeeUpdated` | old_fee_bps, new_fee_bps, updated_by, timestamp | Fee changed |

### Rate Limit Event (1)

| Event | Fields | Purpose |
|-------|--------|---------|
| `RateLimitsUpdated` | task_creation_cooldown, max_tasks_per_24h, dispute_initiation_cooldown, max_disputes_per_24h, min_stake_for_dispute, updated_by, timestamp | Rate limits changed |

### Speculation Bond Events (5)

| Event | Fields | Purpose |
|-------|--------|---------|
| `BondDeposited` | agent, amount, new_total, timestamp | Bond deposited |
| `BondLocked` | agent, commitment, amount, timestamp | Bond locked |
| `SpeculativeCommitmentCreated` | task, producer, result_hash, bonded_stake, expires_at, timestamp | Speculative commitment |
| `BondSlashed` | agent, commitment, amount, reason, timestamp | Bond slashed |
| `BondReleased` | agent, commitment, amount, timestamp | Bond released |

### Reputation Event (1)

| Event | Fields | Purpose |
|-------|--------|---------|
| `ReputationChanged` | agent_id, old_reputation, new_reputation, reason, timestamp | Reputation updated |

### Governance Events (5)

| Event | Fields | Purpose |
|-------|--------|---------|
| `GovernanceInitialized` | authority, voting_period, execution_delay, quorum_bps, approval_threshold_bps, timestamp | Governance setup |
| `ProposalCreated` | proposer, proposal_type, title_hash, voting_deadline, quorum, timestamp | Proposal created |
| `GovernanceVoteCast` | proposal, voter, approved, vote_weight, votes_for, votes_against, timestamp | Governance vote |
| `ProposalExecuted` | proposal, proposal_type, votes_for, votes_against, total_voters, timestamp | Proposal executed |
| `ProposalCancelled` | proposal, proposer, timestamp | Proposal cancelled |

### Skill Registry Events (4)

| Event | Fields | Purpose |
|-------|--------|---------|
| `SkillRegistered` | skill, author, skill_id, name, content_hash, price, price_mint, timestamp | Skill registered |
| `SkillUpdated` | skill, author, content_hash, price, version, timestamp | Skill updated |
| `SkillRated` | skill, rater, rating, rater_reputation, new_total_rating, new_rating_count, timestamp | Skill rated |
| `SkillPurchased` | skill, buyer, author, price_paid, protocol_fee, timestamp | Skill purchased |

### Feed Events (2)

| Event | Fields | Purpose |
|-------|--------|---------|
| `PostCreated` | post, author, content_hash, topic, parent_post, timestamp | Post created |
| `PostUpvoted` | post, voter, new_upvote_count, timestamp | Post upvoted |

### Reputation Economy Events (4)

| Event | Fields | Purpose |
|-------|--------|---------|
| `ReputationStaked` | agent, amount, total_staked, locked_until, timestamp | Reputation staked |
| `ReputationStakeWithdrawn` | agent, amount, remaining_staked, timestamp | Stake withdrawn |
| `ReputationDelegated` | delegator, delegatee, amount, expires_at, timestamp | Reputation delegated |
| `ReputationDelegationRevoked` | delegator, delegatee, amount, timestamp | Delegation revoked |

**Event constants:**
- Dispute outcome: `REJECTED=0`, `APPROVED=1`, `NO_VOTE_DEFAULT=2`
- Reputation reason: `COMPLETION=0`, `DISPUTE_SLASH=1`, `DECAY=2`
- **Event name format in TypeScript:** Use camelCase (e.g., `taskCompleted`, not `TaskCompleted`)

## TypeScript SDK

### Package Configuration

- **Version:** `1.3.0`
- **Build Tool:** `tsup` (outputs ESM + CJS dual build)
- **Test Framework:** `vitest`
- **Node:** `>=18.0.0`
- **Peer Dependencies:** `@coral-xyz/anchor >=0.29.0`, `@solana/web3.js >=1.90.0`, `@solana/spl-token >=0.4.0`

### SDK Modules

The SDK provides complete instruction wrappers for all protocol operations:

```typescript
// Agent operations
import { registerAgent, updateAgent, suspendAgent, unsuspendAgent, deregisterAgent, getAgent, deriveAgentPda, AgentStatus } from '@agenc/sdk';

// Task operations
import { createTask, createDependentTask, claimTask, expireClaim, completeTask, completeTaskPrivate, completeTaskPrivateWithPreflight, cancelTask, getTask, getTasksByCreator, getTaskLifecycleSummary, deriveTaskPda, deriveClaimPda, deriveEscrowPda, TaskState, TaskStatus } from '@agenc/sdk';

// ZK proof operations
import { generateProof, verifyProofLocally, computeHashes, generateSalt, computeConstraintHash, computeBinding, FIELD_MODULUS } from '@agenc/sdk';

// Dispute operations
import { initiateDispute, voteDispute, resolveDispute, applyDisputeSlash, applyInitiatorSlash, cancelDispute, expireDispute, getDispute, deriveDisputePda, deriveVotePda, DisputeStatus, ResolutionType } from '@agenc/sdk';

// State operations
import { updateState, getState, deriveStatePda } from '@agenc/sdk';

// Protocol operations
import { initializeProtocol, updateProtocolFee, updateRateLimits, migrateProtocol, updateMinVersion, getProtocolConfig, deriveProtocolPda } from '@agenc/sdk';

// Governance operations
import { initializeGovernance, createProposal, voteProposal, executeProposal, cancelProposal, getProposal, deriveGovernanceConfigPda, deriveProposalPda, deriveGovernanceVotePda, ProposalType, ProposalStatus } from '@agenc/sdk';

// Skill PDA helpers
import { deriveSkillPda, deriveSkillRatingPda, deriveSkillPurchasePda } from '@agenc/sdk';

// SPL token helpers
import { deriveTokenEscrowAddress, isTokenTask, getEscrowTokenBalance, formatTokenAmount, getMintDecimals, TOKEN_PROGRAM_ID, ASSOCIATED_TOKEN_PROGRAM_ID } from '@agenc/sdk';

// Marketplace/bidding types
import { BidStatus, MatchingPolicy, WeightedScoreWeights, BPS_BASE, BID_ID_MAX_LENGTH, MARKETPLACE_ID_PATTERN } from '@agenc/sdk';

// Error decoding
import { decodeError, decodeAnchorError, COORDINATION_ERROR_MAP } from '@agenc/sdk';

// Proof submission preflight
import { runProofSubmissionPreflight, DEFAULT_MAX_PROOF_AGE_MS, NullifierCache } from '@agenc/sdk';

// Version compatibility
import { checkVersionCompatibility, requireVersionCompatibility, getFeaturesForVersion, SDK_PROTOCOL_VERSION } from '@agenc/sdk';

// Query helpers
import { getTasksByDependency, getDependentTaskCount, getRootTasks, hasDependents, getDisputesByActor, getReplayHealthCheck, TASK_FIELD_OFFSETS, DISPUTE_FIELD_OFFSETS } from '@agenc/sdk';

// Prover backends (local-binary + remote)
import { LocalBinaryProverConfig, RemoteProverConfig, ProverConfig, ProverError } from '@agenc/sdk';

// Logging
import { createLogger, silentLogger, setSdkLogLevel, getSdkLogger } from '@agenc/sdk';
```

### Constants

```typescript
import { PROGRAM_ID, PRIVACY_CASH_PROGRAM_ID, DEVNET_RPC, MAINNET_RPC } from '@agenc/sdk';

// RISC Zero constants
RISC0_SEAL_BORSH_LEN = 260       // 4-byte selector + 256-byte Groth16 proof
RISC0_JOURNAL_LEN = 192           // 6 × 32-byte fields
RISC0_IMAGE_ID_LEN = 32
TRUSTED_RISC0_SELECTOR            // [0x52, 0x5a, 0x56, 0x4d] "RZVM"
TRUSTED_RISC0_IMAGE_ID            // 32-byte image ID

// SOL-path CU budgets
RECOMMENDED_CU_REGISTER_AGENT = 40_000
RECOMMENDED_CU_UPDATE_AGENT = 20_000
RECOMMENDED_CU_CREATE_TASK = 50_000
RECOMMENDED_CU_CREATE_DEPENDENT_TASK = 60_000
RECOMMENDED_CU_CLAIM_TASK = 30_000
RECOMMENDED_CU_COMPLETE_TASK = 60_000
RECOMMENDED_CU_COMPLETE_TASK_PRIVATE = 200_000
RECOMMENDED_CU_CANCEL_TASK = 40_000
RECOMMENDED_CU_INITIATE_DISPUTE = 50_000
RECOMMENDED_CU_VOTE_DISPUTE = 30_000
RECOMMENDED_CU_RESOLVE_DISPUTE = 60_000

// Token-path CU budgets
RECOMMENDED_CU_CREATE_TASK_TOKEN = 100_000
RECOMMENDED_CU_COMPLETE_TASK_TOKEN = 100_000
RECOMMENDED_CU_COMPLETE_TASK_PRIVATE_TOKEN = 250_000
RECOMMENDED_CU_CANCEL_TASK_TOKEN = 80_000

// Governance CU budgets
RECOMMENDED_CU_INITIALIZE_GOVERNANCE = 50_000
RECOMMENDED_CU_CREATE_PROPOSAL = 60_000
RECOMMENDED_CU_VOTE_PROPOSAL = 50_000
RECOMMENDED_CU_EXECUTE_PROPOSAL = 80_000
RECOMMENDED_CU_CANCEL_PROPOSAL = 30_000

// Skill CU budgets
RECOMMENDED_CU_REGISTER_SKILL = 50_000
RECOMMENDED_CU_UPDATE_SKILL = 30_000
RECOMMENDED_CU_RATE_SKILL = 40_000
RECOMMENDED_CU_PURCHASE_SKILL = 60_000
RECOMMENDED_CU_PURCHASE_SKILL_TOKEN = 100_000

// PDA seeds (all available as Buffer constants)
SEEDS = { PROTOCOL, TASK, CLAIM, AGENT, ESCROW, DISPUTE, VOTE, AUTHORITY_VOTE, NULLIFIER, PROPOSAL, GOVERNANCE_VOTE, GOVERNANCE, SKILL, SKILL_RATING, SKILL_PURCHASE, REPUTATION_STAKE, REPUTATION_DELEGATION }

// Fee tiers
FEE_TIERS = [[0, 0], [50, 10], [200, 25], [1000, 40]]  // [minTasks, discountBps]
```

## Agent Runtime

The `@agenc/runtime` package (~90k lines of TypeScript) provides comprehensive agent infrastructure.

### Package Configuration

- **Version:** `0.1.0`
- **Build Tool:** `tsup` (ESM + CJS, externals: openai, @anthropic-ai/sdk, ollama, better-sqlite3, ioredis, ws, grammy, discord.js, @slack/bolt, @whiskeysockets/baileys, matrix-js-sdk, cheerio, playwright, edge-tts)
- **Test Framework:** `vitest` (~4860+ tests)
- **Node:** `>=18.0.0`
- **Peer Dependencies:** `@coral-xyz/anchor >=0.29.0`, `@solana/web3.js >=1.90.0`, `@solana/spl-token >=0.4.0`
- **Optional Dependencies:** openai, @anthropic-ai/sdk, ollama, better-sqlite3, ioredis, ws, grammy, discord.js, @slack/bolt, @whiskeysockets/baileys, matrix-js-sdk, cheerio, playwright, edge-tts

### Runtime Module Map

```
runtime/src/
├── Core
│   ├── runtime.ts          # AgentRuntime (lifecycle)
│   ├── builder.ts          # AgentBuilder (fluent API)
│   ├── idl.ts              # IDL + Program factories
│   ├── bin/                # CLI entry points (agenc-runtime, daemon)
│   ├── cli/                # CLI commands (health, onboard, replay, jobs, logs, sessions, security, skills, wizard, daemon, registry-cli)
│   ├── agent/              # AgentManager, events, PDA, capabilities
│   └── types/              # Errors (101 codes), wallet, protocol, config migration
│
├── Gateway (Persistent Agent Process)
│   ├── gateway/            # Gateway lifecycle, config watcher, WebSocket control plane
│   │                       # Sessions, workspace, scheduler (cron), heartbeat, hooks
│   │                       # Identity resolver, personality, media pipeline, approvals, slash commands
│   │                       # JWT auth, routing, sandbox, sub-agents, remote gateway, voice bridge
│   │                       # Daemon wires semantic memory: embedding auto-select → vector store → ingestion → retriever
│   └── channels/           # 8 channel plugins: telegram, discord, webchat, slack, whatsapp, signal, matrix, imessage
│
├── Task Execution
│   ├── task/               # Operations, discovery, speculative executor, proofs, DLQ, rollback
│   │                       # Priority queue, checkpoints, commitment ledger, dependency graph, metrics
│   ├── autonomous/         # AutonomousAgent, scanner, verifier, risk scoring, arbitration
│   │                       # Escalation graphs, candidate generators, inconsistency detectors
│   └── workflow/           # DAG orchestrator, goal compiler, optimizer, canary rollout, feature extractor
│
├── AI Integration
│   ├── llm/                # Grok, Anthropic, Ollama adapters + ChatExecutor + FallbackProvider
│   ├── tools/              # ToolRegistry, skill adapter, built-in AgenC tools, system tools (HTTP, filesystem, browser, bash, macOS)
│   ├── skills/             # SkillRegistry + Jupiter DEX + markdown loader + bundled skills + on-chain registry client + catalog + monetization (analytics, revenue)
│   ├── memory/             # InMemory, SQLite, Redis backends + structured memory, embeddings, graph, encryption, vector store, ingestion, retriever (semantic pipeline wired into daemon)
│   └── voice/              # STT (Whisper), TTS (ElevenLabs, OpenAI, Edge), Realtime (xAI)
│
├── Protocol Operations
│   ├── dispute/            # DisputeOperations (6 instructions)
│   ├── governance/         # GovernanceOperations (5 instructions, PDA helpers)
│   ├── proof/              # ProofEngine (caching, stats)
│   ├── events/             # Event subscriptions + parsing (57 event types) + IDL drift checks
│   └── reputation/         # On-chain reputation economy (staking, delegation, portability)
│
├── Desktop Automation
│   ├── desktop/            # DesktopSandboxManager (pool, health, REST bridge, session router)
│   └── mcp-client/         # MCPManager (external MCP server connections, tool bridging)
│
├── Infrastructure
│   ├── connection/         # ConnectionManager (retry, failover, coalescing)
│   ├── replay/             # On-chain event timeline store (file, in-memory, SQLite), backfill, alerting, bridge, trace
│   ├── telemetry/          # Unified metrics collection + sinks + metric names
│   ├── policy/             # PolicyEngine (budgets, circuit breakers, RBAC, audit trail, incident roles, production profiles)
│   └── marketplace/        # TaskBidMarketplace + ServiceMarketplace (matching, scoring)
│
├── Collaboration & Social
│   ├── team/               # TeamContractEngine (payouts, audit, workflows, validation)
│   ├── eval/               # Benchmarks, mutation testing, trajectory replay, chaos matrix, evidence packs, calibration
│   ├── social/             # Agent discovery, messaging, feed, reputation scoring, collaboration protocol
│   └── bridges/            # External integrations: LangChain, X402 payments, Farcaster
│
└── Utilities
    └── utils/              # Encoding, logger, PDA, query, treasury, lazy-import, token, async, validation, process, type-guards
```

### AgentRuntime & AgentManager

```typescript
import { AgentRuntime, AgentManager, AgentCapabilities } from '@agenc/runtime';

const runtime = new AgentRuntime({
  connection, wallet, capabilities: AgentCapabilities.COMPUTE | AgentCapabilities.INFERENCE,
  initialStake: 1_000_000_000n,
});
await runtime.start();
await runtime.stop();
```

### AgentBuilder (Fluent API)

```typescript
import { AgentBuilder } from '@agenc/runtime';

const agent = new AgentBuilder()
  .withConnection(connection)
  .withWallet(keypair)
  .withCapabilities(AgentCapabilities.COMPUTE)
  .withLLM('grok', { apiKey, model: 'grok-3' })
  .withMemory(memoryBackend)
  .withProofEngine(proofEngine)
  .withRpcEndpoints([url1, url2])
  .build();
```

### Autonomous Agent

```typescript
import { AutonomousAgent, type TaskExecutor } from '@agenc/runtime';

const agent = new AutonomousAgent({
  connection, wallet, capabilities, executor,
  taskFilter: { capabilities, minReward: 10_000_000n },
  discoveryMode: 'hybrid',    // 'polling' | 'events' | 'hybrid'
  scanIntervalMs: 5000,
  maxConcurrentTasks: 1,
  generateProofs: true,
});
```

### LLM Adapters (3 providers)

```typescript
import { GrokProvider, AnthropicProvider, OllamaProvider, LLMTaskExecutor, ChatExecutor, FallbackLLMProvider } from '@agenc/runtime';
```

- **Grok:** Uses `openai` SDK (compatible API)
- **Anthropic:** Uses `@anthropic-ai/sdk`
- **Ollama:** Uses `ollama` package (local inference)
- **ChatExecutor:** Multi-turn chat with token budget enforcement, skill injection, memory retrieval
- **FallbackLLMProvider:** Automatic failover across multiple LLM providers

### Channel Plugins (8 total)

```typescript
import { TelegramChannel, DiscordChannel, WebChatChannel, SlackChannel, WhatsAppChannel, SignalChannel, MatrixChannel, IMessageChannel } from '@agenc/runtime';
```

### Voice Module

```typescript
import { WhisperAPIProvider, ElevenLabsProvider, OpenAITTSProvider, EdgeTTSProvider, XaiRealtimeClient } from '@agenc/runtime';
```

- STT: Whisper API transcription
- TTS: ElevenLabs, OpenAI, Edge TTS synthesis
- Realtime: xAI Realtime API voice client

### Bridges

```typescript
import { LangChainBridge, X402Bridge, FarcasterBridge } from '@agenc/runtime';
```

### Social Module

Agent social features: discovery, messaging, feed, reputation scoring, collaboration protocol.

### Reputation Economy

```typescript
import { ReputationEconomyOperations } from '@agenc/runtime';
```

Wraps on-chain reputation staking, delegation, and portability operations.

### Semantic Memory Pipeline

The daemon's `wireWebChat()` wires a full semantic memory stack when an embedding provider is available:

1. `createEmbeddingProvider()` auto-selects: Ollama (local) → OpenAI (if API key) → Noop (fallback)
2. `InMemoryVectorStore` stores embeddings with cosine + BM25 hybrid search
3. `MemoryIngestionEngine` embeds conversation turns + appends daily logs
4. `createIngestionHooks()` registers 3 hooks: turn capture (`message:outbound`), session end, session compaction
5. `SemanticMemoryRetriever` (implements `MemoryRetriever`) does hybrid search + recency re-ranking + curated MEMORY.md injection

Falls back to naive last-10-messages retriever when no embedding provider is available.

**Config** (`GatewayMemoryConfig` embedding fields):

| Field | Type | Description |
|-------|------|-------------|
| `embeddingProvider` | `"ollama" \| "openai" \| "noop"` | Force a specific provider (auto-selects if omitted) |
| `embeddingApiKey` | `string` | API key for OpenAI embeddings (falls back to `llm.apiKey`) |
| `embeddingBaseUrl` | `string` | Custom Ollama host or OpenAI base URL |
| `embeddingModel` | `string` | Embedding model name (e.g. `nomic-embed-text`) |

### Capabilities (Bitmask)

```typescript
import { AgentCapabilities, hasCapability, getCapabilityNames } from '@agenc/runtime';

AgentCapabilities.COMPUTE     // 1n << 0n
AgentCapabilities.INFERENCE   // 1n << 1n
AgentCapabilities.STORAGE     // 1n << 2n
AgentCapabilities.NETWORK     // 1n << 3n
AgentCapabilities.SENSOR      // 1n << 4n
AgentCapabilities.ACTUATOR    // 1n << 5n
AgentCapabilities.COORDINATOR // 1n << 6n
AgentCapabilities.ARBITER     // 1n << 7n
AgentCapabilities.VALIDATOR   // 1n << 8n
AgentCapabilities.AGGREGATOR  // 1n << 9n
```

### Error Classes

101 `RuntimeErrorCodes` organized by category:

| Category | Codes | Examples |
|----------|-------|---------|
| Core | 16 | AgentNotRegistered, ValidationError, InsufficientStake, ClaimExpired, RetryExhausted |
| LLM | 5 | LLMProviderError, LLMRateLimit, LLMResponseConversion, LLMToolCallError, LLMTimeout |
| Memory | 3 | MemoryBackendError, MemoryConnectionError, MemorySerializationError |
| Proof | 3 | ProofGenerationError, ProofVerificationError, ProofCacheError |
| Dispute | 4 | DisputeNotFound, DisputeVoteError, DisputeResolutionError, DisputeSlashError |
| Workflow | 4 | WorkflowValidation, WorkflowSubmission, WorkflowMonitoring, WorkflowState |
| Team | 4 | TeamContractValidation, TeamContractState, TeamPayout, TeamWorkflowTopology |
| Marketplace | 4 | MarketplaceValidation, MarketplaceState, MarketplaceAuthorization, MarketplaceMatching |
| Connection | 2 | ConnectionError, AllEndpointsUnhealthy |
| Telemetry | 1 | TelemetryError |
| Gateway | 5 | GatewayValidation, GatewayConnection, GatewayState, GatewayLifecycle, WorkspaceValidation |
| Chat | 1 | ChatBudgetExceeded |
| Governance | 3 | GovernanceProposalNotFound, GovernanceVoteError, GovernanceExecutionError |
| Identity | 5 | IdentityLinkExpired, IdentityLinkNotFound, IdentitySelfLink, IdentitySignatureInvalid, IdentityValidationError |
| Heartbeat | 3 | HeartbeatStateError, HeartbeatActionFailed, HeartbeatTimeout |
| Skills | 7 | SkillRegistryNotFound, SkillDownloadError, SkillVerificationError, SkillPublishError, SkillPurchaseError, SkillSubscriptionError, SkillRevenueError |
| Sandbox | 2 | SandboxExecutionError, SandboxUnavailable |
| Discovery | 1 | DiscoveryError |
| Voice | 3 | VoiceTranscriptionError, VoiceSynthesisError, VoiceRealtimeError |
| Bridge | 2 | BridgeError, BridgePaymentError |
| Sub-Agent | 3 | SubAgentSpawnError, SubAgentTimeout, SubAgentNotFound |
| Messaging | 3 | MessagingSendError, MessagingConnectionError, MessagingSignatureError |
| Feed | 3 | FeedPostError, FeedUpvoteError, FeedQueryError |
| Reputation | 6 | ReputationScoringError, ReputationTrackingError, ReputationStakeError, ReputationDelegationError, ReputationWithdrawError, ReputationPortabilityError |
| Collaboration | 3 | CollaborationRequestError, CollaborationResponseError, CollaborationFormationError |
| Remote Auth | 1 | RemoteAuthError |
| Desktop Sandbox | 4 | DesktopSandboxLifecycleError, DesktopSandboxHealthError, DesktopSandboxConnectionError, DesktopSandboxPoolExhausted |

### Runtime CLI

| Command | Purpose |
|---------|---------|
| `health` | Agent health check |
| `onboard` | Agent onboarding wizard |
| `replay` | Event replay operations |
| `jobs` | Scheduled job management |
| `logs` | Log viewing |
| `sessions` | Session management |
| `security` | Security checks |
| `skills` | Skill management (list, info, validate, create, install, uninstall, enable, disable) |
| `wizard` | Gateway config init/validate/show |
| `daemon` | Daemon lifecycle management |
| `registry-cli` | On-chain skill registry CLI |

## MCP Server

The `@agenc/mcp` package exposes protocol operations as MCP tools for AI assistants.

### Tools Exposed

| Category | Tools |
|----------|-------|
| Connection | `agenc_set_network`, `agenc_get_balance`, `agenc_airdrop` |
| Agents | `agenc_register_agent`, `agenc_deregister_agent`, `agenc_get_agent`, `agenc_list_agents`, `agenc_update_agent`, `agenc_decode_capabilities` |
| Tasks | `agenc_get_task`, `agenc_list_tasks`, `agenc_get_escrow`, `agenc_create_task`, `agenc_claim_task`, `agenc_complete_task`, `agenc_cancel_task` |
| Protocol | `agenc_get_protocol_config`, `agenc_derive_pda`, `agenc_decode_error`, `agenc_get_program_info` |
| Disputes | `agenc_get_dispute`, `agenc_list_disputes` |
| Testing | `agenc_run_tests`, `agenc_run_test_suite`, `agenc_get_test_files`, `agenc_get_last_results`, `agenc_get_benchmark_mutation_summary`, `agenc_run_anchor_test` |
| Inspector | `agenc_inspect_account`, `agenc_inspect_agent`, `agenc_inspect_task`, `agenc_inspect_escrow`, `agenc_inspect_dispute`, `agenc_list_program_accounts`, `agenc_inspect_transaction` |
| Replay | `agenc_replay_backfill`, `agenc_replay_compare`, `agenc_replay_incident`, `agenc_replay_status` (require `MCP_OPERATOR_ROLE`) |
| Human-Facing | `agenc_browse_skills`, `agenc_manage_sessions`, `agenc_get_agent_feed`, `agenc_approve_action` |

### MCP Prompts

| Prompt | Purpose |
|--------|---------|
| `debug-task` | Debug a task issue |
| `inspect-agent` | Inspect agent state |
| `escrow-audit` | Audit escrow accounts |
| `dispute-drift-triage` | Triage dispute drift |
| `payout-mismatch` | Investigate payout mismatches |
| `replay-anomaly-root-cause` | Root cause replay anomalies |

### MCP Resources

Static reference resources: `agenc://error-codes`, `agenc://capabilities`, `agenc://pda-seeds`, `agenc://task-states`

### Usage

```bash
claude mcp add agenc-dev -- node /path/to/AgenC/mcp/dist/index.js
# Or with env vars
claude mcp add agenc-dev \
  -e SOLANA_RPC_URL=http://localhost:8899 \
  -e SOLANA_KEYPAIR_PATH=~/.config/solana/id.json \
  -- node /path/to/AgenC/mcp/dist/index.js
```

## Desktop Sandbox Container

Headless Linux desktop running in Docker for autonomous agent desktop automation. The agent can see, click, type, and interact with GUI applications.

### Architecture

```
containers/
├── docker-compose.yml           # Orchestration config
└── desktop/
    ├── Dockerfile               # Ubuntu 22.04 + XFCE4 + VNC + Node.js 20
    ├── supervisord.conf         # Process manager (5 services)
    ├── seccomp.json             # Syscall security profile
    ├── xfce-config/             # 4 XML files (screensaver, power, session, desktop)
    └── server/
        └── src/
            ├── index.ts         # REST API (health, tools list, tool execution)
            ├── tools.ts         # 13 desktop automation tools
            └── types.ts         # Tool/result type definitions
```

### Process Stack (supervisord)

| Process | Priority | Purpose |
|---------|----------|---------|
| Xvfb | 100 | Virtual framebuffer (`:1`, configurable resolution) |
| XFCE4 | 200 | Lightweight desktop environment |
| x11vnc | 300 | VNC server (no password, shared mode, port 5900) |
| websockify | 400 | noVNC web proxy (port 6080 → VNC 5900) |
| rest-server | 500 | Node.js REST API (configurable PORT, default 9990) |

### Exposed Ports

| Port | Protocol | Service |
|------|----------|---------|
| 5900 | TCP | Raw VNC (internal) |
| 6080 | HTTP | noVNC web viewer (human observation) |
| 9990 | HTTP | REST API (agent tool execution) |

### REST API

| Endpoint | Method | Purpose |
|----------|--------|---------|
| `/health` | GET | Health check (status, display, uptime) |
| `/tools` | GET | List all 13 tool definitions with schemas |
| `/tools/:name` | POST | Execute a tool by name with JSON body args |

CORS enabled, 1MB max request body.

### Desktop Automation Tools (13 total)

| Tool | Backend | Description |
|------|---------|-------------|
| `screenshot` | scrot (ImageMagick fallback) | Capture desktop as base64 PNG with dimensions |
| `mouse_click` | xdotool | Move to (x,y) and click (button 1/2/3) |
| `mouse_move` | xdotool | Move cursor to (x,y) |
| `mouse_drag` | xdotool | Click-and-drag between two points |
| `mouse_scroll` | xdotool | Scroll up/down/left/right (1-100 clicks) |
| `keyboard_type` | xdotool | Type text (chunked at 50 chars to prevent X11 buffer overflow) |
| `keyboard_key` | xdotool | Press key combo (e.g., `ctrl+c`, `alt+Tab`, `Return`) |
| `bash` | /bin/bash | Execute shell command (120s timeout, 100KB output limit) |
| `window_list` | xdotool | List open windows with IDs and titles (max 50) |
| `window_focus` | xdotool | Focus window by title (partial match) |
| `clipboard_get` | xclip | Read clipboard contents |
| `clipboard_set` | xclip | Set clipboard contents |
| `screen_size` | xdpyinfo | Get current screen resolution |

### Security

- **Non-root**: Runs as `agenc` user (no sudo)
- **Seccomp profile**: Syscall allowlist for x86_64 + aarch64; blocks `init_module`, `delete_module`, `mount`, `umount2`, `pivot_root`, `reboot`, `kexec`, `settimeofday`, `clock_settime`, BPF, `unshare`, `setns`
- **XFCE hardened**: Screensaver disabled, power management off, no login prompts, no auto-save, no desktop icons
- **No VNC password**: Designed for local/trusted network only

### Usage

```bash
# Build and run
cd containers && docker compose up --build

# Access via browser (noVNC)
open http://localhost:6080

# Execute tools via REST API
curl -X POST http://localhost:9990/tools/screenshot
curl -X POST http://localhost:9990/tools/keyboard_type -H 'Content-Type: application/json' -d '{"text": "hello"}'

# Health check
curl http://localhost:9990/health
```

### Environment Variables

| Variable | Default | Purpose |
|----------|---------|---------|
| `DISPLAY_WIDTH` | `1024` | Virtual display width |
| `DISPLAY_HEIGHT` | `768` | Virtual display height |
| `DISPLAY_DEPTH` | `24` | Color depth |
| `PORT` | `9990` | REST API port |

## macOS Native Agent (Mac Mini)

Native macOS automation for agents running directly on Mac hardware (e.g., Mac Mini). Uses AppleScript, JXA, and iMessage for desktop control and communication without Docker.

### macOS System Tools

**Location:** `runtime/src/tools/system/macos.ts`

4 tools created by `createMacOSTools()` — returns empty array on non-Darwin platforms:

| Tool | Backend | Description |
|------|---------|-------------|
| `system.applescript` | `osascript` | Execute AppleScript (automate apps, dialogs, system settings) |
| `system.jxa` | `osascript -l JavaScript` | Execute JXA (JavaScript for Automation) |
| `system.open` | `open` command | Open files, URLs, or applications (optional `-a` app) |
| `system.notification` | `display notification` | Show macOS notification with optional sound |

**Security (DENIED_PATTERNS):** Blocks scripts matching:
- `/keychain/i` — Keychain access
- `/security\s+(find|delete|add|dump)/i` — Security command access
- `/do\s+shell\s+script.*with\s+administrator/i` — Admin shell scripts
- `/System\s+Events.*keystroke/i` — System Events keystroke injection
- `/delete\s+every/i` — Bulk delete operations

**Config:** `MacOSToolsConfig { logger?, timeoutMs? (default: 30000) }`

All tools use `execFile` (no shell injection), max output 8KB.

### iMessage Channel Plugin

**Location:** `runtime/src/channels/imessage/plugin.ts`

macOS-only channel plugin (`IMessageChannel extends BaseChannelPlugin`) that communicates via Apple Messages.app using AppleScript.

| Feature | Detail |
|---------|--------|
| Platform check | `process.platform === "darwin"` — skips on non-macOS |
| Polling | Reads Messages.app via AppleScript at configurable interval (default 5s) |
| Message format | Tab-separated: `guid \t sender \t text \t date` |
| Send | AppleScript `send` to participant via iMessage service |
| Contact filter | Optional `allowedContacts` whitelist (phone/email) |
| Session mapping | `imessage:{sender}` session IDs, tracks buddy IDs |
| Exec timeout | 15s for AppleScript calls |
| Max per poll | 10 messages (configurable) |

**Config (`IMessageChannelConfig`):**
```typescript
{
  enabled?: boolean;           // default: false
  pollIntervalMs?: number;     // default: 5000
  allowedContacts?: string[];  // empty = all contacts
  maxMessagesPerPoll?: number; // default: 10
}
```

### Desktop Executor (Autonomous Agent)

**Location:** `runtime/src/autonomous/desktop-executor.ts`

`DesktopExecutor` closes the see-think-act-verify loop for autonomous desktop automation. Uses ChatExecutor for LLM-driven tool calling.

**Execution flow (`executeGoal(goal, source)`):**
1. **PLAN**: Screenshot desktop → ChatExecutor generates step plan (JSON array)
2. **EXECUTE-VERIFY LOOP** (per plan step):
   - Check approval (if `ApprovalEngine` available)
   - ACT: ChatExecutor executes desktop tools via `ToolHandler`
   - VERIFY: Screenshot → LLM verification (`{success, confidence, description}`)
3. **COMPLETE**: Store result in memory, broadcast progress

**Config (`DesktopExecutorConfig`):**

| Field | Type | Default | Purpose |
|-------|------|---------|---------|
| `chatExecutor` | ChatExecutor | required | LLM + tool loop |
| `toolHandler` | ToolHandler | required | Desktop tools from registry |
| `screenshotTool` | Tool | required | Screenshot capture tool |
| `llm` | LLMProvider | required | Verification LLM |
| `memory` | MemoryBackend | required | Audit trail |
| `approvalEngine` | ApprovalEngine | optional | Safety gate for tool approvals |
| `communicator` | ProactiveCommunicator | optional | Progress broadcast |
| `maxSteps` | number | 20 | Max execution steps |
| `maxConsecutiveFailures` | number | 3 | Failures before "stuck" |
| `screenshotQuality` | low/medium/high | medium | Verification screenshot quality |

**Goal sources:** `"user"`, `"meta-planner"`, `"awareness"`, `"curiosity"`

**Statuses:** `planning` → `executing` → `completed` | `failed` | `stuck` | `cancelled`

### Desktop Awareness (Heartbeat)

**Location:** `runtime/src/autonomous/desktop-awareness.ts`

`createDesktopAwarenessAction()` returns a `HeartbeatAction` that periodically monitors the desktop:

1. Capture screenshot via Peekaboo MCP tool
2. LLM interprets context (focus app, user activity, errors/warnings)
3. Store observation in memory
4. Report noteworthy events (error dialogs, stuck processes, crashes)

Triggers alerts on keywords: "error", "warning", "stuck", "crash", "should help".

### MCP Client Bridge

**Location:** `runtime/src/mcp-client/`

Connects to external MCP servers (e.g., Peekaboo for screenshots, macos-automator-mcp) as child processes via stdio transport.

| File | Purpose |
|------|---------|
| `types.ts` | `MCPServerConfig`, `MCPToolBridge` interfaces |
| `connection.ts` | Spawn child process, JSON-RPC via `StdioClientTransport` |
| `tool-bridge.ts` | Convert MCP tools → runtime `Tool[]` (namespaced: `mcp.{server}.{tool}`) |
| `manager.ts` | `MCPManager` — manages multiple servers, unified tool list |

**MCPManager usage:**
```typescript
const manager = new MCPManager([
  { name: 'peekaboo', command: 'npx', args: ['-y', '@steipete/peekaboo@latest'] },
  { name: 'macos-automator', command: 'npx', args: ['-y', 'macos-automator-mcp'] },
], logger);

await manager.start();
registry.registerAll(manager.getTools());  // Tools namespaced: mcp.peekaboo.*, mcp.macos-automator.*
await manager.stop();
```

**Key behaviors:**
- Individual server failures don't block others (`Promise.allSettled`)
- Connection timeout with child process cleanup (default 30s)
- Disposed bridges return error on tool execution
- Inherits `process.env` + user-specified env overrides

### Docker vs macOS Comparison

| Feature | Docker Desktop Container | macOS Native (Mac Mini) |
|---------|------------------------|------------------------|
| Platform | Any (Linux container) | macOS only (darwin) |
| Desktop | XFCE4 on Xvfb | Native macOS desktop |
| Screenshots | scrot/ImageMagick via REST | Peekaboo MCP or native |
| Input automation | xdotool via REST | AppleScript/JXA/MCP tools |
| Messaging | N/A | iMessage channel plugin |
| Security | Seccomp + non-root + no VNC auth | DENIED_PATTERNS for scripts |
| Viewing | noVNC web viewer (port 6080) | Screen sharing / VNC |
| Agent integration | REST API → ToolHandler | MCP bridge → ToolRegistry |

## Zero-Knowledge Circuits

### Technology Stack

| Layer | Technology | Purpose |
|-------|------------|---------|
| zkVM Guest | RISC Zero guest program | Journal schema (shared types) |
| zkVM Host | RISC Zero host program | Off-chain proof generation |
| Verifier Router | RISC Zero Solana Verifier Router CPI | On-chain proof verification |
| Hash | SHA-256 (Solana `hashv`) | Commitment and binding hashing |

**Trusted Program IDs** (defined in `complete_task_private.rs`):
- **Router:** `6JvFfBrvCcWgANKh1Eae9xDq4RC6cfJuBcf71rp2k9Y7`
- **Verifier:** `THq1qFYQoh7zgcjXoMXduDBqiZRCPeg3PvvMbrVQUge`

**Journal Size:** 192 bytes (6 x 32-byte fields: task_pda, agent_authority, constraint_hash, output_commitment, binding, nullifier)
**Seal Size:** 260 bytes (4-byte selector + 256-byte Groth16 proof)

### zkVM Crates

- **Guest** (`zkvm/guest/`): Journal schema library — `JournalFields` struct, `serialize_journal()`, `placeholder_journal()`. Shared type definitions used by both the guest binary and the host.
- **Methods** (`zkvm/methods/`): Bridge crate that compiles the guest ELF at build time via `risc0-build` and exposes `AGENC_GUEST_ELF` + `AGENC_GUEST_ID` constants. Only built when `production-prover` feature is enabled.
- **Host** (`zkvm/host/`): Proof generation — `generate_proof()`, dev mode guard (refuses if `RISC0_DEV_MODE` set), deployment allowlist (only `localnet` allowlisted), Borsh-encoded seal output. Real Groth16 prover behind `production-prover` feature flag.
- **Pinned deps:** `risc0-zkvm ~3.0` (resolves to 3.0.5), `verifier_router` from `boundless-xyz/risc0-solana` tag v3.0.0

### Proof Flow

```
1. Agent computes task output locally
2. Host program generates RISC Zero proof (seal + journal)
3. Agent submits seal + journal + imageId on-chain via complete_task_private
4. On-chain: Verifier Router CPI validates the seal against the journal and image ID
5. On-chain: Journal fields parsed and validated (binding, commitment, constraint hash)
6. On-chain: BindingSpend + NullifierSpend PDAs prevent replay
7. If valid, agent receives reward without revealing output
```

## Code Style

- **Rust**: Anchor framework conventions, `cargo fmt` + `cargo clippy`
- **TypeScript**: Strict mode, ESM and CJS dual builds, 2-space indentation

### Naming Conventions

| Language | Type | Convention | Example |
|----------|------|------------|---------|
| Rust | Types | `PascalCase` | `AgentRegistration`, `TaskStatus` |
| Rust | Functions | `snake_case` | `register_agent`, `complete_task` |
| TypeScript | Types | `PascalCase` | `PrivacyClient`, `TaskParams` |
| TypeScript | Functions | `camelCase` | `generateProof`, `createTask` |

## Error Handling

### Anchor Program (CoordinationError)

Source of truth: `programs/agenc-coordination/src/errors.rs`.

- Total variants: 176 (codes `6000-6175`)
- Anchor assigns codes sequentially by enum position: `code = 6000 + index`
- The "range" comments in `errors.rs` are organizational and may be stale

When you need an exact code, compute it from the enum order rather than relying on comments or external tables.

The runtime's `AnchorErrorCodes` mapping (`runtime/src/types/errors.ts`) maps 198 codes and may drift from the Rust source; prefer the Rust source.

## Key Design Patterns

### PDA Seeds (Anchor)

```rust
["protocol"]                                    // Protocol config (singleton)
["agent", agent_id]                             // Agent registration
["task", creator, task_id]                      // Task
["escrow", task_pda]                            // Task escrow
["claim", task_pda, worker_agent_pda]           // Worker claim
["dispute", dispute_id]                         // Dispute
["vote", dispute_pda, voter_agent_pda]          // Dispute vote
["authority_vote", dispute_pda, authority]       // Authority dispute vote
["state", owner, state_key]                     // Shared state
["nullifier_spend", nullifier]                  // ZK proof nullifier
["binding_spend", binding]                      // ZK proof binding
["speculation_bond", agent]                     // Speculation bond
["governance"]                                   // Governance config (singleton)
["proposal", proposer_agent_pda, nonce]         // Governance proposal
["governance_vote", proposal_pda, voter]        // Governance vote
["skill", author_agent_pda, skill_id]           // Skill registration
["skill_rating", skill_pda, rater_agent_pda]    // Skill rating
["skill_purchase", skill_pda, buyer_agent_pda]  // Purchase record
["post", author_agent_pda, nonce]               // Feed post
["upvote", post_pda, voter_agent_pda]           // Feed upvote
["reputation_stake", agent_pda]                 // Reputation stake
["reputation_delegation", delegator, delegatee] // Reputation delegation
```

### Anchor IDL Type Handling (CRITICAL)

Anchor generates two files with different naming:
- `agenc_coordination.json` (snake_case) - Runtime IDL data
- `agenc_coordination.ts` (camelCase) - TypeScript type helper only

**CORRECT:** Use `Idl` type for raw JSON, `AgencCoordination` for `Program<T>` generics:
```typescript
export const IDL: Idl = idlJson as Idl;  // Generic Idl for snake_case JSON
export function createProgram(provider, programId?): Program<AgencCoordination> { ... }
```

## Configuration

### Account Status Enums

```rust
// AgentStatus
Inactive = 0, Active = 1, Busy = 2, Suspended = 3

// TaskStatus
Open = 0, InProgress = 1, PendingValidation = 2, Completed = 3, Cancelled = 4, Disputed = 5

// TaskType
Exclusive = 0, Collaborative = 1, Competitive = 2

// DependencyType
None = 0, Data = 1, Ordering = 2, Proof = 3

// ResolutionType
Refund = 0, Complete = 1, Split = 2

// DisputeStatus
Active = 0, Resolved = 1, Expired = 2, Cancelled = 3

// ProposalType
ProtocolUpgrade = 0, FeeChange = 1, TreasurySpend = 2, RateLimitChange = 3

// ProposalStatus
Active = 0, Executed = 1, Defeated = 2, Cancelled = 3

// SlashReason
ProofFailed = 0, ProofTimeout = 1, InvalidResult = 2
```

### Agent Capabilities (Bitmask)

```rust
COMPUTE = 1 << 0, INFERENCE = 1 << 1, STORAGE = 1 << 2, NETWORK = 1 << 3,
SENSOR = 1 << 4, ACTUATOR = 1 << 5, COORDINATOR = 1 << 6, ARBITER = 1 << 7,
VALIDATOR = 1 << 8, AGGREGATOR = 1 << 9
```

### Fee Tier Constants

```typescript
FEE_TIERS = [
  [0, 0],       // Base: no discount
  [50, 10],     // Bronze: 10 bps after 50 tasks
  [200, 25],    // Silver: 25 bps after 200 tasks
  [1000, 40],   // Gold: 40 bps after 1000 tasks
]
```

## Testing

### Test Infrastructure

Tests use LiteSVM for ~50x speedup vs solana-test-validator (PR #866).

**Key files:**

| File | Purpose |
|------|---------  |
| `tests/litesvm-helpers.ts` | Core adapter: `createLiteSVMContext()`, `fundAccount()`, `advanceClock()`, `getClockTimestamp()`, `injectMockVerifierRouter()` |
| `tests/test-utils.ts` | **Single source of truth** for all constants (capabilities, task types, PDA helpers) |
| `tests/test-setup.ts` | Shared before/beforeEach lifecycle hooks (DRY) |
| `tests/test_1.ts` | Main integration suite (140 tests) |
| `tests/dispute-slash-logic.ts` | Dispute slashing tests |
| `tests/spl-token-tasks.ts` | SPL token escrow tests |
| `tests/governance.ts` | Governance integration tests |
| `tests/lifecycle-guards.ts` | Lifecycle guard tests |
| `tests/agent-feed.ts` | Agent feed tests (included in test:fast) |
| `tests/reputation-economy.ts` | Reputation economy tests (included in anchor test) |
| `tests/complete_task_private.ts` | Private task completion tests |
| `tests/zk-proof-lifecycle.ts` | ZK proof lifecycle tests |
| `tests/coordination-security.ts` | Security tests |
| `tests/audit-high-severity.ts` | High severity audit tests |
| `tests/security-audit-fixes.ts` | Security audit fix tests |
| `tests/rate-limiting.ts` | Rate limiting tests |
| `tests/sybil-attack.ts` | Sybil attack resistance tests |
| `tests/upgrades.ts` | Protocol upgrade tests |
| `tests/test_cu_benchmarks.ts` | Compute unit benchmarks |
| `tests/integration.ts` | Additional integration tests |
| `tests/e2e-real-proof.ts` | End-to-end real RISC Zero proof tests |
| `tests/smoke.ts` | Smoke tests |
| `tests/minimal.ts` | Minimal test file |
| `tests/minimal-debug.ts` | Minimal debug test file |
| `tests/litesvm-poc.ts` | 13 PoC tests validating LiteSVM API |

**LiteSVM Critical Gotchas:**
- Clock doesn't advance automatically — need `advanceClock(svm, 61)` before `updateAgent` (60s cooldown)
- Use `getClockTimestamp(svm)` not `Date.now()` for deadline calculations (clock drift accumulates)
- `svm.withDefaultPrograms()` required for SPL token tests
- BN.js has precision bug with u64::MAX — verify via raw bytes not decimal string

**Test commands:**
```bash
npm run test:fast           # LiteSVM tests (~5s, includes agent-feed)
npm run test                # SDK + runtime vitest suites
cd runtime && npm run test  # Runtime only (~4860+ tests)
```

### Test Constants (from test-utils.ts)

```typescript
CAPABILITY_COMPUTE = 1 << 0, CAPABILITY_INFERENCE = 1 << 1, // etc.
TASK_TYPE_EXCLUSIVE = 0, TASK_TYPE_COLLABORATIVE = 1, TASK_TYPE_COMPETITIVE = 2
RESOLUTION_TYPE_REFUND = 0, RESOLUTION_TYPE_COMPLETE = 1, RESOLUTION_TYPE_SPLIT = 2
```

**PDA helpers** (all take `programId` parameter):
`deriveProtocolPda`, `deriveAgentPda`, `deriveTaskPda`, `deriveEscrowPda`, `deriveClaimPda`, `deriveDisputePda`, `deriveVotePda`, `deriveAuthorityVotePda`, `deriveStatePda`, `deriveProgramDataPda`

### Mutation Testing & Regression Gates

**Gate thresholds (in CI):**
```
MUTATION_MAX_AGGREGATE_PASS_RATE_DROP = 0.60
MUTATION_MAX_AGGREGATE_CONFORMANCE_DROP = 0.35
MUTATION_MAX_AGGREGATE_COST_UTILITY_DROP = 0.45
MUTATION_MAX_SCENARIO_PASS_RATE_DROP = 1.00
MUTATION_MAX_OPERATOR_PASS_RATE_DROP = 0.60
```

## CI/CD Pipeline

GitHub Actions workflow (`.github/workflows/ci.yml`):

| Job | Trigger | Purpose |
|-----|---------|---------|
| `runtime_checks` | workflow_dispatch | Install deps, IDL drift check, runtime tests, typecheck, build, MCP typecheck + tests |
| `reliability_regression` | workflow_dispatch (after runtime_checks) | Benchmark corpus, mutation suite, enforce mutation gates, upload artifacts (14-day retention) |
| `nightly_reliability` | Daily 6 AM UTC | Nightly benchmarks + mutations, dry-run gates, 30-day artifact retention |

**Environment:** Node 20

## Common Pitfalls

### Anchor 0.32 Compatibility

```typescript
// Use .accountsPartial() for optional accounts
await program.methods.resolveDispute().accountsPartial({ worker: null }).rpc();

// Event names are camelCase
program.addEventListener('taskCompleted', callback);
```

### bigint Serialization

```typescript
// WRONG: JSON.stringify throws on bigint
JSON.stringify({ amount: 1000n });  // TypeError!

// RIGHT: Use safeStringify from runtime or mcp utils
import { safeStringify } from '@agenc/runtime';
safeStringify({ amount: 1000n });  // Works: {"amount":"1000"}
```

### Test Logic Errors

```typescript
// WRONG: Modifying local copy has no on-chain effect
const agent = await program.account.agentRegistration.fetch(agentPda);
agent.activeTasks = 10;  // Only changes local JS object!

// RIGHT: Use program instructions to modify on-chain state
await program.methods.updateAgent(...).rpc();
```

## Security Patterns

### Critical Invariants

| Invariant | Location | Description |
|-----------|----------|-------------|
| Competitive task single-completion | `complete_task.rs`, `complete_task_private.rs` | Check `task.completions == 0` before paying |
| Account owner validation | `resolve_dispute.rs` | Validate `account.owner == crate::ID` before deserializing `remaining_accounts` |
| Constraint hash binding | `complete_task_private.rs` | ZK proofs verify `proof.constraint_hash == task.constraint_hash` |
| Proof nullifier uniqueness | `complete_task_private.rs` | Nullifier PDA via `init` prevents proof reuse |
| Proof binding non-zero | `complete_task_private.rs` | `expected_binding` and `output_commitment` must not be all zeros |
| Rate limit enforcement | `create_task.rs`, `initiate_dispute.rs` | Check cooldown and 24h limits |
| Reputation staking cooldown | `withdraw_reputation_stake.rs` | 7-day cooldown before withdrawal |
| Skill self-purchase prevention | `purchase_skill.rs` | Author cannot purchase own skill |
| Feed self-upvote prevention | `upvote_post.rs` | Author cannot upvote own post |

### Security Audit Checklist

When modifying instruction handlers, verify:
- [ ] Account ownership validated for `remaining_accounts`
- [ ] Competitive task completion check present
- [ ] Arithmetic uses `checked_*` operations
- [ ] Rate limits enforced where applicable
- [ ] Events emitted for state changes
- [ ] PDA seeds match expected format
- [ ] Signer constraints properly applied
- [ ] Version compatibility checked
- [ ] ZK proof nullifier checked (for private completion paths)

## Anchor Configuration

```toml
[toolchain]
anchor_version = "0.32.1"
solana_version = "3.0.13"

[programs.localnet]
agenc_coordination = "5j9ZbT3mnPX5QjWVMrDaWFuaGf8ddji6LW1HVJw6kUE7"

[test]
startup_wait = 120000
shutdown_wait = 5000
upgradeable = true

[scripts]
test = "npx ts-mocha -p ./tsconfig.json -t 300000 tests/test_1.ts tests/dispute-slash-logic.ts tests/spl-token-tasks.ts tests/lifecycle-guards.ts tests/governance.ts tests/agent-feed.ts tests/reputation-economy.ts"
```

## Build Scripts

| Script | Purpose |
|--------|---------|
| `scripts/simulate_upgrade.sh` | Protocol upgrade simulation |
| `scripts/check-deployment-readiness.sh` | Pre-deployment validation |
| `scripts/check-breaking-changes.ts` | Check for breaking API changes |
| `scripts/check-docs-links.sh` | Validate documentation links |
| `scripts/setup-dev.sh` | Developer environment setup |
| `scripts/smoke-test-examples.sh` | Smoke test example projects |
| `scripts/validate-env.sh` | Validate environment configuration |
| `scripts/generate-real-proof.ts` | Generate RISC Zero proofs for testing |
| `scripts/setup-verifier-localnet.sh` | Set up Verifier Router on localnet |
| `scripts/setup-verifier-localnet.ts` | TypeScript version of verifier setup |
| `runtime/scripts/run-benchmarks.ts` | Run deterministic benchmark corpus |
| `runtime/scripts/run-mutations.ts` | Run mutation test suite |
| `runtime/scripts/check-mutation-gates.ts` | Check mutation regression gates |
| `runtime/scripts/check-idl-drift.ts` | Check IDL drift between program and runtime |
| `runtime/scripts/copy-idl.js` | Copy IDL from target/idl/ to runtime/idl/ |

## Environment Variables

| Variable | Used In | Purpose |
|----------|---------|---------|
| `SOLANA_RPC_URL` | mcp | MCP server RPC endpoint |
| `SOLANA_KEYPAIR_PATH` | mcp | MCP server keypair path |
| `MCP_OPERATOR_ROLE` | mcp | Operator role for replay tools (read\|investigate\|execute\|admin) |
| `NODE_ENV` | sdk | Production mode (placeholder functions throw) |
| `VITE_SOLANA_RPC_URL` | demo-app | Custom RPC endpoint |
| `HELIUS_API_KEY` | examples/helius-webhook | Helius API authentication |
| `RISC0_DEV_MODE` | zkvm/host | Dev mode guard — host refuses proof generation if set |
| `MUTATION_MAX_*` | CI | Mutation regression gate thresholds |

## Roadmap Development Workflow

58 implementation issues (#1051-#1110) across 10 phases, tracked on a [GitHub Project kanban board](https://github.com/orgs/tetsuo-ai/projects/9). Architecture docs live in `docs/architecture/` and a docs-mcp server provides AI-assisted implementation context per issue.

### Kanban Columns

| Column | Meaning | Rule |
|--------|---------|------|
| Backlog | Has unmet dependencies | Do NOT pick up |
| Ready | All dependencies met | Safe to start |
| In Progress | Actively being worked on | Assign yourself |
| In Review | PR is open | Awaiting review |
| Done | Merged | Verified complete |

### Docs MCP Server

The `agenc-docs` MCP server ("AgenC Architecture Docs" v0.1.0) provides implementation context for any roadmap issue.

| Tool | Purpose |
|------|---------|
| `docs_search` | Full-text search across architecture docs |
| `docs_get_issue_context` | Full implementation context for a specific issue |
| `docs_get_phase_graph` | Mermaid dependency graph + recommended build order for a phase |
| `docs_get_module_template` | Boilerplate for creating a new runtime module |
| `docs_get_module_info` | Architecture details about an existing module |
| `docs_get_conventions` | Type, testing, and error handling conventions |
