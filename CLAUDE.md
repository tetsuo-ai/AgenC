# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## CRITICAL: No Attribution

**NEVER add any attribution, signatures, or co-author tags to ANY git operations.** This includes:

- NO `Co-Authored-By` lines in commit messages
- NO Claude references in PR descriptions
- NO Claude signatures on issues or comments
- NO attribution footers of any kind
- NO "Generated by" or "Created by" tags

Commit messages should contain ONLY the commit message itself - nothing else.

## Project Overview

AgenC is a privacy-preserving AI agent coordination protocol built on Solana. It enables decentralized task coordination with zero-knowledge proofs for private task completions.

**Packages:**
- **Anchor Program** (`programs/agenc-coordination/`) - Solana smart contract for task coordination, disputes, rewards, SPL token escrow, and on-chain governance
- **TypeScript SDK** (`sdk/`) - Privacy-preserving task coordination client (`@agenc/sdk` v1.3.0)
- **Agent Runtime** (`runtime/`) - Agent lifecycle management, autonomous agents, gateway, LLM adapters, tools, memory, proofs, workflows, marketplace, teams, governance, policy, telemetry (`@agenc/runtime` v0.1.0)
- **MCP Server** (`mcp/`) - Model Context Protocol server exposing protocol operations as MCP tools (`@agenc/mcp` v0.1.0)
- **Docs MCP Server** (`docs-mcp/`) - MCP server providing AI-assisted architecture doc lookups per roadmap issue
- **Demo App** (`demo-app/`) - React web interface for privacy workflow demonstration
- **ZK Circuits** (`circuits/`) - Noir circuits for private task completion proofs (Groth16)
- **MPC Ceremony** (`circuits-circuit/`) - Trusted setup tooling for Groth16 verifying key generation
- **Test Infrastructure** (`tests/`) - LiteSVM-based integration tests, CU benchmarks, and Rust fuzz testing

## Quick Start

```bash
# 1. Install dependencies
npm install

# 2. Build all packages (sdk + runtime + mcp + docs-mcp)
npm run build

# 3. Run fast integration tests (~5 seconds via LiteSVM)
npm run test:fast

# 4. Run unit tests (SDK + Runtime vitest suites)
npm run test

# 5. Build the Anchor program
anchor build
```

**Prerequisites:** Rust, Solana CLI (`v3.0.13`), Anchor CLI (`v0.32.1`), Node.js (`>=18`)

## Build Commands

### Root Package (Orchestrator)

```bash
npm run build              # Build sdk + runtime + mcp + docs-mcp
npm run test               # Build + run SDK + runtime vitest suites
npm run typecheck           # Typecheck sdk + runtime + mcp
npm run test:fast           # LiteSVM integration tests (~5s)
npm run test:anchor         # Full ts-mocha integration tests (all files)
npm run test:fixtures       # Eval/replay integration tests
npm run demo               # Run private task demo
npm run demo:mainnet       # Run demo with Helius API key
```

### Solana Anchor Program (Rust)

```bash
anchor build               # Build the Solana program
anchor test                # Run tests with local validator
cargo test --manifest-path programs/agenc-coordination/Cargo.toml  # Rust unit tests
```

### TypeScript SDK

```bash
cd sdk
npm run build              # Build SDK (outputs to dist/)
npm run typecheck           # Type checking only
npm run test               # Run vitest unit tests
```

### Agent Runtime

```bash
cd runtime
npm run build              # Build (outputs to dist/)
npm run typecheck           # Type checking only
npm run test               # Run vitest (~1800+ tests)
npm run benchmark           # Run deterministic benchmark corpus
npm run benchmark:ci        # Benchmark with artifact output
npm run mutation            # Run mutation test suite
npm run mutation:ci         # Mutation with artifact + trend output
npm run mutation:gates      # Check mutation regression gates
```

### MCP Server

```bash
cd mcp
npm run build              # Build (outputs to dist/)
npm run typecheck           # Type checking only
npm run test               # Run tests (node --test)
```

### Demo App

```bash
cd demo-app
npm run dev                # Development server
npm run build              # Production build (outputs to dist/)
```

### ZK Circuits (Noir)

```bash
cd circuits/task_completion
risc0-host-prover compile              # Compile circuit
risc0-host-prover test                 # Run circuit tests
risc0-host-prover prove                # Generate proof (requires Prover.toml inputs)
```

### Fuzz Tests

```bash
cd programs/agenc-coordination
cargo fuzz run claim_task           # Fuzz claim_task instruction
cargo fuzz run complete_task        # Fuzz complete_task instruction
cargo fuzz run vote_dispute         # Fuzz vote_dispute instruction
cargo fuzz run resolve_dispute      # Fuzz resolve_dispute instruction
```

## Architecture

```
AgenC/
├── .github/workflows/ci.yml        # CI pipeline (runtime_checks, reliability_regression, nightly)
├── programs/agenc-coordination/     # Solana Anchor program (Rust)
│   ├── src/
│   │   ├── lib.rs                   # Program entrypoint (30 instructions)
│   │   ├── state.rs                 # Account structures
│   │   ├── errors.rs                # Error definitions (161 codes; 6000-6160)
│   │   ├── events.rs                # Event emissions (35 event types)
│   │   ├── legacy-verifier-key.rs         # Groth16 verifying key
│   │   ├── instructions/            # Instruction handlers
│   │   │   ├── mod.rs               # Module exports (30 instruction + 9 helper modules)
│   │   │   ├── register_agent.rs
│   │   │   ├── update_agent.rs
│   │   │   ├── suspend_agent.rs     # Protocol authority agent suspension
│   │   │   ├── unsuspend_agent.rs   # Protocol authority agent unsuspension
│   │   │   ├── deregister_agent.rs
│   │   │   ├── create_task.rs
│   │   │   ├── create_dependent_task.rs
│   │   │   ├── claim_task.rs
│   │   │   ├── expire_claim.rs
│   │   │   ├── complete_task.rs
│   │   │   ├── complete_task_private.rs
│   │   │   ├── cancel_task.rs
│   │   │   ├── update_state.rs
│   │   │   ├── initiate_dispute.rs
│   │   │   ├── vote_dispute.rs
│   │   │   ├── resolve_dispute.rs
│   │   │   ├── apply_dispute_slash.rs
│   │   │   ├── apply_initiator_slash.rs  # Symmetric initiator slashing
│   │   │   ├── cancel_dispute.rs
│   │   │   ├── expire_dispute.rs
│   │   │   ├── initialize_protocol.rs
│   │   │   ├── update_protocol_fee.rs
│   │   │   ├── update_rate_limits.rs
│   │   │   ├── migrate.rs
│   │   │   ├── initialize_governance.rs  # Set up governance config
│   │   │   ├── create_proposal.rs        # Create governance proposal
│   │   │   ├── vote_proposal.rs          # Vote on proposal
│   │   │   ├── execute_proposal.rs       # Execute passed proposal
│   │   │   ├── cancel_proposal.rs        # Cancel proposal
│   │   │   ├── completion_helpers.rs # Shared completion + tiered fee logic
│   │   │   ├── task_init_helpers.rs  # Shared task creation helpers
│   │   │   ├── dispute_helpers.rs    # Dispute resolution helpers
│   │   │   ├── slash_helpers.rs      # Slashing logic
│   │   │   ├── rate_limit_helpers.rs # Rate limit enforcement
│   │   │   ├── lamport_transfer.rs   # Checked lamport transfers
│   │   │   ├── token_helpers.rs      # SPL token CPI helpers
│   │   │   ├── constants.rs          # Instruction constants
│   │   │   └── validation.rs         # Account validation helpers
│   │   └── utils/                   # Multisig, version, compute budget
│   └── fuzz/                        # Fuzz testing targets + infrastructure
├── sdk/                             # TypeScript SDK (@agenc/sdk v1.3.0)
│   ├── src/
│   │   ├── index.ts                 # Main exports
│   │   ├── client.ts                # PrivacyClient class
│   │   ├── proofs.ts                # ZK proof generation/verification
│   │   ├── tasks.ts                 # Task operations
│   │   ├── privacy.ts               # Privacy Cash + SPL token integration
│   │   ├── tokens.ts                # SPL token helpers
│   │   ├── bids.ts                  # Marketplace bidding types
│   │   ├── queries.ts               # Task dependency queries
│   │   ├── constants.ts             # Program IDs, RPC endpoints, CU budgets
│   │   ├── validation.ts            # Circuit path validation
│   │   ├── anchor-utils.ts          # Anchor utility functions
│   │   ├── logger.ts                # SDK logger
│   │   └── types/                   # TypeScript type stubs
│   └── dist/                        # Build output (ESM + CJS)
├── runtime/                         # Agent Runtime (@agenc/runtime v0.1.0, ~90k lines)
│   ├── src/
│   │   ├── index.ts                 # Barrel exports (~1400 lines)
│   │   ├── idl.ts                   # IDL + Program factory functions
│   │   ├── runtime.ts               # AgentRuntime class (lifecycle wrapper)
│   │   ├── builder.ts               # AgentBuilder (fluent composition API)
│   │   ├── bin/                     # CLI entry points (agenc-runtime, daemon)
│   │   ├── cli/                     # CLI commands (health, onboard, replay, jobs, logs, sessions, security, skills, wizard, daemon)
│   │   ├── agent/                   # Agent management (manager, events, PDA, capabilities)
│   │   ├── autonomous/             # Autonomous agents (scanner, verifier, risk scoring, arbitration)
│   │   ├── task/                    # Task pipeline (operations, discovery, speculative execution, proofs)
│   │   ├── gateway/                 # Persistent agent gateway (lifecycle, channels, config watcher, WebSocket control, sessions, workspace, scheduler, heartbeat, hooks, identity, personality, media, approvals, slash commands)
│   │   ├── channels/               # Channel plugins (telegram/, discord/)
│   │   ├── governance/             # On-chain governance operations (5 instructions, PDA helpers)
│   │   ├── tools/                   # Tool registry + built-in AgenC tools + system tools (HTTP, filesystem, browser, bash)
│   │   ├── llm/                     # LLM adapters (Grok, Anthropic, Ollama) + ChatExecutor + FallbackProvider
│   │   ├── memory/                  # Memory backends (InMemory, SQLite, Redis) + structured memory, embeddings, graph, encryption
│   │   ├── proof/                   # ZK Proof Engine (caching, stats)
│   │   ├── dispute/                 # Dispute operations (6 instructions)
│   │   ├── workflow/                # DAG orchestrator, goal compiler, optimizer, rollout
│   │   ├── connection/             # Resilient RPC (retry, failover, coalescing)
│   │   ├── replay/                  # On-chain event timeline store (file, in-memory, SQLite), backfill service, alerting
│   │   ├── eval/                    # Evaluation (benchmarks, mutation testing, trajectory replay)
│   │   ├── marketplace/            # Task bid marketplace (matching, scoring, strategies)
│   │   ├── team/                    # Team contracts (engine, payouts, audit)
│   │   ├── policy/                  # Policy engine (budgets, circuit breakers, RBAC, audit trail)
│   │   ├── skills/                  # Skills registry + Jupiter DEX + markdown loader + bundled skills + on-chain registry client + catalog
│   │   ├── telemetry/              # Unified metrics collection + sinks
│   │   ├── events/                  # Event subscriptions + parsing (35 event types)
│   │   ├── types/                   # Protocol types, errors (67 codes), wallet, config migration
│   │   └── utils/                   # Encoding, logger, PDA, query, treasury, lazy-import
│   ├── scripts/                     # Benchmark + mutation CLI scripts
│   ├── benchmarks/                  # Benchmark manifests + CI artifacts
│   └── dist/                        # Build output (ESM + CJS)
├── mcp/                             # MCP Server (@agenc/mcp v0.1.0)
│   ├── src/
│   │   ├── index.ts                 # Entry point (stdio transport)
│   │   ├── server.ts                # MCP server, resources, prompts
│   │   ├── tools/                   # connection, agents, tasks, protocol, disputes, circuits, testing, inspector, replay
│   │   └── utils/                   # connection, formatting
│   └── dist/                        # Build output
├── docs-mcp/                        # Docs MCP Server (architecture doc lookups)
├── demo-app/                        # React + Vite web interface
├── circuits/task_completion/        # Noir ZK circuits
├── circuits-circuit/task_completion/ # Circom circuits + MPC ceremony tooling
├── examples/                        # autonomous-agent, dispute-arbiter, event-dashboard, helius-webhook, llm-agent, memory-agent, simple-usage, skill-jupiter, tetsuo-integration, zk-proof-demo
├── tests/                           # LiteSVM-based integration tests
│   ├── test_1.ts                    # Main integration suite (140 tests)
│   ├── dispute-slash-logic.ts       # Dispute slashing tests
│   ├── spl-token-tasks.ts           # SPL token escrow tests
│   ├── governance.ts                # Governance integration tests
│   ├── lifecycle-guards.ts          # Lifecycle guard tests
│   ├── litesvm-helpers.ts           # LiteSVM test adapter
│   ├── litesvm-poc.ts               # LiteSVM proof-of-concept (13 tests)
│   ├── test-setup.ts                # Shared lifecycle hooks (DRY)
│   ├── test-utils.ts                # Canonical test constants + PDA helpers
│   └── ...                          # Security, audit, smoke, rate-limiting, ZK lifecycle, sybil, upgrades tests
├── scripts/                         # Build/deployment/sync scripts
├── docs/                            # Documentation
├── audit/                           # Bug bounty & reviews
├── migrations/                      # Protocol migration tools
└── Anchor.toml                      # Anchor config (v0.32.1, Solana v3.0.13)
```

## Anchor Program Instructions

| Instruction | Purpose |
|-------------|---------|
| `initialize_protocol` | Set up protocol config, treasury, fees |
| `register_agent` | Register agent with capabilities + stake |
| `update_agent` | Update agent capabilities, endpoint, status |
| `suspend_agent` | Protocol authority suspends an agent |
| `unsuspend_agent` | Protocol authority unsuspends an agent |
| `deregister_agent` | Unregister agent from protocol |
| `create_task` | Post task with SOL or SPL token escrow reward |
| `create_dependent_task` | Create task with dependency on parent task |
| `claim_task` | Worker claims a task |
| `expire_claim` | Handle claim timeout |
| `complete_task` | Submit proof, receive payment |
| `complete_task_private` | Submit ZK proof for private completion |
| `cancel_task` | Creator cancels, gets refund |
| `update_state` | Sync shared state with version |
| `initiate_dispute` | Start dispute resolution |
| `vote_dispute` | Arbiters vote on dispute |
| `resolve_dispute` | Execute dispute resolution |
| `apply_dispute_slash` | Slash worker stake for losing dispute |
| `apply_initiator_slash` | Slash initiator stake for frivolous dispute |
| `cancel_dispute` | Initiator cancels before votes |
| `expire_dispute` | Handle dispute timeout |
| `update_protocol_fee` | Adjust protocol fees (multisig) |
| `update_rate_limits` | Configure rate limits (multisig) |
| `migrate_protocol` | Version migration handler (multisig) |
| `update_min_version` | Update minimum supported protocol version (multisig) |
| `initialize_governance` | Set up on-chain governance config |
| `create_proposal` | Create a governance proposal |
| `vote_proposal` | Vote on a governance proposal |
| `execute_proposal` | Execute a passed proposal |
| `cancel_proposal` | Cancel a governance proposal |

### Helper Modules (not instructions)

| Module | Purpose |
|--------|---------|
| `completion_helpers` | Shared completion logic + tiered fee calculation |
| `task_init_helpers` | Shared `init_task_fields()` for create_task + create_dependent_task |
| `dispute_helpers` | Dispute resolution helpers |
| `slash_helpers` | Slashing logic for disputes |
| `rate_limit_helpers` | Rate limit enforcement helpers |
| `lamport_transfer` | Checked arithmetic lamport transfers |
| `token_helpers` | SPL token CPI helpers (transfer, close) |
| `constants` | Instruction-specific constants |
| `validation` | Account validation helpers |

## Program Events

Events emitted for off-chain monitoring (subscribe via WebSocket):

| Event | Fields | Purpose |
|-------|--------|---------|
| `AgentRegistered` | agent_id, authority, capabilities, endpoint, stake_amount, timestamp | New agent joins |
| `AgentUpdated` | agent_id, capabilities, status, timestamp | Agent config changed |
| `AgentSuspended` | agent_id, authority, timestamp | Agent suspended by authority |
| `AgentUnsuspended` | agent_id, authority, timestamp | Agent unsuspended by authority |
| `AgentDeregistered` | agent_id, authority, timestamp | Agent leaves protocol |
| `TaskCreated` | task_id, creator, required_capabilities, reward_amount, task_type, deadline, min_reputation, reward_mint, timestamp | New task posted |
| `DependentTaskCreated` | task_id, creator, depends_on, dependency_type, reward_mint, timestamp | Dependent task created |
| `TaskClaimed` | task_id, worker, current_workers, max_workers, timestamp | Worker claims task |
| `TaskCompleted` | task_id, worker, proof_hash, result_data, reward_paid, timestamp | Task finished |
| `TaskCancelled` | task_id, creator, refund_amount, timestamp | Task cancelled |
| `StateUpdated` | state_key, state_value, updater, version, timestamp | Shared state changed |
| `DisputeInitiated` | dispute_id, task_id, initiator, defendant, resolution_type, voting_deadline, timestamp | Dispute started |
| `DisputeVoteCast` | dispute_id, voter, approved, votes_for, votes_against, timestamp | Arbiter voted |
| `DisputeCancelled` | dispute_id, task, initiator, cancelled_at | Dispute cancelled |
| `DisputeResolved` | dispute_id, resolution_type, outcome, votes_for, votes_against, timestamp | Dispute concluded |
| `DisputeExpired` | dispute_id, task_id, refund_amount, creator_amount, worker_amount, timestamp | Dispute timed out |
| `ProtocolInitialized` | authority, treasury, dispute_threshold, protocol_fee_bps, timestamp | Protocol setup |
| `RewardDistributed` | task_id, recipient, amount, protocol_fee, timestamp | Payment sent |
| `RateLimitHit` | agent_id, action_type, limit_type, current_count, max_count, cooldown_remaining, timestamp | Rate limit triggered |
| `MigrationCompleted` | from_version, to_version, authority, timestamp | Version migration done |
| `ProtocolVersionUpdated` | old_version, new_version, min_supported_version, timestamp | Protocol upgraded |
| `BondDeposited` | agent, amount, new_total, timestamp | Speculation bond deposited |
| `BondLocked` | agent, commitment, amount, timestamp | Bond locked for commitment |
| `SpeculativeCommitmentCreated` | task, producer, result_hash, bonded_stake, expires_at, timestamp | Speculative commitment |
| `BondSlashed` | agent, commitment, amount, reason, timestamp | Bond slashed |
| `BondReleased` | agent, commitment, amount, timestamp | Bond released |
| `ArbiterVotesCleanedUp` | dispute_id, arbiter_count | Vote cleanup |
| `RateLimitsUpdated` | task_creation_cooldown, max_tasks_per_24h, ..., timestamp | Rate limits changed |
| `ProtocolFeeUpdated` | old_fee_bps, new_fee_bps, updated_by, timestamp | Fee changed |
| `ReputationChanged` | agent_id, old_reputation, new_reputation, reason, timestamp | Reputation updated |
| `GovernanceInitialized` | authority, voting_period, execution_delay, quorum_bps, approval_threshold_bps, timestamp | Governance setup |
| `ProposalCreated` | proposer, proposal_type, title_hash, voting_deadline, quorum, timestamp | Proposal created |
| `GovernanceVoteCast` | proposal, voter, approved, vote_weight, votes_for, votes_against, timestamp | Governance vote |
| `ProposalExecuted` | proposal, proposal_type, votes_for, votes_against, total_voters, timestamp | Proposal executed |
| `ProposalCancelled` | proposal, proposer, timestamp | Proposal cancelled |

**Dispute outcome constants:** `REJECTED=0`, `APPROVED=1`, `NO_VOTE_DEFAULT=2`
**Reputation reason constants:** `COMPLETION=0`, `DISPUTE_SLASH=1`, `DECAY=2`
**Event name format in TypeScript:** Use camelCase (e.g., `taskCompleted`, not `TaskCompleted`)

## TypeScript SDK

### Package Configuration

- **Version:** `1.3.0`
- **Build Tool:** `tsup` (outputs ESM + CJS dual build)
- **Test Framework:** `vitest`
- **Node:** `>=18.0.0`
- **Peer Dependencies:** `@coral-xyz/anchor >=0.29.0`, `@solana/web3.js >=1.90.0`, `@solana/spl-token >=0.4.0`

### Core Client

```typescript
import { PrivacyClient, PrivacyClientConfig } from '@agenc/sdk';
```

### Task Operations

```typescript
import { createTask, claimTask, completeTask, completeTaskPrivate, getTask } from '@agenc/sdk';
```

### ZK Proof Operations

```typescript
import { generateProof, verifyProofLocally, generateSalt, computeConstraintHash, computeCommitment } from '@agenc/sdk';
```

### SPL Token Support (NEW)

```typescript
import {
  deriveTokenEscrowAddress,
  isTokenTask,
  getEscrowTokenBalance,
  formatTokenAmount,
  getMintDecimals,
  TOKEN_PROGRAM_ID,
  ASSOCIATED_TOKEN_PROGRAM_ID,
} from '@agenc/sdk';
```

### Marketplace/Bidding Types (NEW)

```typescript
import {
  BidStatus,
  MatchingPolicy,
  WeightedScoreWeights,
  BPS_BASE,
  BID_ID_MAX_LENGTH,
  MARKETPLACE_ID_PATTERN,
} from '@agenc/sdk';
```

### Constants

```typescript
import { PROGRAM_ID, VERIFIER_PROGRAM_ID, PRIVACY_CASH_PROGRAM_ID, DEVNET_RPC, MAINNET_RPC } from '@agenc/sdk';

// Token-path CU budgets
RECOMMENDED_CU_CREATE_TASK_TOKEN = 100_000
RECOMMENDED_CU_COMPLETE_TASK_TOKEN = 100_000
RECOMMENDED_CU_COMPLETE_TASK_PRIVATE_TOKEN = 250_000
RECOMMENDED_CU_CANCEL_TASK_TOKEN = 80_000

// Tool timeouts
NARGO_EXECUTE_TIMEOUT_MS = 120_000
SUNSPOT_PROVE_TIMEOUT_MS = 300_000
```

### Path Validation (Single Source of Truth)

```typescript
import { validateCircuitPath } from './validation';
// Validates: directory traversal, absolute paths, shell metacharacters, length
```

## Agent Runtime

The `@agenc/runtime` package (~90k lines of TypeScript) provides comprehensive agent infrastructure.

### Package Configuration

- **Version:** `0.1.0`
- **Build Tool:** `tsup` (ESM + CJS, externals: openai, @anthropic-ai/sdk, ollama, better-sqlite3, ioredis, @solana/spl-token)
- **Test Framework:** `vitest` (~1800+ tests)
- **Node:** `>=18.0.0`
- **Peer Dependencies:** `@coral-xyz/anchor >=0.29.0`, `@solana/web3.js >=1.90.0`, `@solana/spl-token >=0.4.0`
- **Optional Dependencies:** openai, @anthropic-ai/sdk, ollama, better-sqlite3, ioredis

### Runtime Module Map

```
runtime/src/
├── Core
│   ├── runtime.ts          # AgentRuntime (lifecycle)
│   ├── builder.ts          # AgentBuilder (fluent API)
│   ├── idl.ts              # IDL + Program factories
│   ├── bin/                # CLI entry points (agenc-runtime, daemon)
│   ├── cli/                # CLI commands (health, onboard, replay, jobs, logs, sessions, security, skills, wizard, daemon)
│   ├── agent/              # AgentManager, events, PDA, capabilities
│   └── types/              # Errors (67 codes), wallet, protocol, config migration
│
├── Gateway (Persistent Agent Process)
│   ├── gateway/            # Gateway lifecycle, config watcher, WebSocket control plane
│   │                       # Sessions, workspace, scheduler (cron), heartbeat, hooks
│   │                       # Identity resolver, personality, media pipeline, approvals, slash commands
│   └── channels/           # Channel plugins (telegram/, discord/)
│
├── Task Execution
│   ├── task/               # Operations, discovery, speculative executor, proofs, DLQ
│   ├── autonomous/         # AutonomousAgent, scanner, verifier, risk scoring, arbitration
│   └── workflow/           # DAG orchestrator, goal compiler, optimizer, canary rollout
│
├── AI Integration
│   ├── llm/                # Grok, Anthropic, Ollama adapters + ChatExecutor + FallbackProvider
│   ├── tools/              # ToolRegistry, skill adapter, built-in AgenC tools, system tools (HTTP, filesystem, browser, bash)
│   ├── skills/             # SkillRegistry + Jupiter DEX + markdown loader + bundled skills + on-chain registry client + catalog
│   └── memory/             # InMemory, SQLite, Redis backends + structured memory, embeddings, graph, encryption
│
├── Protocol Operations
│   ├── dispute/            # DisputeOperations (6 instructions)
│   ├── governance/         # GovernanceOperations (5 instructions, PDA helpers)
│   ├── proof/              # ProofEngine (caching, stats)
│   └── events/             # Event subscriptions + parsing (35 event types)
│
├── Infrastructure
│   ├── connection/         # ConnectionManager (retry, failover, coalescing)
│   ├── replay/             # On-chain event timeline store (file, in-memory, SQLite), backfill, alerting
│   ├── telemetry/          # Unified metrics collection + sinks
│   ├── policy/             # PolicyEngine (budgets, circuit breakers, RBAC, audit trail)
│   └── marketplace/        # TaskBidMarketplace (matching, scoring)
│
├── Collaboration
│   ├── team/               # TeamContractEngine (payouts, audit, workflows)
│   └── eval/               # Benchmarks, mutation testing, trajectory replay
│
└── Utilities
    └── utils/              # Encoding, logger, PDA, query, treasury, lazy-import
```

### AgentRuntime & AgentManager

```typescript
import { AgentRuntime, AgentManager, AgentCapabilities } from '@agenc/runtime';

const runtime = new AgentRuntime({
  connection, wallet, capabilities: AgentCapabilities.COMPUTE | AgentCapabilities.INFERENCE,
  initialStake: 1_000_000_000n,
});
await runtime.start();
await runtime.stop();
```

### AgentBuilder (Fluent API)

```typescript
import { AgentBuilder } from '@agenc/runtime';

const agent = new AgentBuilder()
  .withConnection(connection)
  .withWallet(keypair)
  .withCapabilities(AgentCapabilities.COMPUTE)
  .withLLM('grok', { apiKey, model: 'grok-3' })
  .withMemory(memoryBackend)
  .withProofEngine(proofEngine)
  .withRpcEndpoints([url1, url2])
  .build();
```

### Autonomous Agent

```typescript
import { AutonomousAgent, type TaskExecutor } from '@agenc/runtime';

const agent = new AutonomousAgent({
  connection, wallet, capabilities, executor,
  taskFilter: { capabilities, minReward: 10_000_000n },
  discoveryMode: 'hybrid',    // 'polling' | 'events' | 'hybrid'
  scanIntervalMs: 5000,
  maxConcurrentTasks: 1,
  generateProofs: true,
});
```

**Advanced features:**
- Speculative execution with multi-level candidates
- Multi-candidate arbitration (verifier lanes)
- Adaptive risk budgeting
- Verifier escalation graphs
- Proof deferral for batching

### LLM Adapters (3 providers)

```typescript
import { GrokProvider, AnthropicProvider, OllamaProvider, LLMTaskExecutor } from '@agenc/runtime';
```

- **Grok:** Uses `openai` SDK (compatible API)
- **Anthropic:** Uses `@anthropic-ai/sdk`
- **Ollama:** Uses `ollama` package (local inference)
- Lazy SDK loading via shared `ensureLazyImport()`
- `responseToOutput()`: SHA-256 → 4 x 8-byte LE bigints (fits BN254 field)
- Tool call loop in executor (not adapters), up to `maxToolRounds` (default 10)

### Tool System

```typescript
import { ToolRegistry, createAgencTools, skillToTools } from '@agenc/runtime';

const registry = new ToolRegistry({ logger });
registry.registerAll(createAgencTools({ connection, logger }));
const llmTools = registry.toLLMTools();
const handler = registry.createToolHandler();
```

**Built-in AgenC tools:** `agenc.listTasks`, `agenc.getTask`, `agenc.getAgent`, `agenc.getProtocolConfig`
**System tools:** `createHttpTools` (fetch/POST with domain allow/deny), `createFilesystemTools` (8 secure file ops), `createBrowserTools` (Playwright-based fetch/extract/convert), `createBashTool` (command execution with allow/deny lists + execFile security)
**Critical:** Use `safeStringify()` for any data with bigint (JSON.stringify throws).

### Memory Backends

```typescript
import { InMemoryBackend, SqliteBackend, RedisBackend } from '@agenc/runtime';
```

- **InMemory:** Zero deps, Map-based, lazy TTL expiry, capacity limits
- **SQLite:** Optional `better-sqlite3`, WAL mode, prepared statements
- **Redis:** Optional `ioredis`, sorted sets, native PEXPIRE
- Interface: thread ops + KV ops + lifecycle
- **Structured memory:** Daily logs, curated facts, entity extraction
- **Embeddings:** Multi-provider (OpenAI, Ollama, Noop) embedding generation
- **Memory graph:** Node/edge graph with provenance tracking
- **Encryption:** AES-256-GCM memory encryption provider

### ProofEngine

```typescript
import { ProofEngine } from '@agenc/runtime';

const engine = new ProofEngine({
  proverEndpoint: './circuits-circuit/task_completion',
  verifyAfterGeneration: false,
  cache: { ttlMs: 300_000, maxEntries: 100 },
});
```

### DisputeOperations

```typescript
import { DisputeOperations, deriveDisputePda, deriveVotePda } from '@agenc/runtime';
```

- Wraps 6 on-chain dispute instructions
- Treasury caching, memcmp-filtered queries
- `DISPUTE_STATUS_OFFSET = 169`, `DISPUTE_TASK_OFFSET = 40`

### Workflow DAG Orchestrator

```typescript
import { DAGOrchestrator } from '@agenc/runtime';
```

- Tree topology (single parent per task)
- `validateWorkflow()`: cycle detection, multi-parent rejection
- `topologicalSort()`: Kahn's algorithm
- Goal compiler: LLM-to-workflow compilation
- Workflow optimizer: mutation-based optimization with canary rollout

### ConnectionManager

```typescript
import { ConnectionManager } from '@agenc/runtime';
```

- Patches `Connection._rpcRequest` for transparent retry/failover
- Reads: full retry with exponential backoff + request coalescing
- Writes: NO retry, only failover on connection-level errors
- Health tracking: cooldown-based auto-recovery

### Marketplace

```typescript
import { TaskBidMarketplace, ConservativeBidStrategy, BalancedBidStrategy } from '@agenc/runtime';
```

- Task bid order book with matching engine
- Weighted scoring for bid ranking
- Automated bidding strategies

### Team Contracts

```typescript
import { TeamContractEngine, computeTeamPayout, TeamWorkflowAdapter } from '@agenc/runtime';
```

- Multi-member task coordination
- Payout models: Fixed, Weighted, Milestone-based
- Audit trail storage

### Policy Engine

```typescript
import { PolicyEngine } from '@agenc/runtime';
```

- Budget enforcement (per-action, per-epoch, total)
- Circuit breaker modes: fail-open, fail-closed
- Access control for sensitive operations

### Skills Registry

```typescript
import { SkillRegistry, JupiterSkill, SkillDiscovery, OnChainSkillRegistryClient } from '@agenc/runtime';
```

- Pluggable skill system with SKILL.md markdown format
- Jupiter DEX integration (swaps, transfers, token queries)
- Skill discovery: auto-scan bundled, workspace, and installed skills
- On-chain skill registry client (publish, search, download, verify)
- Bundled starter skills (8 SKILL.md templates)
- Plugin catalog for channel plugins

### Telemetry

```typescript
import { UnifiedTelemetryCollector, NoopTelemetryCollector } from '@agenc/runtime';
```

- Unified metrics collection across all subsystems
- Pluggable sinks (console, callback)
- Histogram, counter, gauge types

### Evaluation & Mutation Testing

```typescript
import { BenchmarkRunner, MutationRunner, TrajectoryRecorder, TrajectoryReplayEngine } from '@agenc/runtime';
```

- Deterministic benchmark corpus
- Mutation testing with regression gates
- Trajectory recording and replay for agent decision auditing

### Gateway (Persistent Agent Process)

```typescript
import { Gateway, ConfigWatcher, SessionManager, SlashCommandRegistry } from '@agenc/runtime';
```

- Persistent agent gateway with WebSocket control plane
- Config watcher with hot-reload and diff detection
- Session management with compaction strategies
- Workspace model: per-agent workspace with tool policies
- Slash command registry with built-in default commands
- Cron scheduler for heartbeat/scheduled jobs
- Lifecycle hooks (pre/post message, error handling)
- Media pipeline (audio transcription, image description)
- Identity resolver for cross-channel account linking
- Personality templates (loadable agent personality configs)
- Daemon manager (PID files, systemd/launchd unit generation)
- Approval system for sensitive operations

### Channel Plugins

```typescript
import { TelegramChannel, DiscordChannel } from '@agenc/runtime';
```

- **Telegram:** Bot API integration with webhook support
- **Discord:** Bot integration with configurable intents

### Governance Operations

```typescript
import { GovernanceOperations, deriveProposalPda, deriveGovernanceVotePda } from '@agenc/runtime';
```

- Wraps 5 on-chain governance instructions (initialize, create/vote/execute/cancel proposal)
- `PROPOSAL_STATUS_OFFSET` for memcmp-filtered queries
- PDA derivation for governance config, proposals, and votes

### Replay (Event Timeline)

```typescript
import { InMemoryReplayTimelineStore, FileReplayTimelineStore, ReplayBackfillService, ReplayAlertDispatcher } from '@agenc/runtime';
```

- On-chain event timeline store (file, in-memory, SQLite backends)
- Backfill service for historical event ingestion
- Alert dispatcher with pluggable adapters and severity levels
- Event bridge connecting live subscriptions to replay store

### Runtime CLI

The runtime exposes CLI commands via `agenc-runtime` / `agenc` binary:

| Command | Purpose |
|---------|---------|
| `health` | Agent health check |
| `onboard` | Agent onboarding wizard |
| `replay` | Event replay operations |
| `jobs` | Scheduled job management |
| `logs` | Log viewing |
| `sessions` | Session management |
| `security` | Security checks |
| `skills` | Skill management (list, info, validate, create, install, uninstall, enable, disable) |
| `wizard` | Gateway config init/validate/show |
| `daemon` | Daemon lifecycle management |

### LLM Extensions

```typescript
import { ChatExecutor, FallbackLLMProvider } from '@agenc/runtime';
```

- **ChatExecutor:** Multi-turn chat with token budget enforcement, skill injection, and memory retrieval
- **FallbackLLMProvider:** Automatic failover across multiple LLM providers

### Capabilities (Bitmask)

```typescript
import { AgentCapabilities, hasCapability, getCapabilityNames } from '@agenc/runtime';

AgentCapabilities.COMPUTE     // 1n << 0n
AgentCapabilities.INFERENCE   // 1n << 1n
AgentCapabilities.STORAGE     // 1n << 2n
AgentCapabilities.NETWORK     // 1n << 3n
AgentCapabilities.SENSOR      // 1n << 4n
AgentCapabilities.ACTUATOR    // 1n << 5n
AgentCapabilities.COORDINATOR // 1n << 6n
AgentCapabilities.ARBITER     // 1n << 7n
AgentCapabilities.VALIDATOR   // 1n << 8n
AgentCapabilities.AGGREGATOR  // 1n << 9n
```

### Error Classes

67 `RuntimeErrorCodes` organized by category:

| Category | Codes | Examples |
|----------|-------|---------|
| Core | 16 | AgentNotRegistered, ValidationError, InsufficientStake, ClaimExpired, RetryExhausted |
| LLM | 5 | LLMProviderError, LLMRateLimit, LLMResponseConversion, LLMToolCallError, LLMTimeout |
| Memory | 3 | MemoryBackendError, MemoryConnectionError, MemorySerializationError |
| Proof | 3 | ProofGenerationError, ProofVerificationError, ProofCacheError |
| Dispute | 4 | DisputeNotFound, DisputeVoteError, DisputeResolutionError, DisputeSlashError |
| Workflow | 4 | WorkflowValidation, WorkflowSubmission, WorkflowMonitoring, WorkflowState |
| Team | 4 | TeamContractValidation, TeamContractState, TeamPayout, TeamWorkflowTopology |
| Marketplace | 4 | MarketplaceValidation, MarketplaceState, MarketplaceAuthorization, MarketplaceMatching |
| Connection | 2 | ConnectionError, AllEndpointsUnhealthy |
| Telemetry | 1 | TelemetryError |
| Gateway | 5 | GatewayValidation, GatewayConnection, GatewayState, GatewayLifecycle, WorkspaceValidation |
| Chat | 1 | ChatBudgetExceeded |
| Governance | 3 | GovernanceProposalNotFound, GovernanceVoteError, GovernanceExecutionError |
| Identity | 5 | IdentityLinkExpired, IdentityLinkNotFound, IdentitySelfLink, IdentitySignatureInvalid, IdentityValidationError |
| Heartbeat | 3 | HeartbeatStateError, HeartbeatActionFailed, HeartbeatTimeout |
| Skills | 4 | SkillRegistryNotFound, SkillDownloadError, SkillVerificationError, SkillPublishError |

## MCP Server

The `@agenc/mcp` package exposes protocol operations as MCP tools for AI assistants.

### Tools Exposed

| Category | Tools |
|----------|-------|
| Connection | `agenc_set_network`, `agenc_get_balance`, `agenc_airdrop` |
| Agents | `agenc_register_agent`, `agenc_get_agent`, `agenc_list_agents`, `agenc_decode_capabilities` |
| Tasks | `agenc_get_task`, `agenc_list_tasks`, `agenc_get_escrow`, `agenc_create_task`, `agenc_claim_task`, `agenc_complete_task`, `agenc_cancel_task` |
| Protocol | `agenc_get_protocol_config`, `agenc_derive_pda`, `agenc_decode_error`, `agenc_get_program_info` |
| Disputes | `agenc_get_dispute`, `agenc_list_disputes` |
| Circuits | ZK circuit compilation, proof generation/verification |
| Testing | Mutation testing tools |
| Inspector | On-chain account inspection |
| Replay | `agenc_replay_backfill`, `agenc_replay_compare`, `agenc_replay_incident` (require `MCP_OPERATOR_ROLE`) |

### Usage

```bash
claude mcp add agenc-dev -- node /path/to/AgenC/mcp/dist/index.js
# Or with env vars
claude mcp add agenc-dev \
  -e SOLANA_RPC_URL=http://localhost:8899 \
  -e SOLANA_KEYPAIR_PATH=~/.config/solana/id.json \
  -- node /path/to/AgenC/mcp/dist/index.js
```

### Dependencies

- `@modelcontextprotocol/sdk ^1.6.1`
- `zod ^3.24.2`
- `@agenc/sdk` + `@agenc/runtime` (local)

## Zero-Knowledge Circuits

### Technology Stack

| Layer | Technology | Purpose |
|-------|------------|---------|
| Circuit | Noir | ZK circuit definition |
| Prover | Sunspot (Groth16) | Off-chain proof generation |
| Verifier | verifier-router | On-chain proof verification |
| Hash | Poseidon2 | ZK-friendly hashing |
| Ceremony | risc0-host-prover | MPC trusted setup |

**Verifier Program ID:** `8fHUGmjNzSh76r78v1rPt7BhWmAu2gXrvW9A2XXonwQQ`
**Expected Proof Size:** 256 bytes (Groth16)
**Public Inputs Count:** 67

### Proof Flow

```
1. Agent computes task output locally
2. Agent generates Noir proof via risc0-host-prover/risc0-host-prover
3. Agent submits proof on-chain via complete_task_private
4. On-chain validates: binding, commitment, constraint hash, nullifier uniqueness
5. Groth16 verifier validates proof (~100-130k CU)
6. If valid, agent receives reward without revealing output
```

### Verifying Key Security

- `VK_GAMMA_G2 != VK_DELTA_G2` (gamma == delta means forgeable proofs)
- Production deployment REQUIRES MPC ceremony with >= 3 contributors
- Validation: `./scripts/validate-verifying-key.sh`

## Code Style

- **Rust**: Anchor framework conventions, `cargo fmt` + `cargo clippy`
- **TypeScript**: Strict mode, ESM and CJS dual builds, 2-space indentation

### Naming Conventions

| Language | Type | Convention | Example |
|----------|------|------------|---------|
| Rust | Types | `PascalCase` | `AgentRegistration`, `TaskStatus` |
| Rust | Functions | `snake_case` | `register_agent`, `complete_task` |
| TypeScript | Types | `PascalCase` | `PrivacyClient`, `TaskParams` |
| TypeScript | Functions | `camelCase` | `generateProof`, `createTask` |

## Error Handling

### Anchor Program (CoordinationError)

Source of truth: `programs/agenc-coordination/src/errors.rs`.

- Total variants: 161 (codes `6000-6160`)
- Anchor assigns codes sequentially by enum position: `code = 6000 + index`
- The "range" comments in `errors.rs` are organizational and may be stale

When you need an exact code, compute it from the enum order rather than relying on comments or external tables.

The runtime's `AnchorErrorCodes` mapping (`runtime/src/types/errors.ts`) is intentionally partial and may drift; prefer the Rust source.

Quick sanity check:

```bash
rg -n '^\\s{4}[A-Z][A-Za-z0-9_]*,\\s*$' programs/agenc-coordination/src/errors.rs | wc -l
```

## Recent Issue Closure (959-999)

See `docs/ISSUES_959_999.md` for the issue-to-PR mapping and closure dates.

## Key Design Patterns

### PDA Seeds (Anchor)

```rust
["protocol"]                          // Protocol config (singleton)
["agent", agent_id]                   // Agent registration
["task", creator, task_id]            // Task
["escrow", task_pda]                  // Task escrow
["claim", task_pda, worker_pda]       // Worker claim
["dispute", dispute_id]               // Dispute
["vote", dispute_pda, voter]          // Dispute vote
["state", key]                        // Shared state
["nullifier", nullifier]              // ZK proof nullifier
["governance"]                        // Governance config (singleton)
["proposal", proposer, nonce]         // Governance proposal
["gov_vote", proposal_pda, voter]     // Governance vote
```

### Anchor IDL Type Handling (CRITICAL)

Anchor generates two files with different naming:
- `agenc_coordination.json` (snake_case) - Runtime IDL data
- `agenc_coordination.ts` (camelCase) - TypeScript type helper only

**CORRECT:** Use `Idl` type for raw JSON, `AgencCoordination` for `Program<T>` generics:
```typescript
export const IDL: Idl = idlJson as Idl;  // Generic Idl for snake_case JSON
export function createProgram(provider, programId?): Program<AgencCoordination> { ... }
```

## Configuration

### Agent Capabilities (Bitmask)

```rust
COMPUTE = 1 << 0, INFERENCE = 1 << 1, STORAGE = 1 << 2, NETWORK = 1 << 3,
SENSOR = 1 << 4, ACTUATOR = 1 << 5, COORDINATOR = 1 << 6, ARBITER = 1 << 7,
VALIDATOR = 1 << 8, AGGREGATOR = 1 << 9
```

### Task Types

```rust
Exclusive = 0     // Single worker claims
Collaborative = 1 // Multiple workers contribute
Competitive = 2   // First completion wins
```

### Account Status Enums

```rust
// AgentStatus
Inactive = 0, Active = 1, Busy = 2, Suspended = 3

// TaskStatus
Open = 0, InProgress = 1, PendingValidation = 2, Completed = 3, Cancelled = 4, Disputed = 5

// ResolutionType
Refund = 0, Complete = 1, Split = 2

// DisputeStatus
Active = 0, Resolved = 1, Expired = 2
```

### Compute Unit Budgets

```typescript
RECOMMENDED_CU_REGISTER_AGENT = 40_000
RECOMMENDED_CU_CREATE_TASK = 50_000
RECOMMENDED_CU_CREATE_TASK_TOKEN = 100_000
RECOMMENDED_CU_CLAIM_TASK = 30_000
RECOMMENDED_CU_COMPLETE_TASK = 60_000
RECOMMENDED_CU_COMPLETE_TASK_TOKEN = 100_000
RECOMMENDED_CU_COMPLETE_TASK_PRIVATE = 200_000
RECOMMENDED_CU_COMPLETE_TASK_PRIVATE_TOKEN = 250_000
RECOMMENDED_CU_CANCEL_TASK = 40_000
RECOMMENDED_CU_CANCEL_TASK_TOKEN = 80_000
RECOMMENDED_CU_INITIATE_DISPUTE = 50_000
RECOMMENDED_CU_VOTE_DISPUTE = 30_000
RECOMMENDED_CU_RESOLVE_DISPUTE = 60_000
```

### Fee Tier Constants

```typescript
FEE_TIERS = [
  [0, 0],       // Base: no discount
  [50, 10],     // Bronze: 10 bps after 50 tasks
  [200, 25],    // Silver: 25 bps after 200 tasks
  [1000, 40],   // Gold: 40 bps after 1000 tasks
]
```

## Testing

### Test Infrastructure

Tests use LiteSVM for ~50x speedup vs solana-test-validator (PR #866).

**Key files:**

| File | Purpose |
|------|---------|
| `tests/litesvm-helpers.ts` | Core adapter: `createLiteSVMContext()`, `fundAccount()`, `advanceClock()`, `getClockTimestamp()` |
| `tests/test-utils.ts` | **Single source of truth** for all constants (capabilities, task types, PDA helpers) |
| `tests/test-setup.ts` | Shared before/beforeEach lifecycle hooks (DRY) |
| `tests/test_1.ts` | Main integration suite (140 tests) |
| `tests/dispute-slash-logic.ts` | Dispute slashing tests |
| `tests/spl-token-tasks.ts` | SPL token escrow tests |
| `tests/governance.ts` | Governance integration tests |
| `tests/lifecycle-guards.ts` | Lifecycle guard tests |
| `tests/litesvm-poc.ts` | 13 PoC tests validating LiteSVM API |
| `tests/rate-limiting.ts` | Rate limiting tests |
| `tests/coordination-security.ts` | Security tests |
| `tests/sybil-attack.ts` | Sybil attack resistance tests |

**LiteSVM Critical Gotchas:**
- Clock doesn't advance automatically — need `advanceClock(svm, 61)` before `updateAgent` (60s cooldown)
- Use `getClockTimestamp(svm)` not `Date.now()` for deadline calculations (clock drift accumulates)
- `svm.withDefaultPrograms()` required for SPL token tests
- BN.js has precision bug with u64::MAX — verify via raw bytes not decimal string

**Test commands:**
```bash
npm run test:fast           # LiteSVM tests (~5s)
npm run test                # SDK + runtime vitest suites
cd runtime && npm run test  # Runtime only (~1800+ tests)
```

### Test Constants (from test-utils.ts)

```typescript
CAPABILITY_COMPUTE = 1 << 0, CAPABILITY_INFERENCE = 1 << 1, // etc.
TASK_TYPE_EXCLUSIVE = 0, TASK_TYPE_COLLABORATIVE = 1, TASK_TYPE_COMPETITIVE = 2
RESOLUTION_TYPE_REFUND = 0, RESOLUTION_TYPE_COMPLETE = 1, RESOLUTION_TYPE_SPLIT = 2
```

**PDA helpers** (all take `programId` parameter):
`deriveProtocolPda`, `deriveAgentPda`, `deriveTaskPda`, `deriveEscrowPda`, `deriveClaimPda`, `deriveDisputePda`, `deriveVotePda`, `deriveProgramDataPda`

### Mutation Testing & Regression Gates

The evaluation module (`runtime/src/eval/`) provides:
- **Benchmark runner:** Deterministic corpus-based scenario execution
- **Mutation engine:** Mutation operators for robustness testing
- **Mutation gates:** Regression checks enforced in CI

**Gate thresholds (in CI):**
```
MUTATION_MAX_AGGREGATE_PASS_RATE_DROP = 0.60
MUTATION_MAX_AGGREGATE_CONFORMANCE_DROP = 0.35
MUTATION_MAX_AGGREGATE_COST_UTILITY_DROP = 0.45
MUTATION_MAX_SCENARIO_PASS_RATE_DROP = 1.00
MUTATION_MAX_OPERATOR_PASS_RATE_DROP = 0.60
```

## CI/CD Pipeline

GitHub Actions workflow (`.github/workflows/ci.yml`):

| Job | Trigger | Purpose |
|-----|---------|---------|
| `runtime_checks` | push/PR | Install deps, runtime tests, typecheck, build, MCP typecheck + tests |
| `reliability_regression` | push/PR (after runtime_checks) | Benchmark corpus, mutation suite, enforce mutation gates, upload artifacts |
| `nightly_reliability` | Daily 6 AM UTC | Nightly benchmarks + mutations, dry-run gates, 30-day artifact retention |

**Environment:** Node 20

## Common Pitfalls

### Anchor 0.32 Compatibility

```typescript
// Use .accountsPartial() for optional accounts
await program.methods.resolveDispute().accountsPartial({ worker: null }).rpc();

// Event names are camelCase
program.addEventListener('taskCompleted', callback);
```

### Test Logic Errors

```typescript
// WRONG: Modifying local copy has no on-chain effect
const agent = await program.account.agentRegistration.fetch(agentPda);
agent.activeTasks = 10;  // Only changes local JS object!

// RIGHT: Use program instructions to modify on-chain state
await program.methods.updateAgent(...).rpc();
```

### Keypair Reuse in Tests

```typescript
// WRONG: Creating new keypair loses authority
const worker = Keypair.generate();  // Different each time!

// RIGHT: Store and reuse keypairs across test blocks
let workerKeypair: Keypair;
before(() => { workerKeypair = Keypair.generate(); });
```

## Security Patterns

### Critical Invariants

| Invariant | Location | Description |
|-----------|----------|-------------|
| Competitive task single-completion | `complete_task.rs`, `complete_task_private.rs` | Check `task.completions == 0` before paying |
| Account owner validation | `resolve_dispute.rs` | Validate `account.owner == crate::ID` before deserializing `remaining_accounts` |
| Constraint hash binding | `complete_task_private.rs` | ZK proofs verify `proof.constraint_hash == task.constraint_hash` |
| Proof nullifier uniqueness | `complete_task_private.rs` | Nullifier PDA via `init` prevents proof reuse |
| Proof binding non-zero | `complete_task_private.rs` | `expected_binding` and `output_commitment` must not be all zeros |
| Verifying key integrity | `legacy-verifier-key.rs` | `VK_GAMMA_G2 != VK_DELTA_G2` |
| Rate limit enforcement | `create_task.rs`, `initiate_dispute.rs` | Check cooldown and 24h limits |

### Security Audit Checklist

When modifying instruction handlers, verify:
- [ ] Account ownership validated for `remaining_accounts`
- [ ] Competitive task completion check present
- [ ] Arithmetic uses `checked_*` operations
- [ ] Rate limits enforced where applicable
- [ ] Events emitted for state changes
- [ ] PDA seeds match expected format
- [ ] Signer constraints properly applied
- [ ] Version compatibility checked
- [ ] ZK proof nullifier checked (for private completion paths)
- [ ] Verifying key security validated before deployment

## Anchor Configuration

```toml
[toolchain]
anchor_version = "0.32.1"
solana_version = "3.0.13"

[test]
startup_wait = 120000
shutdown_wait = 5000
upgradeable = true

[scripts]
test = "npx ts-mocha -p ./tsconfig.json -t 300000 tests/test_1.ts tests/dispute-slash-logic.ts tests/spl-token-tasks.ts tests/lifecycle-guards.ts tests/governance.ts"
```

## Build Scripts

| Script | Purpose |
|--------|---------|
| `scripts/simulate_upgrade.sh` | Protocol upgrade simulation |
| `scripts/check-deployment-readiness.sh` | Pre-deployment validation |
| `scripts/validate-verifying-key.sh` | Verifying key gamma != delta check |
| `scripts/check-breaking-changes.ts` | Check for breaking API changes |
| `scripts/check-docs-links.sh` | Validate documentation links |
| `scripts/deploy-verifier.sh` | Deploy verifier program |
| `scripts/setup-dev.sh` | Developer environment setup |
| `scripts/smoke-test-examples.sh` | Smoke test example projects |
| `scripts/validate-env.sh` | Validate environment configuration |
| `runtime/scripts/run-benchmarks.ts` | Run deterministic benchmark corpus |
| `runtime/scripts/run-mutations.ts` | Run mutation test suite |
| `runtime/scripts/check-mutation-gates.ts` | Check mutation regression gates |

## Environment Variables

| Variable | Used In | Purpose |
|----------|---------|---------|
| `VITE_SOLANA_RPC_URL` | demo-app | Custom RPC endpoint |
| `HELIUS_API_KEY` | examples/helius-webhook | Helius API authentication |
| `SOLANA_RPC_URL` | mcp | MCP server RPC endpoint |
| `SOLANA_KEYPAIR_PATH` | mcp | MCP server keypair path |
| `MCP_OPERATOR_ROLE` | mcp | Operator role for replay tools (read|investigate|execute|admin) |
| `NODE_ENV` | sdk | Production mode (placeholder functions throw) |
| `MUTATION_MAX_*` | CI | Mutation regression gate thresholds |

## Roadmap Development Workflow

58 implementation issues (#1051-#1110) across 10 phases, tracked on a [GitHub Project kanban board](https://github.com/orgs/tetsuo-ai/projects/9). Architecture docs live in `docs/architecture/` and a docs-mcp server provides AI-assisted implementation context per issue.

### Kanban Columns

| Column | Meaning | Rule |
|--------|---------|------|
| Backlog | Has unmet dependencies | Do NOT pick up |
| Ready | All dependencies met | Safe to start |
| In Progress | Actively being worked on | Assign yourself |
| In Review | PR is open | Awaiting review |
| Done | Merged | Verified complete |

Each issue also carries **Phase** (1-10), **Priority** (P0-P3), and **Scope** (S/M/L) fields.

### Workflow Rules

1. **Only pick issues from Ready.** Backlog issues have unmet dependencies and will fail or create merge conflicts.
2. **After completing an issue**, move it to Done, then check its "Depended By" list. For each downstream issue, if ALL its dependencies are now Done, move it Backlog → Ready.
3. **Assign yourself** when moving something to In Progress.
4. **One issue per PR.** Keep PRs focused on a single issue.

### Docs MCP Server

The `agenc-docs` MCP server provides implementation context for any roadmap issue. Available tools:

| Tool | Purpose |
|------|---------|
| `docs_search` | Full-text search across architecture docs |
| `docs_get_issue_context` | Full implementation context for a specific issue (files, dependencies, patterns, interfaces) |
| `docs_get_phase_graph` | Mermaid dependency graph + recommended build order for a phase |
| `docs_get_module_template` | Boilerplate for creating a new runtime module |
| `docs_get_module_info` | Architecture details about an existing module |
| `docs_get_conventions` | Type, testing, and error handling conventions |

### Architecture Docs

Located in `docs/architecture/`:

| Doc | Content |
|-----|---------|
| `overview.md` | System component diagram (5 packages) |
| `runtime-layers.md` | 7-layer module dependency diagram |
| `interfaces.md` | Key interface class diagrams |
| `flows/` | 7 sequence/state diagrams (task lifecycle, disputes, ZK proofs, etc.) |
| `guides/` | 5 implementation guides (module template, types, testing, errors, integration) |
| `phases/` | 10 phase guides with per-issue breakdowns |
| `issue-map.json` | Machine-readable index of all 58 issues with code locations and dependencies |

### Issue Body Structure

Each issue contains: **Goal** (what to build), **Files to create/modify** (exact paths), **Depends on** (prerequisite issues), **Depended by** (issues this unblocks), **Existing patterns** (files to read for conventions), **Key interfaces** (TypeScript sketches), **Testing strategy**, and **Scope estimate** (S/M/L).
