# Tech Debt Report - 2026-02-15 (Full Codebase Scan)

## Summary

| Category | Count |
|----------|-------|
| Critical | 3 |
| High | 9 |
| Medium | 15 |
| Low | 10 |
| **Total** | **37** |
| Estimated duplicated lines | ~2,000+ |
| Files affected | ~40+ |

---

## Critical (Fix Now)

| # | Issue | Location | Impact | Suggested Fix |
|---|-------|----------|--------|---------------|
| 1 | Silent error swallowing — checkpoint removal failures ignored | `runtime/src/task/executor.ts:520` | Stale checkpoints, duplicate task execution | Add `.catch(err => logger.warn(...))` |
| 2 | `resolve_dispute.rs` handler — 431 lines, 16 nesting levels | `programs/.../instructions/resolve_dispute.rs:118-548` | Maintenance nightmare, high bug risk | Extract `resolve_refund_approved()`, `resolve_complete_approved()`, `resolve_split_approved()`, `resolve_rejected()` |
| 3 | `toNumber()`/`toBigInt()` duplicated in 8+ files | `sdk/src/agents.ts`, `protocol.ts`, `state.ts`, `disputes.ts`, `proof-validation.ts`, `runtime/src/agent/types.ts`, `team/payout.ts`, `types/protocol.ts` | 100+ call sites, divergence risk | Extract to shared `sdk/src/utils/conversion.ts`, import everywhere |

---

## High (Fix This Sprint)

| # | Issue | Location | Impact | Suggested Fix |
|---|-------|----------|--------|---------------|
| 1 | Inconsistent account-not-found error detection | SDK uses `'could not find account'`, runtime uses `'could not find'` | Silent misclassification of errors | Create shared `isAccountNotFoundError()` helper |
| 2 | Dead function `buildTokenAccounts` (22 lines) | `sdk/src/tasks.ts:190-211` | Dead code | Remove or wire into `createTask`/`completeTask` |
| 3 | `AccountFetcher`/`getAccount` exact duplication (18 lines) | `sdk/src/tasks.ts:34-49` + `sdk/src/queries.ts:167-185` | Dual maintenance | Extract to `sdk/src/internal/anchor-utils.ts` |
| 4 | Dispute remaining_accounts processing (~400 lines duplicated) | `resolve_dispute.rs`, `expire_dispute.rs`, `apply_dispute_slash.rs` | Identical account parsing repeated 3x | Extract `RemainingAccountsProcessor` struct |
| 5 | Dead privacy module — depends on uninstalled package | `sdk/src/privacy.ts` (entire file) + export in `index.ts:11` | Misleading export, runtime failure | Remove or move to `examples/` |
| 6 | Token account building pattern repeated 4x (60+ lines) | `sdk/src/tasks.ts` (4 functions) | Duplication | Use existing `buildTokenAccounts` or extract shared helper |
| 7 | Config path resolution duplicated (drift risk) | `runtime/src/cli/index.ts`, `health.ts`, `onboard.ts` | 3 slightly different implementations | Extract to `runtime/src/cli/config-path.ts` |
| 8 | `mcp/src/tools/replay.ts` — 1,594 lines, multiple responsibilities | `mcp/src/tools/replay.ts` | God object: dispute exec + incidents + narrative | Split into `replay-executor.ts`, `replay-narrator.ts`, `replay-incidents.ts` |
| 9 | Suspend/Unsuspend agents — near-identical handlers (~100 lines) | `suspend_agent.rs`, `unsuspend_agent.rs` | Near-identical Anchor handlers | Extract shared `toggle_agent_suspension()` function |

---

## Medium (Backlog)

| # | Issue | Location | Impact | Suggested Fix |
|---|-------|----------|--------|---------------|
| 1 | PDA derive/find wrappers duplicated (~170 lines) | `runtime/src/agent/pda.ts`, `task/pda.ts`, `dispute/pda.ts` + 6 inline | Pattern duplication | Create generic `createPdaDeriver()` factory |
| 2 | Memcmp query pattern duplicated (~82 lines) | `task/operations.ts:171-210`, `dispute/operations.ts:160-208` | Same try-memcmp-fallback pattern 3x | Extract `fetchWithMemcmpFallback<T>()` |
| 3 | `toUint8Array()` duplicated 5x (30 lines total) | `agent/events.ts`, `agent/types.ts`, `events/parse.ts`, `task/types.ts`, `dispute/types.ts` | Divergence risk (dispute version differs) | Consolidate in `utils/encoding.ts` |
| 4 | Logger duplicated across SDK & runtime (~90 lines each) | `sdk/src/logger.ts` + `runtime/src/utils/logger.ts` | Updates must be made twice | Re-export from SDK or extract shared package |
| 5 | Dead code: `ProofTimeEstimator` | `runtime/src/task/proof-time-estimator.ts` | Exported but never imported | Remove file and barrel export |
| 6 | No-op stub method `addDependency()` | `runtime/src/task/speculative-scheduler.ts:481-498` | Public method with 2 unused params, logs warning | Implement or remove |
| 7 | Worker active_tasks decrement duplicated (7 sites, ~70 lines) | `cancel_task.rs`, `complete_task.rs`, `expire_claim.rs`, `resolve_dispute.rs`, `expire_dispute.rs` | Identical validate-deserialize-decrement pattern | Add `decrement_worker_active_tasks()` to `completion_helpers.rs` |
| 8 | Task status parsing duplicated (40+ lines) | `sdk/src/tasks.ts` (`getTask` + `getTasksByCreator`) | Same parse logic repeated | Extract `parseTaskAccount()` helper |
| 9 | `Option<Pubkey>` filter buffer built 3x | `sdk/src/queries.ts:217-220, 267-269, 331-333` | Same buffer logic repeated | Extract `buildOptionPubkeyFilter()` |
| 10 | `autonomous/agent.ts` — 1,485 lines, 30+ methods | `runtime/src/autonomous/agent.ts` | Too many responsibilities | Extract `AutonomousTaskOrchestrator` + `ExecutionEventBus` |
| 11 | `agent/manager.ts` — 1,174 lines | `runtime/src/agent/manager.ts` | Lifecycle + protocol caching mixed | Extract `ProtocolConfigCache` to separate class |
| 12 | Memory TTL constants duplicated + inconsistent | `autonomous/agent.ts:98`, `llm/executor.ts:20`, `memory/graph.ts:14` | Two identical defs, formula vs pre-computed | Centralize in `runtime/src/types/config.ts` |
| 13 | `BPS_BASE` vs `BASIS_POINTS_DIVISOR` — same value, different names | `sdk/src/bids.ts:7` + `sdk/src/constants.ts:132` | Inconsistent naming | Consolidate to single name |
| 14 | Account offset magic numbers undocumented | `runtime/src/dispute/types.ts` (169, 40) | No explanation of derivation | Add calculation formula comments |
| 15 | Audit trail in-memory only — not persisted | `runtime/src/policy/audit-trail.ts` | Limited operational usefulness | Add pluggable store (file/sqlite) |

---

## Low (Opportunistic)

| # | Issue | Location | Impact | Suggested Fix |
|---|-------|----------|--------|---------------|
| 1 | Event subscription boilerplate (~350+ lines) | `runtime/src/events/{task,dispute,protocol}.ts` (12+ fns) | Near-identical callback wrapping | Create generic `createEventSubscriber<T>()` factory |
| 2 | Error class boilerplate (~400-500 lines) | 11+ error files in `runtime/src/` | Repetitive constructor pattern | Consider error class factory |
| 3 | Lazy-import wrappers duplicated (~22 lines) | `llm/lazy-import.ts` + `memory/lazy-import.ts` | Harmless but unnecessary | Create single factory in `utils/lazy-import.ts` |
| 4 | Magic numbers in speculation config | `task/speculative-scheduler.ts:178-191` | Hardcoded depth=3, stake=10 SOL | Extract to `task/constants.ts` |
| 5 | Magic numbers in proof pipeline | `task/proof-pipeline.ts:150-159` | maxConcurrentProofs=4, timeout=60s | Extract to constants |
| 6 | Silent error in `verifyProofLocally` | `sdk/src/proofs.ts:354-357` | Hides genuine errors as "invalid proof" | Catch specific snarkjs errors |
| 7 | `EXPECTED_PROOF_SIZE` mismatch (256 vs 388) | `tests/complete_task_private.ts:39` vs `tests/zk-proof-lifecycle.ts:46` | Inconsistent test expectations | Investigate 388 value, standardize to SDK constant |
| 8 | Deprecated `VERIFICATION_COMPUTE_UNITS` still exported | `sdk/src/constants.ts:54` | Dead weight | Remove in next major version |
| 9 | Hardcoded byte length 32 not using constants | `dispute/operations.ts:279-281` and others | Magic number | Use `ID_LENGTH_BYTES` constant |
| 10 | `deserializeTaskAccount` — 105 lines of repetitive field reads | `sdk/src/queries.ts:393-497` | Long function | Consider schema-driven approach |

---

## Duplications Found

| Pattern | Locations | Lines | Refactor To |
|---------|-----------|-------|-------------|
| `toNumber()`/`toBigInt()` | 8 files (SDK + runtime) | ~130 | Shared `utils/conversion.ts` |
| Dispute remaining_accounts processing | 3 Rust files | ~400 | `RemainingAccountsProcessor` struct |
| Event subscription boilerplate | 12+ functions in events/ | ~350 | Generic `createEventSubscriber<T>()` |
| Error class constructors | 11+ error files | ~400-500 | Optional: error class factory |
| Logger implementation | SDK + runtime | ~180 | Re-export or shared package |
| PDA derive/find wrappers | 3 runtime modules + 6 inline | ~170 | Generic `createPdaDeriver()` factory |
| Suspend/unsuspend handlers | 2 Rust files | ~100 | Shared `toggle_agent_suspension()` |
| Memcmp query fallback | 2 operations files | ~82 | `fetchWithMemcmpFallback<T>()` |
| Worker active_tasks decrement | 7 sites in 5 Rust files | ~70 | `decrement_worker_active_tasks()` helper |
| Token account building | 4 functions in `tasks.ts` | ~60 | Shared helper |
| Error detection patterns | 7+ files across SDK/runtime | ~50 | Shared `isAccountNotFoundError()` |
| `toUint8Array()` | 5 runtime files | ~30 | Consolidate in `utils/encoding.ts` |
| Lazy-import wrappers | 2 runtime files | ~22 | Factory in `utils/lazy-import.ts` |

**Total estimated duplicated lines:** ~2,000+

---

## God Objects / Large Files

| File | Lines | Severity | Suggestion |
|------|-------|----------|------------|
| `mcp/src/tools/replay.ts` | 1,594 | HIGH | Split into executor/narrator/incidents |
| `runtime/src/autonomous/agent.ts` | 1,485 | MEDIUM-HIGH | Extract orchestrator + event bus |
| `runtime/src/agent/manager.ts` | 1,174 | MEDIUM-HIGH | Extract ProtocolConfigCache |
| `runtime/src/task/executor.ts` | 1,194 | MEDIUM | Already partially factored |
| `runtime/src/index.ts` | 1,121 | LOW | Barrel file, acceptable |
| `runtime/src/workflow/compiler.ts` | 815 | LOW | Acceptable size |
| `mcp/src/tools/inspector.ts` | 670 | MEDIUM | Split by inspection domain |

---

## Positive Findings

- No inline TODO/FIXME/HACK/XXX comments in production source code
- No `@ts-ignore` or `@ts-expect-error` anywhere
- 72+ `checked_add`/`sub`/`mul`/`div` usage (strong arithmetic safety)
- Consistent naming conventions throughout
- All `saturating_sub` usage documented (25+ occurrences)
- Good test coverage (~1,800+ runtime tests, 185 LiteSVM tests)
- Clean imports with no obvious unused imports
- Clean ESLint — all disables justified and documented

---

## Recommended Fix Priority

1. **Silent error swallowing** in executor.ts (1-line fix, critical bug)
2. **Extract `toNumber`/`toBigInt`** to shared utility (eliminates 130 lines across 8 files)
3. **Create `isAccountNotFoundError()`** shared helper (prevents silent misclassification)
4. **Remove dead code**: `buildTokenAccounts`, `privacy.ts`, `ProofTimeEstimator`
5. **Split `resolve_dispute.rs`** handler into 4-5 focused functions (431 lines -> ~100 each)
6. **Extract dispute `RemainingAccountsProcessor`** (eliminates ~400 lines duplication)
7. **Split `mcp/replay.ts`** into 3-4 modules (1,594 -> ~400 lines main)
8. **Consolidate `toUint8Array()`** to `utils/encoding.ts` (5 copies -> 1)
9. **Event subscription factory** (eliminates 350+ lines boilerplate)
10. **Worker active_tasks decrement** helper in Rust (7 sites -> 1 helper)
