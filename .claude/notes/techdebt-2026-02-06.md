# Tech Debt Report - 2026-02-06 (Updated)

## Critical (Fix Now)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Silent error swallowing in production | `runtime/src/task/executor.ts:520` | Checkpoint removal failures silently ignored; could cause stale checkpoints and duplicate task execution | Add `.catch(err => this.logger.warn('checkpoint remove failed', err))` |

## High (Fix This Sprint)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Event subscription boilerplate | `runtime/src/events/{task,dispute,protocol}.ts` | 350+ lines of near-identical callback wrapping across 12+ functions | Create generic `createEventSubscriber()` factory function |
| Slashing logic duplication | `apply_dispute_slash.rs` / `apply_initiator_slash.rs` | 50+ lines duplicated: vote calc, reputation penalty, lamport transfer | Extract `apply_slash_penalty()` helper + `calculate_approval_percentage()` |
| SDK uses console.log instead of logger | `sdk/src/client.ts:60-96`, `sdk/src/privacy.ts:130-232`, `sdk/src/tasks.ts:344-412` | 16+ direct console calls; inconsistent with runtime's centralized logger | Create SDK logger utility or reuse runtime's `createLogger()` |
| test_1.ts is 8,619 lines | `tests/test_1.ts` | Massive single file; hard to navigate, review, or run subsets | Split into logical modules (agent, task, dispute, reputation tests) |
| resolve_dispute handler is 281 lines | `resolve_dispute.rs:86-366` | Longest function in Rust codebase; mixes validation, resolution execution, and account processing | Extract `execute_approved_resolution()`, `execute_rejected_resolution()` |
| executor.ts is 1,186 lines | `runtime/src/task/executor.ts` | Mixes queue management, checkpointing, metrics, backpressure | Extract `RetryHandler`, `CheckpointRecovery`, `BackpressureManager` classes |
| Test setup duplication | `tests/smoke.ts`, `tests/integration.ts` | ~250-300 duplicated lines of `before()`/`beforeEach()` setup that already exists in `test-setup.ts` | Migrate to `setupTestContext()` from `test-setup.ts` |
| Inline PDA derivation in tests | `coordination-security.ts` (92 calls), `rate-limiting.ts` (22), `sybil-attack.ts` (14), 5+ more | ~150 redundant `findProgramAddressSync()` calls | Use `deriveXxxPda()` helpers from `test-utils.ts` |

## Medium (Backlog)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| PDA find/derive wrapper pattern | `runtime/src/agent/pda.ts`, `runtime/src/task/pda.ts` | 6+ identical wrapper functions (100+ lines) | Factory function: `createPdaHelper(seeds) => { derive, find }` |
| Test PDA helpers duplicated locally | `tests/test_1.ts:50-76` vs `tests/test-utils.ts:57-138` | Local copies diverge from canonical source | Delete local copies, import from test-utils |
| Test helper functions duplicated | `tests/smoke.ts:103-167` | `createId()`, `createDescription()`, `createHash()`, all PDA derivers duplicated | Import from test-utils.ts |
| Magic constants in smoke.ts | `tests/smoke.ts:35-44` | AIRDROP_SOL, MIN_BALANCE_SOL, PROTOCOL_FEE_BPS, DISPUTE_THRESHOLD defined locally | Move to test-utils.ts shared constants |
| Deprecated constant still exists | `sdk/src/constants.ts` | `VERIFICATION_COMPUTE_UNITS = 50_000` marked deprecated | Remove if unused, or add `@deprecated` JSDoc |
| Deep nesting in executor stop() | `runtime/src/task/executor.ts:248-260` | 5 levels deep (if > Promise > callback > if > else) | Extract polling wait to helper: `waitForActiveTasks()` |
| Agent registration boilerplate | 15 test files, 77 occurrences | Repeated 15-line `.registerAgent()` blocks | Add `registerAgent()` helper to `test-utils.ts` |
| Task creation boilerplate | 5+ test files, ~25 occurrences | Repeated 20-line `.createTask()` blocks | Add `createTask()` helper to `test-utils.ts` |
| Worker pool reimplementation | `tests/test_1.ts` (lines 85-138) | 50 lines duplicating `test-utils.ts` pool | Use `createWorkerPool()` / `getWorkerFromPool()` from test-utils |
| "Already in use" try-catch pattern | 15+ locations across test files | 15+ identical try-catch blocks | Add `registerAgentOrSkipIfExists()` helper |
| `AccountFetcher` type duplication | `sdk/src/queries.ts:152`, `sdk/src/tasks.ts:26` | 6 duplicated lines | Extract to shared `sdk/src/types/common.ts` |
| `getAccount()` function duplication | `sdk/src/queries.ts:159`, `sdk/src/tasks.ts:31` | 11 duplicated lines | Move to shared `sdk/src/utils/accounts.ts` |
| expire_dispute handler length | `programs/.../instructions/expire_dispute.rs` | ~200 lines | Extract refund and cleanup logic into helpers |

## Duplications Found

| Pattern | Locations | Lines | Refactor To |
|---------|-----------|-------|-------------|
| Event subscription callbacks | `runtime/src/events/{task,dispute,protocol}.ts` (12+ fns) | 350+ | Generic `createEventSubscriber<T>(eventName, parser, filter)` factory |
| Slash logic (vote calc, reputation, transfer) | `apply_dispute_slash.rs`, `apply_initiator_slash.rs` | 50+ | Shared `apply_slash_penalty()` in `slash_helpers.rs` |
| PDA find/derive pairs | `runtime/src/agent/pda.ts`, `runtime/src/task/pda.ts` | 100+ | Factory: `createPdaHelper(seedsFn) => { derive, find }` |
| Test `before()` setup | `smoke.ts`, `integration.ts` vs `test-setup.ts` | 250-300 | `setupTestContext()` from `test-setup.ts` |
| Test PDA derivers | `test_1.ts:50-76`, `smoke.ts:129-167` | 60+ | Already in `tests/test-utils.ts` - delete local copies |
| Test helpers (createId, createHash, etc.) | `smoke.ts:103-127` vs `test_1.ts` | 30+ | Move to `tests/test-utils.ts` |
| Inline `findProgramAddressSync()` | 8+ test files (178 total calls) | ~150 | `deriveXxxPda()` from `test-utils.ts` |
| `.registerAgent()` call pattern | 15 test files (77 occurrences) | ~1000+ | `registerAgent()` helper in `test-utils.ts` |
| `.createTask()` call pattern | 5+ test files (~25 occurrences) | ~500+ | `createTask()` helper in `test-utils.ts` |
| Arbiter validation checks | `vote_dispute.rs:87-107`, `apply_initiator_slash.rs` | 15 | Extract `validate_arbiter_not_participant()` |
| Arbiter vote processing | `resolve_dispute.rs:438`, `expire_dispute.rs:349` | ~70 | Documented as intentional; shared helper if more emerge |
| `AccountFetcher` + `getAccount()` | `sdk/src/queries.ts`, `sdk/src/tasks.ts` | ~17 | Shared module |

## Well-Refactored Areas (No Action Needed)

- `completion_helpers.rs` - 135 lines of shared task completion logic (good pattern)
- `task_init_helpers.rs` - Shared task creation validation + initialization
- `test-setup.ts` - Centralized test lifecycle hooks
- Runtime logger utility - Proper centralized logging (SDK should adopt)
- No TODO/FIXME/HACK comments found in codebase
- No dead code or unused imports detected
- No unsafe `unwrap()` or `panic!()` calls outside of tests
- Constants well-organized: `constants.rs` (Rust), `constants.ts` (SDK), `test-utils.ts` (tests)
- Security patterns consistently applied (checked arithmetic, account ownership validation, nullifier checks)

## Other Observations

- **Empty `.catch(() => {})` in tests**: 20+ instances in test files - acceptable for test cleanup
- **Large files**: `state.rs` (985 lines), `manager.ts` (1,154 lines), `executor.ts` (1,186 lines), `executor.test.ts` (2,428 lines), `proof-deferral.ts` (952 lines) - mostly well-structured despite size
- **Error handling inconsistency**: SDK mixes inline validation/throw, try-catch, and dynamic require patterns - runtime uses structured error classes consistently
- **Box<Account> vs Account**: Consistently applied (Box for large accounts) - intentional pattern

## Summary

- **Total issues:** 21 distinct patterns (1 critical, 8 high, 12 medium)
- **Estimated cleanup:** ~25 files affected
- **Estimated line reduction:** 1,500-2,000 lines (primarily test duplication + event subscription boilerplate)
- **Recommended priority order:**
  1. Fix silent error swallowing in executor (critical, 1-line fix)
  2. Event subscription factory (highest ROI - eliminates 350+ lines)
  3. Test setup consolidation (eliminates ~500+ lines across test files)
  4. Resolve dispute handler refactor (improves reviewability of security-critical code)
- **No critical security issues** - all debt is maintainability/hygiene-related
