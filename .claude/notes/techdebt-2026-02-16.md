# Tech Debt Report - 2026-02-16

**Context:** Post test-fix session. Fixed SDK IDL alignment (governance instructions + error map), runtime vitest alias, governance error handling, and CLI test.

---

## Critical (Fix Now)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Missing `getProposal()` query function | `sdk/src/governance.ts` | SDK API incomplete â€” no way to query proposal state | Add `getProposal()` + `ProposalState` interface following agents/disputes pattern |

## High (Fix This Sprint)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| CLI `isUsageError` pattern duplicated 5x | `runtime/src/cli/index.ts:1554,1595,1663,2030,2117` | ~60 lines of identical error classification | Extract `mapErrorToExitCode(code, additionalCodes?)` helper |
| Incomplete governance error handling | `runtime/src/governance/operations.ts` | Missing: `ProposalAlreadyExecuted` (6150), `TreasuryInsufficientBalance` (6157), `ProposalUnauthorizedCancel` (6153) in catch blocks | Add missing `isAnchorError` checks |
| PDA derivation duplicated SDK vs runtime | `sdk/src/*.ts` (31 inline), `runtime/src/*/pda.ts` | Same derivations in two places, can drift | Consolidate; runtime should re-export from SDK |

## Medium (Backlog)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Memcmp filter construction boilerplate | `runtime/src/{task,dispute}/operations.ts` (4 locations) | ~20 lines repeated | `createStatusFilter(offset, status)` helper |
| PDA derive/find wrapper duplication | `runtime/src/{agent,task,dispute}/pda.ts` (8 pairs) | ~56 lines mechanical wrappers | Factory pattern or code generator |
| Session compaction hook not emitted | `runtime/src/gateway/session.ts:219` | Hook system incomplete | Emit `session:compact` event |
| Stale comment in errors.ts | `sdk/src/errors.ts:2` | Says "6000-6146", should be "6000-6160" | Update comment |
| Event subscription cleanup inconsistent | `runtime/src/{gateway,autonomous,replay}/*` | Potential subscription leaks | Base class/mixin for subscription lifecycle |

## Duplications Found

| Pattern | Locations | Lines | Refactor To |
|---------|-----------|-------|-------------|
| `isUsageError` error classification | `cli/index.ts` (5 blocks) | ~60 | `mapErrorToExitCode()` helper |
| Memcmp filter building | `task/operations.ts`, `dispute/operations.ts` (4 sites) | ~20 | `createStatusFilter()` helper |
| PDA `derive*`/`find*` wrappers | `agent/pda.ts`, `task/pda.ts`, `dispute/pda.ts` (8 pairs) | ~56 | Factory function |
| Inline `PublicKey.findProgramAddressSync` | 10 SDK files (31 occurrences) | ~62 | Centralized `sdk/src/pda.ts` |
| Fetch-with-logging pattern | `dispute/operations.ts` (2 methods) | ~20 | Generic fetch wrapper |

## Items Already Well-Designed (No Action)

- `ensureLazyModule()` lazy-import system (proper abstraction layering)
- `fetchTreasury()` in `utils/treasury.ts` (properly centralized, used by 26 files)
- `validateUnknownStandaloneOptions()` (single function, multiple contextual calls)

## Summary

- **Total issues:** 13
- **Critical:** 1 (missing `getProposal()`)
- **High:** 3 (CLI duplication, governance error gaps, PDA drift)
- **Medium:** 5 (memcmp, PDA wrappers, hooks, comment, subscriptions)
- **Well-designed:** 3 (no action needed)
- **Estimated cleanup:** ~15 files
- **Recommended priority:** Add `getProposal()` + `ProposalState` to SDK governance module, then extract CLI `mapErrorToExitCode()` helper
