## Tech Debt Report - 2026-02-18

### Critical (Fix Now)
| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Bare catch swallows replay-store failures | `sdk/src/queries.ts:571` | Operational failures are silently converted to `unreachable`, removing root-cause diagnostics and making incident response slower. | Catch `error`, log structured context, and include error details in `ReplayHealthCheck` (or rethrow with typed wrapper). |
| Multisig admin instruction flow duplicated across governance methods | `sdk/src/protocol.ts:124`, `sdk/src/protocol.ts:151`, `sdk/src/protocol.ts:184`, `sdk/src/protocol.ts:211` | Governance-critical paths can drift (signer checks, remaining accounts, confirmation handling), creating inconsistent behavior over time. | Extract shared `executeProtocolAdminInstruction(...)` helper and route all multisig admin methods through it. |

### High (Fix This Sprint)
| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Command runner duplicated with behavior drift risk | `mcp/src/tools/circuits.ts:63`, `mcp/src/tools/testing.ts:315`, `runtime/tests/mutation-regression.integration.test.ts:12` | Timeout/env/exit-code handling can diverge across tools and tests, causing non-deterministic outcomes. | Move to a single shared `runCommand` utility and reuse everywhere. |
| Dependency memcmp filter builder duplicated | `sdk/src/queries.ts:252`, `sdk/src/queries.ts:301`, `sdk/src/queries.ts:366` | Query logic can diverge and break dependent-task results/count parity. | Extract `buildDependsOnFilter(parentTaskPda)` helper. |
| MCP tool response tail duplicated repeatedly | `mcp/src/tools/tasks.ts:235`, `mcp/src/tools/circuits.ts:200`, `mcp/src/tools/testing.ts:684`, `mcp/src/tools/inspector.ts:404` | Inconsistent error formatting and maintenance overhead across tool handlers. | Wrap tool handlers in a shared `handleToolRequest`/`formatToolError` utility. |
| Mobile/Web gateway hooks implement protocol behavior differently | `mobile/src/hooks/useRemoteGateway.ts:32`, `web/src/hooks/useWebSocket.ts:20` | Reconnect/auth/queue semantics drift between clients, causing inconsistent reliability and harder protocol changes. | Introduce shared gateway transport logic (queue + auth + reconnect strategy) used by both hooks. |

### Medium (Backlog)
| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Long, mixed-responsibility task creation path | `sdk/src/tasks.ts:228` | PDA derivation, token account branching, RPC construction, and confirmation are tightly coupled and hard to test. | Split into helpers (`buildTokenAccounts`, `buildCreateTaskInstruction`, `confirmTaskTx`). |
| Deep nesting and duplicated audit append branches | `runtime/src/cli/index.ts:2081` | Error/success audit logic is repeated and difficult to reason about when extending commands. | Extract role enforcement + audit append into reusable helpers. |
| Dead code candidate (unreferenced demo entrypoint) | `demo/styled_demo.ts:108` | Unused demo code increases maintenance surface and dependency footprint without runtime value. | Wire into explicit script entrypoint or remove file. |
| `safeStringify`/`clone` duplicated in replay tooling | `mcp/src/utils/truncation.ts:11`, `mcp/src/tools/replay.ts:374` | Two serialization implementations can diverge on edge cases (e.g., bigint formatting). | Export from one shared utility module and consume from both locations. |

### Duplications Found
| Pattern | Locations | Lines | Refactor To |
|---------|-----------|-------|-------------|
| `runCommand` exec wrapper repeated | `mcp/src/tools/circuits.ts`, `mcp/src/tools/testing.ts`, `runtime/tests/mutation-regression.integration.test.ts` | 25 + 20 + 26 | `mcp/src/tools/utils/run-command.ts` |
| Multisig admin method scaffolding repeated | `sdk/src/protocol.ts` (`updateProtocolFee`, `updateRateLimits`, `migrateProtocol`, `updateMinVersion`) | ~112 total | `executeProtocolAdminInstruction(...)` helper |
| Depends-on memcmp filter repeated | `sdk/src/queries.ts` (`getTasksByDependency*`, `getDependentTaskCount`) | ~63 total | `buildDependsOnFilter(parentTaskPda)` |
| Tool `return content` + catch error boilerplate repeated | `mcp/src/tools/tasks.ts`, `mcp/src/tools/circuits.ts`, `mcp/src/tools/testing.ts`, `mcp/src/tools/inspector.ts` | >50 total | `withToolResponse(...)` wrapper |
| Bigint-safe stringify + clone repeated | `mcp/src/utils/truncation.ts`, `mcp/src/tools/replay.ts` | 12 + 12 | `mcp/src/utils/json.ts` |
| Task creation token-account branch repeated structurally | `sdk/src/tasks.ts` (`createTask`, `createDependentTask`) | ~80 structural duplicate lines | Shared token account builder |

### Summary
- Total issues: 10
- Estimated cleanup: 14 files
- Recommended priority: remove governance-path duplication (`sdk/src/protocol.ts`) and replace bare replay health-check catch with structured error reporting (`sdk/src/queries.ts`).
- TODO/FIXME/HACK scan (`**/*.ts`, `**/*.js`, `**/*.py`): no matches found.
