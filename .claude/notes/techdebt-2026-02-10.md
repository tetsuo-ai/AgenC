# Tech Debt Report - 2026-02-10 (Updated)

Post Phase 9 (examples/docs). Comprehensive scan of programs/, sdk/, runtime/, tests/, examples/.

---

## Critical (Fix Now)

_None found._ No security issues, no data loss risks, no broken production code.

---

## High (Fix This Sprint)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Dispute worker/arbiter processing duplication | `resolve_dispute.rs`, `expire_dispute.rs`, `apply_dispute_slash.rs` | ~400 lines of near-identical remaining_accounts processing (validate, deduplicate arbiters, process vote/agent pairs, process claim/worker pairs) | Extract `dispute_helpers.rs` with `RemainingAccountsProcessor` struct |
| `resolve_dispute.rs` handler is 427 lines | `programs/.../instructions/resolve_dispute.rs` | Largest function in codebase, difficult to review/maintain, deep nesting (4-5 levels) | Split into validation, fund distribution, and account processing functions |
| Dead privacy module | `sdk/src/privacy.ts` (entire file) + `sdk/src/index.ts:11` | Dead code — exported but depends on uninstalled `privacycash` | Either implement conditional import or move to `examples/` |
| PDA derivation duplication | `runtime/src/agent/pda.ts`, `task/pda.ts`, `dispute/pda.ts`, `tests/test-utils.ts` + 6 inline sites in `autonomous/agent.ts` | ~170 lines of near-identical PDA derive/find pairs + inline `findProgramAddressSync` calls | Create shared generic `derivePda()` utility; eliminate inline derivations; have tests import from runtime |
| Memcmp query pattern duplication | `runtime/src/task/operations.ts:171-210`, `dispute/operations.ts:160-208` | ~82 lines of identical "try memcmp, fallback to fetch-all + client filter" pattern repeated 3x | Extract generic `fetchWithMemcmpFallback<T>()` helper |

---

## Medium (Backlog)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Worker active_tasks decrement duplication | `cancel_task.rs`, `complete_task.rs`, `expire_claim.rs`, `resolve_dispute.rs`, `expire_dispute.rs` (7 sites) | ~70 lines of identical validate-deserialize-decrement-serialize pattern | Add `decrement_worker_active_tasks()` to `completion_helpers.rs` |
| Lazy loading pattern duplication | `runtime/src/llm/grok/`, `anthropic/`, `ollama/`, `memory/sqlite/`, `memory/redis/` | ~250 lines of identical `ensureClient()`/`ensureDb()` with MODULE_NOT_FOUND handling | Extract `LazyLoader<T>` utility class in `runtime/src/utils/lazy-loader.ts` |
| Remaining accounts validation pattern | 10+ Rust instruction handlers | ~120 lines of identical `owner == &crate::ID` + `try_borrow_data` + deserialize pattern | Add `validate_and_deserialize<T>()` to `src/utils/validation.rs` |
| Treasury caching duplication | `task/operations.ts:462-471`, `dispute/operations.ts:554-559` | ~10 lines duplicated, naming inconsistency (`cachedProtocolTreasury` vs `cachedTreasury`) | Extract `ProtocolTreasuryCache` shared class |
| Error mapping duplication | `task/operations.ts`, `dispute/operations.ts` | ~74 lines of similar `isAnchorError()` chains across 5+ methods | Create declarative `AnchorErrorMapper` utility |
| Operations class init duplication | `task/operations.ts:100-104`, `dispute/operations.ts:97-104` | Different init strategies (lazy vs eager PDA) for same pattern | Extract `PdaBasedOperations` abstract base class |
| Test PDA helpers diverged from runtime | `tests/test-utils.ts:60-161` (9 functions) | Parallel implementations that could drift from runtime | Import `findXPda()` from `@agenc/runtime` instead of reimplementing |
| `AgentManager` class size | `runtime/src/agent/manager.ts` (1154 lines) | Large file — cache management, event handling, registration, queries all in one | Consider splitting by concern |
| `tests/test_1.ts` file size | `tests/test_1.ts` (8612 lines) | Single monolithic test file covering 141 tests | Split into focused test files by domain |
| Deep nesting in resolve_dispute.rs | `resolve_dispute.rs:187-264` | 4-5 levels of `if { match { if { if let` nesting | Use early returns and guard clauses |
| Deprecated scripts/directories | `scripts/deploy-verifier.sh`, `circuits/` dir | Confusing for new contributors | Archive or remove |
| Deprecated SDK constant | `sdk/src/constants.ts:53-54` (`VERIFICATION_COMPUTE_UNITS`) | Marked `@deprecated` but still exported | Remove in next major version |

---

## Low (Opportunistic)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| `isAccountNotFoundError` not shared | `runtime/src/task/operations.ts:481-487` | Module-local; dispute ops uses different approach | Move to `runtime/src/utils/errors.ts` |
| Base58 validation duplication | `runtime/src/tools/agenc/tools.ts` (4 tools) | Same try-catch PublicKey pattern in each tool | Extract `validateBase58Pubkey()` to utils |
| Test-local constants | Various test files define ARBITER_STAKE, WORKER_STAKE locally | Minor inconsistency | Move to `tests/test-utils.ts` |
| `Math.floor(Date.now() / 1000)` repeated | `runtime/src/task/filters.ts` (3 instances) | Hardcoded timestamp conversion | Extract `unixTimestamp()` helper |
| Magic default numbers in runtime | `task/rollback-controller.ts:174,228`, `task/dlq.ts:18`, `task/types.ts:737,757,802` | Hardcoded retry delays, sizes, thresholds | Extract to named constants in config |
| Demo commented-out code | `demo/private_task_demo.ts:81`, `examples/skill-jupiter/index.ts:99` | Minor — example code | Acceptable for examples |

---

## Duplications Found

| Pattern | Locations | Est. Lines | Refactor To |
|---------|-----------|------------|-------------|
| Dispute remaining_accounts processing | resolve_dispute.rs, expire_dispute.rs, apply_dispute_slash.rs | ~400 | `dispute_helpers.rs` with shared processor |
| PDA derive/find pairs + inline usage | agent/pda.ts, task/pda.ts, dispute/pda.ts, test-utils.ts, autonomous/agent.ts | ~170 | Generic `derivePda()` utility + eliminate inline |
| Lazy loading (ensureClient/Db) | 3 LLM adapters + 2 memory backends | ~250 | `LazyLoader<T>` utility class |
| Worker active_tasks decrement | 7 Rust instruction handler sites | ~70 | `decrement_worker_active_tasks()` helper |
| Remaining accounts validation | 10+ Rust instruction handlers | ~120 | `validate_and_deserialize<T>()` utility |
| Memcmp query + fallback | task/operations.ts (1), dispute/operations.ts (2) | ~82 | `fetchWithMemcmpFallback<T>()` helper |
| Anchor error mapping chains | task/operations.ts (2), dispute/operations.ts (3+) | ~74 | Declarative `AnchorErrorMapper` utility |
| Treasury caching | task/operations.ts, dispute/operations.ts | ~10 | Shared `ProtocolTreasuryCache` class |
| Operations constructor | task/operations.ts, dispute/operations.ts | ~8 | `PdaBasedOperations` abstract base |
| Base58 validation | tools/agenc/tools.ts (4 tools) | ~20 | `validateBase58Pubkey()` utility |
| **Total** | | **~1,204 lines** | |

---

## Positive Findings

- **No TODO/FIXME/HACK comments** in production source code (only documentation comments referencing past bugs)
- **No `@ts-ignore` or `@ts-expect-error`** in the entire codebase
- **No production `.unwrap()`** — all unwraps are in test code or after validation
- **72 occurrences of `checked_add/sub/mul/div`** across 17 Rust files (strong arithmetic safety)
- **Consistent naming conventions** — Rust snake_case, TypeScript camelCase throughout
- **Good documentation** — helper functions have docstrings, security notes, issue references
- **Comprehensive error handling** — custom error classes for all failure modes
- **Clean imports** — no obvious unused imports detected
- **ESLint disables all justified** (6 occurrences, all documented)
- **`saturating_sub` usage always documented** (25 occurrences, all with comments)

---

## Summary

- **Total issues:** 23
- **Critical:** 0
- **High:** 5
- **Medium:** 12
- **Low:** 6
- **Estimated cleanup:** ~15 files
- **Estimated lines saved:** ~1,204 (from deduplication alone)
- **Recommended priority:** Dispute helper extraction (highest line savings at ~400, reduces most critical complexity)

---

## Comparison with Previous Reports

Compared to 2026-02-06 report:
- Dead `privacy.ts` module persists (carried forward)
- PDA duplication grew with dispute/pda.ts addition (Phase 8) + inline sites identified
- Treasury caching now duplicated in 2 places (was 1 pre-Phase 8)
- Memcmp query pattern now in 3 places (was 1 pre-Phase 8)
- NEW: Comprehensive Rust duplication analysis reveals ~590 lines of duplicate patterns in instruction handlers
- NEW: `resolve_dispute.rs` identified as largest/most complex handler (427 lines, 4-5 nesting levels)
- NEW: Lazy loading pattern duplication across 5 backend files (~250 lines)
- Overall codebase quality remains high — new modules follow established patterns consistently
