# Tech Debt Report - 2026-02-11

**Session:** ConnectionManager implementation (Phase 10 integration)
**Branch:** `feature/connection-manager`
**Scan scope:** `runtime/src/`, `sdk/src/`, `programs/agenc-coordination/src/`

## Critical (Fix Now)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| None from this session | — | — | — |

No critical issues introduced by the ConnectionManager PR. All new code is clean.

## High (Fix This Sprint)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| `toUint8Array()` duplicated 5 times | `agent/events.ts:71`, `agent/types.ts:476`, `events/parse.ts:32`, `task/types.ts:278`, `dispute/types.ts:336` | Maintenance burden; risk of divergence (dispute version has different signature) | Extract to `utils/encoding.ts`, import everywhere |
| Logger duplicated across SDK and runtime | `sdk/src/logger.ts` (97 lines), `runtime/src/utils/logger.ts` (90 lines) | ~90 lines exact duplication; updates must be made twice | Runtime already depends on SDK — re-export SDK logger or extract shared package |
| `ProofTimeEstimator` is dead code | `runtime/src/task/proof-time-estimator.ts` | Exported from barrel, never imported anywhere in codebase | Remove file and barrel export, or integrate into SpeculativeScheduler |
| `addDependency()` is a no-op stub | `runtime/src/task/speculative-scheduler.ts:481-498` | Public method with 2 unused params (`_upstream`, `_type`) that logs a warning instead of working | Implement actual dependency addition or remove method |
| Lazy import pattern duplicated | `runtime/src/llm/lazy-import.ts` and `runtime/src/memory/lazy-import.ts` | ~38 lines near-identical; only error class differs | Create generic `ensureLazyModule<T>()` accepting error factory |

## Medium (Backlog)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Magic numbers in speculation config | `task/speculative-scheduler.ts:178-191` | Hardcoded defaults not in constants file (depth=3, stake=10 SOL, reputation=500, timeout=5min) | Extract to `task/constants.ts` |
| Magic numbers in proof pipeline | `task/proof-pipeline.ts:150-159` | maxConcurrentProofs=4, timeout=60s, retry policy hardcoded | Extract to constants |
| String keys for PDA lookups | `task/rollback-controller.ts:222`, `task/proof-pipeline.ts:205` | `Map<string, ...>` with base58 keys — normalization risk | Consider `Map` wrapper with `PublicKey.toBase58()` accessor |
| `shouldSpeculate()` is 59 lines | `task/speculative-scheduler.ts:385-443` | 7 nested constraint checks in one method | Extract each check to private method |
| 3 different event callback patterns | `events/monitor.ts`, `task/proof-pipeline.ts`, `task/speculative-scheduler.ts` | Inconsistent; hard to compose unified observability | Standardize on single callback pattern |
| PDA derive/find pair duplication | `agent/pda.ts`, `task/pda.ts`, `dispute/pda.ts` | 3 modules x 2-6 functions each with identical structure | Generic PDA factory function |

## Duplications Found

| Pattern | Locations | Lines | Refactor To |
|---------|-----------|-------|-------------|
| `toUint8Array()` | 5 files (agent/events, agent/types, events/parse, task/types, dispute/types) | 6 lines x 5 = 30 | Single export in `utils/encoding.ts` |
| Logger (createLogger + silentLogger + interface) | `sdk/src/logger.ts`, `runtime/src/utils/logger.ts` | ~90 lines x 2 = 180 | Re-export from SDK or shared package |
| Lazy import helper | `llm/lazy-import.ts`, `memory/lazy-import.ts` | ~38 lines x 2 = 76 | Generic `ensureLazyModule()` in `utils/` |
| PDA derive/find wrappers | `agent/pda.ts`, `task/pda.ts`, `dispute/pda.ts` | ~30 lines x 3 = 90 | Generic factory: `createPdaHelper(seeds)` |
| Config default spread pattern | 3 LLM adapters (grok, anthropic, ollama) | ~10 lines x 3 = 30 | `mergeConfigWithDefaults()` helper |

## New Code Quality (ConnectionManager)

The new `runtime/src/connection/` module is clean:
- No TODO/FIXME/HACK comments
- No dead code
- No functions >50 lines
- No magic numbers (all defaults in named constants)
- Error classes follow established `RuntimeError` pattern
- 66 tests with full coverage of retry, failover, coalescing, health, abort, and stats
- Reuses existing `bigintReplacer` from tools/types.ts
- Reuses existing `silentLogger` from utils/logger.ts

## Summary

- **Total issues:** 11 (0 critical, 5 high, 6 medium)
- **Total duplicated lines:** ~406 across 5 duplication patterns
- **Estimated cleanup:** 12 files
- **Recommended priority:** `toUint8Array()` dedup (5 copies, easiest win), then `ProofTimeEstimator` removal (dead code)
- **No critical blockers** — all issues are maintenance/hygiene
