# Tech Debt Report - 2026-02-12

**Session:** feat(sdk): SPL token helpers and client methods (#861)
**Scope:** `sdk/src/` — new `tokens.ts`, rewritten `tasks.ts`, fixed `queries.ts`

---

## Critical (Fix Now)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Dead function `buildTokenAccounts` | `tasks.ts:190-211` | Defined but never called (22 lines dead code) | Remove or wire into `createTask`/`completeTask`/etc. |
| `AccountFetcher` + `getAccount` duplicated | `tasks.ts:34-49` + `queries.ts:167-185` | 18 lines exact duplicate, 2 files to maintain | Extract to `src/internal/anchor-utils.ts` |

## High (Fix This Sprint)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Token account building pattern repeated 4x | `tasks.ts` lines 239-263, 363-381, 456-473, 529-544 | 60+ lines duplication, token changes need 4 updates | Either use the existing `buildTokenAccounts` helper in all 4 functions, or remove it and keep inline |
| Task status parsing duplicated | `tasks.ts` `getTask` (586-642) + `getTasksByCreator` (660-706) | 40+ lines same parse logic | Extract `parseTaskAccount(rawData): TaskStatus` helper |
| Option\<Pubkey\> filter bytes built 3x | `queries.ts` lines 217-220, 267-269, 331-333 | Same buffer building logic repeated | Extract `buildOptionPubkeyFilter(pubkey): Buffer` |
| Missing input validation in `createTask` | `tasks.ts:224` | No length check on taskId (32 bytes), description (64 bytes), maxWorkers (u8) | Add validation before Anchor call |
| `deriveProtocolPda` / `deriveAgentPda` private in tasks.ts | `tasks.ts:172-187` | Not exported, forces duplication (privacy.ts inlines same PDAs) | Export or move to shared `src/pda.ts` |

## Medium (Backlog)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Escrow PDA inlined in tokens.ts | `tokens.ts:58-61` | Duplicates `deriveEscrowPda` from tasks.ts | Import from tasks.ts instead |
| Silent error swallowing in `verifyProofLocally` | `proofs.ts:354-357` | Hides genuine errors (OOM, I/O) as "invalid proof" | Catch specific risc0-host-prover errors, rethrow unexpected |
| Missing null checks after account fetch | `tasks.ts:351-354, 357-359` | Will throw unhelpful error if account not found | Add explicit "Task not found" / "Protocol not initialized" errors |
| Protocol config fetch duplicated | `tasks.ts:357-359` + `tasks.ts:449-451` | Identical treasury fetch in completeTask + completeTaskPrivate | Extract `fetchProtocolTreasury()` helper |
| Long function: `deserializeTaskAccount` | `queries.ts:393-497` | 105 lines, repetitive field reads | Consider schema-driven approach or split into sub-parsers |
| Long function: `completeTaskPrivate` | `tasks.ts:414-502` | 89 lines | Extract nullifier PDA, task ID extraction, token accounts |
| Magic number `33` (Option\<Pubkey\> size) | `queries.ts:218,268,332` | Hardcoded buffer sizes | Add `OPTION_PUBKEY_SIZE = 33` to constants.ts |
| Magic number `32` in creator offset | `tasks.ts:655` | Should use `HASH_SIZE` constant | Replace with `DISCRIMINATOR_SIZE + HASH_SIZE` |
| Dead code: `computeConstraintHash`/`computeOutputCommitment` wrappers | `privacy.ts:447-466` | Exported but never imported by consumers (proofs.ts versions preferred) | Remove or mark @internal |
| Deprecated constant still exported | `constants.ts:54` `VERIFICATION_COMPUTE_UNITS` | Misleading API surface | Remove or hide |

## Duplications Found

| Pattern | Locations | Lines | Refactor To |
|---------|-----------|-------|-------------|
| `AccountFetcher` type + `getAccount()` | `tasks.ts:34-49`, `queries.ts:167-185` | 18x2=36 | `src/internal/anchor-utils.ts` |
| Token account building (SOL vs SPL conditional) | `tasks.ts` x4 functions | ~15x4=60 | `buildTokenAccounts()` already exists, just needs wiring |
| Task account parsing to `TaskStatus` | `tasks.ts:586-642`, `tasks.ts:660-706` | ~40x2=80 | `parseTaskAccount(rawData): TaskStatus` |
| Option\<Pubkey\> filter buffer | `queries.ts` x3 | ~4x3=12 | `buildOptionPubkeyFilter(pubkey)` |
| Protocol config + treasury fetch | `tasks.ts:357-359`, `tasks.ts:449-451` | ~3x2=6 | `fetchProtocolTreasury(program, pda)` |
| Escrow PDA derivation | `tasks.ts:160-166`, `tokens.ts:58-61` | ~3x2=6 | Import from `tasks.ts` in `tokens.ts` |

## Summary

- **Total issues:** 17
- **Critical:** 2 (dead code, exact duplication)
- **High:** 5 (pattern duplication, missing validation)
- **Medium:** 10 (inconsistencies, long functions, magic numbers)
- **Estimated cleanup:** 5 files (`tasks.ts`, `queries.ts`, `tokens.ts`, `constants.ts`, new `anchor-utils.ts`)
- **Recommended priority:** Remove dead `buildTokenAccounts` (trivial), then deduplicate `AccountFetcher`/`getAccount` (highest blast radius)

## Notes

- Zero TODO/FIXME/HACK comments found
- No excessive nesting (max 3 levels)
- No unhandled promise rejections
- `privacy.ts` is legacy code (Privacy Cash integration) — lower priority for cleanup
- All pre-existing issues (not introduced in this session): `proofs.ts` error swallowing, `privacy.ts` weak type validation
- **Introduced in this session:** dead `buildTokenAccounts`, token account pattern duplication, `AccountFetcher` duplication (carried forward from queries.ts to tasks.ts)
