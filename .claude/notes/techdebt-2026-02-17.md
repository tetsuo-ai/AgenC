# Tech Debt Report — 2026-02-17

**Scope:** Grok 4.1 Model Upgrade + xAI Real-time Voice Integration PR

Files created/modified: 25 files across runtime/, web/

---

## Critical (Fix Now)

_None._

---

## High (Fix This Sprint)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| `voice.error` not surfaced to user | `web/src/hooks/useVoice.ts:128-130` | User gets no feedback when voice session encounters an error — UI stays in current state silently | Set voiceState to a visible error state or show a toast/notification |
| `getUserMedia` permission denial unhandled | `web/src/hooks/useAudioRecorder.ts:47` | If user denies mic permission, `start()` throws unhandled. Caller (`useVoice.startVoice`) has no catch | Add try/catch in `startVoice()` or in recorder's `start()`, send error to UI |

---

## Medium (Backlog)

| Issue | Location | Impact | Suggested Fix |
|-------|----------|--------|---------------|
| Base64 helpers local to client.ts | `runtime/src/voice/realtime/client.ts:331-354` | `uint8ToBase64()` / `base64ToUint8()` are file-scoped; pattern exists in `utils/encoding.ts` for hex but not base64 | Extract to `utils/encoding.ts` for reuse |
| No logging in XaiRealtimeClient | `runtime/src/voice/realtime/client.ts:187-244` | `handleServerEvent()` has no logging — makes production debugging of voice sessions difficult | Accept optional logger in config, log event types at debug level |
| VoiceRealtimeError lacks detail | `runtime/src/voice/realtime/errors.ts:12-21` | Only captures `xaiCode` — no `type` field from xAI error response; can't distinguish rate limit vs auth failure | Add `xaiType` field to error class |
| Audio player doesn't handle post-close enqueue | `web/src/hooks/useAudioPlayer.ts:62-70` | `stop()` closes AudioContext but racing `enqueue()` calls could error on closed context | Guard `enqueue()` with context state check |
| Aliased exports unused | `runtime/src/voice/index.ts:56-57` | `VoiceClientEvent` / `VoiceServerEvent` aliases exported but not imported anywhere | Remove or document as public API for consumers |

---

## Duplications Found

| Pattern | Locations | Lines | Refactor To |
|---------|-----------|-------|-------------|
| Base64 encode/decode (Node Buffer+btoa fallback) | `runtime/src/voice/realtime/client.ts:331-354` | 24 | `runtime/src/utils/encoding.ts` |
| Sample rate constant `24_000` | `web/src/hooks/useAudioRecorder.ts:4`, `web/src/hooks/useAudioPlayer.ts:4` | 2 | Shared `web/src/constants.ts` or colocate in single audio util |
| Voice WS protocol types (server-side vs client-side) | `runtime/src/channels/webchat/types.ts:281-300` vs `web/src/types.ts:143-145` | ~25 | Intentional isolation (no Node imports in browser). Add sync note comment. |

---

## Pre-existing Issues (Not from this PR, noted for record)

| Issue | Location | Notes |
|-------|----------|-------|
| `wireWebChat()` is 152 lines | `runtime/src/gateway/daemon.ts:215-367` | Mixed concerns: discovery + registry + executor + voice bridge. Should split. |
| Magic numbers MAX_HISTORY=50, MAX_SESSIONS=100 | `runtime/src/gateway/daemon.ts:266-267` | Hardcoded, no config option |
| `WebChatHandler` interface in two files | `runtime/src/gateway/types.ts` + `runtime/src/channels/webchat/types.ts` | One is canonical, other re-exports. Not truly duplicated. |
| `as any` in pre-existing voice STT/TTS | `runtime/src/voice/tts.ts:180,204,303`, `runtime/src/voice/stt.ts:85,109` | Dynamic SDK loading forces type erasure |
| Unused webchat protocol types | `runtime/src/channels/webchat/types.ts` | `ChatTypingRequest`, `SkillsToggleRequest`, etc. are protocol documentation, not dead code |

---

## Summary

- **Total new issues from this PR:** 7 (0 critical, 2 high, 5 medium)
- **Duplications:** 3 patterns (1 actionable, 2 intentional/trivial)
- **Files needing cleanup:** 4 (`useVoice.ts`, `useAudioRecorder.ts`, `client.ts`, `errors.ts`)
- **Recommended priority:** Fix `voice.error` UI feedback + mic permission handling
