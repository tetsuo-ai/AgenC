---
description: Rules for TypeScript runtime development
globs: ["**/runtime/**/*.ts", "**/sdk/**/*.ts"]
---

# Runtime Development Rules

## File Structure

```
packages/runtime/src/task/
├── index.ts              # Exports all modules
├── dependency-graph.ts   # DAG for task relationships
├── proof-pipeline.ts     # Async proof generation
├── commitment-ledger.ts  # Speculative state tracking
├── proof-deferral.ts     # Ancestor-aware proof ordering
├── rollback-controller.ts # Cascade rollback handling
├── speculative-executor.ts # Single-level speculation
├── speculative-scheduler.ts # Main orchestrator
├── speculation-metrics.ts # Observability
└── __tests__/            # Test files
```

## Adding New Components

1. Create the file with interfaces and class
2. Export from `index.ts`
3. Add tests alongside or in `__tests__/`

## Interface Patterns

```typescript
// Config interface
export interface MyComponentConfig {
  optionA: number;
  optionB: boolean;
}

// Events interface
export interface MyComponentEvents {
  onSomething?: (data: SomeType) => void;
  onError?: (error: Error) => void;
}

// Main class
export class MyComponent {
  constructor(
    private config: MyComponentConfig,
    private events: MyComponentEvents = {}
  ) {}
  
  // Always include stats
  getStats(): object { return {}; }
}
```

## Testing

```typescript
import { describe, it, expect, beforeEach } from 'vitest';

describe('MyComponent', () => {
  let component: MyComponent;
  
  beforeEach(() => {
    component = new MyComponent({ optionA: 1, optionB: true });
  });
  
  it('should do something', () => {
    expect(component.getStats()).toBeDefined();
  });
});
```

## Build Commands

```bash
cd packages/runtime
yarn build    # Compile TypeScript
yarn test     # Run tests
yarn test -- --grep "pattern"  # Run specific tests
```

## Speculation Components Integration

```typescript
// Creating the full speculation stack
const graph = new DependencyGraph();
const ledger = new CommitmentLedger({ maxCommitments: 1000 });
const pipeline = new ProofPipeline({ maxConcurrentProofs: 5 });
const deferral = new ProofDeferralManager(config, graph, ledger);
const rollback = new RollbackController(config, graph, ledger);
const scheduler = new SpeculativeTaskScheduler(
  config, graph, ledger, deferral, rollback
);
```
