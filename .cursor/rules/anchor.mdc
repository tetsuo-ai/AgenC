---
description: Rules for Anchor/Solana program development
globs: ["**/programs/**/*.rs"]
---

# Anchor Program Rules

## Account Structs

When adding new account types:

```rust
#[account]
pub struct MyAccount {
    pub field1: Pubkey,
    pub field2: u64,
    pub bump: u8,
}

impl MyAccount {
    // Calculate exact size: 8 (discriminator) + field sizes
    pub const SIZE: usize = 8 + 32 + 8 + 1;
}
```

## Instructions

Follow existing patterns in `instructions/`:

```rust
#[derive(Accounts)]
pub struct MyInstruction<'info> {
    #[account(mut)]
    pub signer: Signer<'info>,
    
    #[account(
        init,
        payer = signer,
        space = MyAccount::SIZE,
        seeds = [b"seed", key.as_ref()],
        bump
    )]
    pub account: Account<'info, MyAccount>,
    
    pub system_program: Program<'info, System>,
}
```

## Events

Always emit events for state changes:

```rust
emit!(MyEvent {
    field: value,
    timestamp: Clock::get()?.unix_timestamp,
});
```

## Error Codes

Add to `errors.rs` with descriptive messages:

```rust
#[error_code]
pub enum CoordinationError {
    #[msg("Description of error")]
    MyError,
}
```

## Build Verification

After changes:
```bash
anchor build
anchor test
```

## Speculation-Specific Types

- `DependencyType`: None, Data, Ordering, Proof
- `SpeculativeCommitment`: On-chain commitment tracking
- `SpeculationBond`: Stake bonding for agents
- `SlashReason`: ProofFailed, ProofTimeout, InvalidResult
