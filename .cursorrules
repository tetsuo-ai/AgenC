# AgenC Cursor Rules

## Project Overview

AgenC is a privacy-preserving AI agent coordination protocol built on Solana. It enables decentralized task coordination with zero-knowledge proofs for private task completions.

## Critical Rules

### Git Workflow
- **NEVER push directly to main** - always create a branch and PR
- **NEVER add Co-authored-by trailers** to commits
- Every change needs a GitHub issue and PR

### Code Style
- **Never use em dashes (â€”)** - use commas, colons, or separate sentences
- Follow existing patterns in the codebase
- Use TypeScript for runtime code
- Use Rust/Anchor for on-chain code

## Architecture

### Modules
- **programs/agenc-coordination/** - Solana Anchor program
- **packages/sdk/** - TypeScript SDK (@agenc/sdk)
- **packages/runtime/** - Agent runtime (@agenc/runtime)
- **circuits/** - ZK circuits (Circom/snarkjs)

### Speculative Execution System

The runtime includes a complete speculative execution system for overlapping task execution with proof generation.

#### Core Components (packages/runtime/src/task/)

| Component | File | Purpose |
|-----------|------|---------|
| DependencyGraph | dependency-graph.ts | DAG for task relationships |
| ProofPipeline | proof-pipeline.ts | Async proof generation queue |
| CommitmentLedger | commitment-ledger.ts | Tracks speculative state |
| ProofDeferralManager | proof-deferral.ts | Ancestor-aware proof ordering |
| RollbackController | rollback-controller.ts | Cascade rollback handling |
| SpeculativeExecutor | speculative-executor.ts | Single-level speculation |
| SpeculativeTaskScheduler | speculative-scheduler.ts | Main orchestrator |
| ProofTimeEstimator | proof-time-estimator.ts | Claim expiry estimation |
| SpeculationMetricsCollector | speculation-metrics.ts | Observability metrics |

#### Critical Invariant

**Proofs are NEVER submitted until all ancestor proofs are confirmed on-chain.**

This is enforced in:
- `ProofDeferralManager.canSubmit()`
- `SpeculativeTaskScheduler.shouldSpeculate()`

#### On-Chain Components (programs/agenc-coordination/src/)

| Component | File | Purpose |
|-----------|------|---------|
| Task.depends_on | state.rs | Parent task dependency |
| DependencyType | state.rs | Data/Ordering/Proof dependency types |
| SpeculativeCommitment | state.rs | On-chain commitment tracking |
| SpeculationBond | state.rs | Stake bonding for speculation |
| SlashReason | state.rs | Proof failure slash reasons |
| create_dependent_task | instructions/ | Create task with dependency |

## Build Commands

```bash
# Anchor program
anchor build
anchor test

# Runtime
cd packages/runtime && yarn build && yarn test

# SDK
cd packages/sdk && yarn build && yarn test
```

## Design Documentation

Comprehensive design docs at `docs/design/speculative-execution/`:
- DESIGN-DOCUMENT.md - Full software design document
- API-SPECIFICATION.md - TypeScript API reference
- ON-CHAIN-SPECIFICATION.md - Anchor program spec
- RISK-ASSESSMENT.md - FMEA with 43 failure modes
- diagrams/ - UML, sequence, state machine diagrams
- test-plans/ - Unit, integration, chaos test plans
- runbooks/ - Deployment, operations, troubleshooting

## Testing

```bash
# All runtime tests (~1300 tests)
cd packages/runtime && yarn test

# Speculation-specific tests
yarn test -- --grep "speculation"
yarn test -- --grep "DependencyGraph"
yarn test -- --grep "CommitmentLedger"
yarn test -- --grep "RollbackController"

# Chaos tests
yarn test -- --grep "chaos"
```

## Common Patterns

### Adding a new speculation component

1. Create file in `packages/runtime/src/task/`
2. Export from `packages/runtime/src/task/index.ts`
3. Add tests in `__tests__/` or alongside the file
4. Follow existing patterns (events, config, stats)

### Modifying on-chain state

1. Update struct in `programs/agenc-coordination/src/state.rs`
2. Update SIZE constant
3. Run `anchor build` to regenerate IDL
4. Update SDK types if needed

### Creating dependent tasks

```typescript
// On-chain
await program.methods.createDependentTask(
  taskId,
  { data: {} }, // DependencyType
  // ... other params
).accounts({
  parentTask: parentTaskPda,
  // ...
}).rpc();

// Runtime - query dependents
const dependents = await getTasksByDependency(connection, programId, parentPda);
```
