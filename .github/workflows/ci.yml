name: CI

on:
  push:
  pull_request:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SOLANA_VERSION: v1.18.26
  ANCHOR_VERSION: 0.30.1
  NODE_VERSION: "20"

jobs:
  rust_checks:
    runs-on: ubuntu-latest
    env:
      # OK for general linting; DO NOT use this in anchor_tests (it can break target probing).
      RUSTFLAGS: "-Awarnings"
      ANCHOR_IDL_BUILD_PROGRAM_PATH: programs/agenc-coordination
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: cargo fmt
        working-directory: programs/agenc-coordination
        run: cargo fmt --all --check

      - name: cargo clippy (program)
        working-directory: programs/agenc-coordination
        run: cargo clippy --all-targets --all-features

  security_scans:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: cargo-audit (non-blocking)
        shell: bash
        run: |
          set -euxo pipefail
          cargo install cargo-audit --locked --force
          # Don’t fail the whole build on audit noise for Solana/Anchor transitive deps
          cargo audit || true

      - name: cargo-deny (optional)
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f deny.toml ]; then
            cargo install cargo-deny --locked --force
            cargo deny --manifest-path programs/agenc-coordination/Cargo.toml check
          else
            echo "deny.toml not found; skipping cargo-deny"
          fi

  anchor_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn

      - name: Install JS deps
        run: yarn install --frozen-lockfile

      - name: Install Solana
        shell: bash
        run: |
          set -euxo pipefail
          sh -c "$(curl -sSfL https://release.solana.com/${SOLANA_VERSION}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> "$GITHUB_PATH"
          solana --version

      - name: Install AVM + Anchor
        shell: bash
        run: |
          set -euxo pipefail

          # Install avm
          cargo install --locked --force --git https://github.com/coral-xyz/anchor avm

          # Hard cleanup to avoid “binary already exists”
          rm -f "$HOME/.cargo/bin/anchor" || true
          rm -f "$HOME/.local/bin/anchor" || true
          rm -f "$HOME/.avm/bin/anchor" || true
          rm -rf "$HOME/.avm/versions/${ANCHOR_VERSION}" || true

          # Install anchor
          avm install "${ANCHOR_VERSION}" --force
          avm use "${ANCHOR_VERSION}"

          anchor --version

      - name: Force program Cargo.lock to Solana-compatible (v3)
        shell: bash
        run: |
          set -euxo pipefail

          # Find Solana platform-tools cargo (this is the one that matches build-sbf expectations)
          SOLANA_CARGO="$(find "$HOME/.cache/solana" -type f -path "*/platform-tools/rust/bin/cargo" | head -n 1 || true)"
          if [ -z "$SOLANA_CARGO" ]; then
            echo "Could not find Solana platform-tools cargo under ~/.cache/solana"
            echo "Directory listing:"
            ls -la "$HOME/.cache/solana" || true
            exit 1
          fi

          "$SOLANA_CARGO" -V

          # Regenerate lockfile using Solana cargo so it writes a compatible lock format
          cd programs/agenc-coordination
          rm -f Cargo.lock
          "$SOLANA_CARGO" generate-lockfile

          # Sanity check: show the lockfile version line if present
          grep -n "^version" Cargo.lock || true
          head -n 20 Cargo.lock

      - name: anchor test
        shell: bash
        working-directory: programs/agenc-coordination
        run: |
          set -euxo pipefail
          anchor test
