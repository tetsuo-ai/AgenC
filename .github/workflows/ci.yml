name: CI

on:
  push:
  pull_request:

jobs:
  rust_checks:
    runs-on: ubuntu-latest
    env:
      # Your repo currently sets -D warnings somewhere (likely .cargo/config.toml).
      # CI should not fail on warnings while the codebase is still being cleaned up.
      RUSTFLAGS: "-Awarnings"
      # Anchor's IDL-build safety checks can panic if this is missing.
      ANCHOR_IDL_BUILD_PROGRAM_PATH: "${{ github.workspace }}/programs/agenc-coordination"
    steps:
      - uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: cargo fmt (program)
        run: cargo fmt --manifest-path programs/agenc-coordination/Cargo.toml --all -- --check

      - name: cargo clippy (program)
        run: cargo clippy --manifest-path programs/agenc-coordination/Cargo.toml --all-targets

      - name: cargo test (program)
        run: cargo test --manifest-path programs/agenc-coordination/Cargo.toml

  anchor_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure Anchor.toml exists (case-sensitive runners)
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f anchor.toml ] && [ ! -f Anchor.toml ]; then
            cp anchor.toml Anchor.toml
          fi
          test -f Anchor.toml

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install Solana CLI
        run: |
          set -e
          version="1.18.26"
          sh -c "$(curl -sSfL https://release.solana.com/v${version}/install)"
          echo "$HOME/.local/share/solana/install/active_release/bin" >> $GITHUB_PATH

      - name: Verify Solana installation
        run: solana --version

      - name: Install Anchor
        shell: bash
        run: |
          set -euxo pipefail
          ANCHOR_VERSION="0.30.1"

          # Install AVM
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force

          # Remove any existing anchor binaries so avm/cargo installs don't collide
          rm -f ~/.cargo/bin/anchor || true
          rm -f ~/.avm/bin/anchor || true
          cargo uninstall anchor-cli || true

          # Prefer AVM, but fall back to cargo install if AVM install fails
          if avm install "${ANCHOR_VERSION}" --force; then
            avm use "${ANCHOR_VERSION}"
          else
            echo "AVM install failed; falling back to cargo install anchor-cli v${ANCHOR_VERSION}"
            cargo install --git https://github.com/coral-xyz/anchor --tag "v${ANCHOR_VERSION}" anchor-cli --locked --force
          fi

          anchor --version

      - name: Install JS deps
        run: npm ci

      - name: anchor test
        run: anchor test
        working-directory: programs/agenc-coordination

  security_scans:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install stable toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked --force

      # Solana currently pulls in ouroboros via runtime/test deps; ignore this advisory in CI.
      # Keep failing CI for other advisories.
      - name: cargo audit (program lockfile)
        run: cargo audit --deny warnings --ignore RUSTSEC-2023-0042 -f programs/agenc-coordination/Cargo.lock

      - name: Install cargo-deny (if deny.toml exists)
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f deny.toml ]; then
            cargo install cargo-deny --locked --force
          else
            echo "deny.toml not found; skipping cargo-deny"
          fi

      - name: cargo-deny
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f deny.toml ]; then
            cargo deny --manifest-path programs/agenc-coordination/Cargo.toml check
          fi
