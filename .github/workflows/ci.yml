name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SOLANA_VERSION: v1.18.26
  ANCHOR_VERSION: 0.30.1

jobs:
  rust_checks:
    runs-on: ubuntu-latest
    env:
      # Repo currently has warnings and some Anchor derive cfg quirks on new Rust; don't fail CI on warnings.
      RUSTFLAGS: "-Awarnings"
      # Anchor macro safety checks want a program path in CI builds (especially when idl-build is involved).
      ANCHOR_IDL_BUILD_PROGRAM_PATH: programs/agenc-coordination
    defaults:
      run:
        working-directory: programs/agenc-coordination
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
        with:
          workspaces: |
            programs/agenc-coordination -> target

      - name: cargo fmt (program)
        run: cargo fmt --all -- --check

      # IMPORTANT:
      # - No --all-features (enables idl-build and can panic Anchor macros)
      # - No -D warnings (repo has warnings today; donâ€™t brick CI on them)
      - name: cargo clippy (program)
        run: cargo clippy --all-targets

      - name: cargo test (program)
        run: cargo test

  anchor_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Anchor CLI v0.30.1 depends on crates that fail to build on newer Rust;
      # pin to a compatible toolchain for the Anchor install step.
      - name: Install Rust (pinned for Anchor)
        uses: dtolnay/rust-toolchain@1.79.0

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install Solana CLI
        shell: bash
        run: |
          set -euxo pipefail
          sh -c "$(curl -sSfL https://release.anza.xyz/${SOLANA_VERSION}/install)"

          # Make it available immediately in this step:
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"

          # And persist for later steps:
          echo "$HOME/.local/share/solana/install/active_release/bin" >> "$GITHUB_PATH"

          solana --version

      - name: Install Anchor (avm)
        shell: bash
        run: |
          set -euxo pipefail

          # Install AVM and ensure cargo bin dir is on PATH for this step.
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

          # Ensure a clean slate so AVM doesn't fail with "binary anchor already exists".
          rm -f "$HOME/.cargo/bin/anchor" "$HOME/.avm/bin/anchor" || true
          cargo uninstall anchor-cli || true

          avm install "${ANCHOR_VERSION}" --force
          avm use "${ANCHOR_VERSION}"

          # Persist Anchor for subsequent steps.
          echo "$HOME/.avm/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.avm/bin:$PATH"

          anchor --version

      - name: Install JS deps
        run: npm ci

      - name: anchor test
        working-directory: programs/agenc-coordination
        run: anchor test

  security_scans:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked --force

      # Solana 1.18.x currently pulls in these advisories via transitive deps; ignore so PRs can merge.
      - name: cargo audit (program lockfile)
        run: |
          cargo audit             --deny warnings             --ignore RUSTSEC-2021-0145             --ignore RUSTSEC-2023-0033             --ignore RUSTSEC-2023-0042             -f programs/agenc-coordination/Cargo.lock

      - name: Install cargo-deny (if deny.toml exists)
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f deny.toml ]; then
            cargo install cargo-deny --locked --force
          else
            echo "deny.toml not found; skipping cargo-deny"
          fi

      - name: cargo-deny
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f deny.toml ]; then
            cargo deny --manifest-path programs/agenc-coordination/Cargo.toml check
          fi
