name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

concurrency:
  group: ci-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  SOLANA_VERSION: v1.18.26
  ANCHOR_VERSION: 0.30.1

jobs:
  rust_checks:
    runs-on: ubuntu-latest
    env:
      # Repo currently has warnings and some Anchor derive cfg quirks on new Rust; don't fail CI on warnings.
      RUSTFLAGS: "-Awarnings"
      # Anchor macro safety checks want a program path in CI builds (especially when idl-build is involved).
      ANCHOR_IDL_BUILD_PROGRAM_PATH: programs/agenc-coordination
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: cargo fmt (program)
        working-directory: programs/agenc-coordination
        run: cargo fmt --all -- --check

      # IMPORTANT:
      # - No --all-features (enables idl-build and can panic Anchor macros)
      # - No -D warnings (repo has warnings today; donâ€™t brick CI on them)
      - name: cargo clippy (program)
        working-directory: programs/agenc-coordination
        run: cargo clippy --all-targets

      - name: cargo test (program)
        working-directory: programs/agenc-coordination
        run: cargo test

  anchor_tests:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      # Use modern Rust here so AVM builds (AVM now requires newer rustc).
      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install Solana CLI
        shell: bash
        run: |
          set -euxo pipefail
          sh -c "$(curl -sSfL https://release.anza.xyz/${SOLANA_VERSION}/install)"

          # Persist for later steps
          echo "$HOME/.local/share/solana/install/active_release/bin" >> "$GITHUB_PATH"

          # Verify in this step
          export PATH="$HOME/.local/share/solana/install/active_release/bin:$PATH"
          solana --version

      - name: Install Anchor via AVM
        shell: bash
        run: |
          set -euxo pipefail

          # Install AVM
          cargo install --git https://github.com/coral-xyz/anchor avm --locked --force

          # Make cargo bins available now + later
          export PATH="$HOME/.cargo/bin:$PATH"
          echo "$HOME/.cargo/bin" >> "$GITHUB_PATH"

          # Clean slate so installs don't collide
          rm -f "$HOME/.cargo/bin/anchor" "$HOME/.avm/bin/anchor" || true
          cargo uninstall anchor-cli || true

          # Install & select Anchor (downloaded by AVM)
          avm install "${ANCHOR_VERSION}" --force
          avm use "${ANCHOR_VERSION}"

          # Make anchor available for later steps
          echo "$HOME/.avm/bin" >> "$GITHUB_PATH"
          export PATH="$HOME/.avm/bin:$PATH"

          anchor --version

      - name: Install JS deps
        run: npm ci

      - name: anchor test
        working-directory: programs/agenc-coordination
        run: anchor test

  security_scans:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust (stable)
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Install cargo-audit
        run: cargo install cargo-audit --locked --force

      # Solana 1.18.x pulls in several RustSec advisories via transitive deps.
      # Ignore in CI so PRs can merge; address by bumping Solana/Anchor in a dedicated PR later.
      - name: cargo audit (program lockfile)
        run: |
          cargo audit             --deny warnings             --ignore RUSTSEC-2021-0145             --ignore RUSTSEC-2023-0033             --ignore RUSTSEC-2023-0042             --ignore RUSTSEC-2024-0370             -f programs/agenc-coordination/Cargo.lock

      - name: Install cargo-deny (if deny.toml exists)
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f deny.toml ]; then
            cargo install cargo-deny --locked --force
          else
            echo "deny.toml not found; skipping cargo-deny"
          fi

      - name: cargo-deny
        shell: bash
        run: |
          set -euxo pipefail
          if [ -f deny.toml ]; then
            cargo deny --manifest-path programs/agenc-coordination/Cargo.toml check
          fi
